<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dinner Party Planner ‚Äî Voice Training</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Montserrat:wght@400;600&display=swap">
  <style>
    :root{ --navy:#1E3A5F; --gold:#C9A227; --cream:#FDF8F3; --text:#111827; --muted:#6b7280; }
    body{ margin:0; font-family: Georgia, serif; background: linear-gradient(180deg,#fff 0%, var(--cream) 60%); color:var(--text); }
    .wrap{ width:min(980px, calc(100vw - 2rem)); margin:0 auto; padding: 1.25rem 0 2.5rem; }
    .top{ display:flex; justify-content:space-between; align-items:center; gap:1rem; padding: 1rem 0; }
    .brand{ display:flex; align-items:center; gap:0.85rem; }
    .brand .icon{ width:40px; height:40px; border-radius: 12px; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg, rgba(30,58,95,0.10) 0%, rgba(201,162,39,0.16) 100%); border:1px solid rgba(17,24,39,0.10); }
    .brand h1{ margin:0; font-family:'Playfair Display', serif; font-size:1.1rem; color:var(--navy); }
    .pill{ padding:0.25rem 0.6rem; border-radius:999px; background: rgba(30,58,95,0.08); border:1px solid rgba(30,58,95,0.14);
      font-size:0.78rem; font-weight:800; letter-spacing:0.08em; text-transform:uppercase; color:var(--navy); }
    .card{ background: rgba(255,255,255,0.95); border:1px solid rgba(17,24,39,0.10); border-radius:16px; padding: 1.5rem; box-shadow: 0 14px 38px rgba(0,0,0,0.08); margin: 0 0 1rem; }
    .title{ font-family:'Playfair Display', serif; font-size:1.6rem; margin:0 0 0.35rem; color:var(--navy); }
    .sub{ margin:0 0 1rem; color: var(--muted); line-height:1.55; }
    label{ display:block; font-weight:800; margin: 0 0 0.35rem; }
    input, select{ width:100%; padding:0.85rem 0.95rem; border-radius:12px; border:1px solid rgba(17,24,39,0.14); font: inherit; background: #fff; }
    .row{ display:grid; grid-template-columns: 1fr 2fr; gap: 0.85rem; }
    .btn{ appearance:none; border:none; border-radius: 999px; padding: 0.8rem 1rem; font-weight:900; cursor:pointer; }
    .btn-primary{ background: linear-gradient(135deg, var(--navy) 0%, #152b46 100%); color:#fff; }
    .btn-green{ background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); color:#fff; }
    .btn-outline{ background: transparent; border: 2px solid rgba(17,24,39,0.14); color: rgba(17,24,39,0.82); }
    .call{ display:flex; align-items:center; justify-content:space-between; gap: 1rem; flex-wrap: wrap; }
    .call-left{ display:flex; align-items:center; gap: 0.9rem; }
    .phone{ width:56px; height:56px; border-radius:16px; display:flex; align-items:center; justify-content:center; position:relative;
      background: linear-gradient(135deg, rgba(30,58,95,0.14) 0%, rgba(201,162,39,0.16) 100%); border:1px solid rgba(17,24,39,0.10); }
    .phone::after{ content:''; position:absolute; inset:-10px; border-radius: 22px; border:2px solid rgba(201,162,39,0.28); opacity:0; animation: ring 1.6s ease-in-out infinite; }
    @keyframes ring{ 0%{opacity:0;transform:scale(0.95)} 12%{opacity:0.65;transform:scale(1)} 28%{opacity:0;transform:scale(1.06)} 100%{opacity:0;transform:scale(1.06)} }
    .meta .h{ font-weight:900; }
    .meta .p{ color: var(--muted); margin-top: 0.15rem; }
    .toast{ position: fixed; right: 16px; bottom: 16px; background: rgba(17,24,39,0.92); color:#fff; padding: 12px 14px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.12); max-width:min(520px, calc(100vw - 32px)); display:none; }
    .chat{ margin-top: 0.75rem; padding: 0.95rem; border-radius: 14px; background: rgba(30,58,95,0.06); border:1px solid rgba(30,58,95,0.12); }
    .chat .line{ margin: 0.35rem 0; }
    .chat .who{ font-weight:900; color: var(--navy); }
    .muted{ color: var(--muted); }
    @media (max-width: 720px){ .row{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="icon">üìû</div>
        <div>
          <h1>Voice Training</h1>
          <div class="muted" style="font-size:0.9rem">Practice hands‚Äëfree before beta</div>
        </div>
      </div>
      <span class="pill">Beta prep</span>
    </div>

    <div class="card">
      <div class="title">Set your identity</div>
      <p class="sub">This training page helps you practice the ‚ÄúAnswer call ‚Üí wake phrase ‚Üí speak ‚Üí pause‚Äù flow.</p>
      <div class="row">
        <div>
          <label for="hon">Title</label>
          <select id="hon">
            <option value="Mr.">Mr.</option>
            <option value="Mrs.">Mrs.</option>
            <option value="Ms.">Ms.</option>
          </select>
        </div>
        <div>
          <label for="name">Your name</label>
          <input id="name" placeholder="e.g., Alex Johnson" autocomplete="name" />
        </div>
      </div>
      <div style="margin-top:0.85rem">
        <label for="code">Beta code (optional)</label>
        <input id="code" placeholder="e.g., BETA001" />
      </div>
      <div style="margin-top:0.6rem;color:var(--muted)">
        We‚Äôll address you as <strong id="preview">Mr. ‚Äî</strong>.
      </div>
    </div>

    <div class="card">
      <div class="call">
        <div class="call-left">
          <div class="phone">üì±</div>
          <div class="meta">
            <div class="h">Incoming call: The Planner</div>
            <div class="p">Answer to start hands‚Äëfree. Say: <strong>‚ÄúPlanner ‚Ä¶‚Äù</strong></div>
          </div>
        </div>
        <div style="display:flex;gap:0.6rem;align-items:center">
          <button class="btn btn-outline" id="hang" disabled>Hang up</button>
          <button class="btn btn-green" id="answer">Answer</button>
        </div>
      </div>
      <div class="chat" id="chat">
        <div class="line"><span class="who">Tip:</span> <span class="muted">Start with ‚ÄúPlanner ‚Ä¶‚Äù so the app knows to send.</span></div>
      </div>
      <div style="margin-top:0.9rem;display:flex;gap:0.6rem;flex-wrap:wrap">
        <button class="btn btn-primary" id="goBeta">Open main beta app</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const toast = (m, ms=2400) => {
      const t = document.getElementById('toast');
      t.textContent = m;
      t.style.display = 'block';
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>t.style.display='none', ms);
    };

    const surname = (n) => {
      const s = String(n||'').trim();
      if (!s) return '';
      if (s.includes(',')) return s.split(',')[0].trim().split(/\s+/).pop() || '';
      return s.split(/\s+/).pop() || '';
    };

    const preview = () => {
      const h = document.getElementById('hon').value;
      const n = document.getElementById('name').value;
      document.getElementById('preview').textContent = `${h} ${surname(n) || '‚Äî'}`;
    };
    document.getElementById('hon').addEventListener('change', preview);
    document.getElementById('name').addEventListener('input', preview);
    preview();

    // Minimal audio unlock + ring
    let ctx = null;
    const unlock = async () => {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return;
      if (!ctx) ctx = new AudioCtx();
      if (ctx.state !== 'running') await ctx.resume().catch(()=>{});
    };
    const ring = async () => {
      if (!ctx) return;
      const ringOnce = (startAt) => {
        const o1 = ctx.createOscillator();
        const o2 = ctx.createOscillator();
        const g = ctx.createGain();
        g.gain.value = 0.0001;
        o1.type='sine'; o2.type='sine';
        o1.frequency.value = 440; o2.frequency.value = 660;
        o1.connect(g); o2.connect(g); g.connect(ctx.destination);
        const dur = 0.52;
        g.gain.setValueAtTime(0.0001, startAt);
        g.gain.linearRampToValueAtTime(0.22, startAt + 0.03);
        g.gain.linearRampToValueAtTime(0.0001, startAt + dur);
        o1.start(startAt); o2.start(startAt);
        o1.stop(startAt + dur + 0.02); o2.stop(startAt + dur + 0.02);
      };
      const t0 = ctx.currentTime + 0.03;
      ringOnce(t0); ringOnce(t0 + 0.78);
    };

    // SpeechRecognition training: listen ‚Üí require wake phrase ‚Üí echo
    let rec = null;
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const chat = (who, msg) => {
      const el = document.getElementById('chat');
      const d = document.createElement('div');
      d.className = 'line';
      d.innerHTML = `<span class="who">${who}:</span> ${msg}`;
      el.appendChild(d);
      el.scrollTop = el.scrollHeight;
    };

    const speak = async (text) => {
      await unlock();
      const body = { voice: "planner", text };
      const res = await fetch('/api/tts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (!res.ok) return toast('ElevenLabs failed. Check your voice IDs and redeploy.', 3500);
      const ab = await res.arrayBuffer();
      const buf = await new Promise((resolve, reject) => {
        const p = ctx.decodeAudioData(ab.slice(0), resolve, reject);
        if (p && typeof p.then === 'function') p.then(resolve).catch(reject);
      });
      const src = ctx.createBufferSource();
      src.buffer = buf;
      src.connect(ctx.destination);
      src.start(0);
    };

    const startListening = () => {
      if (!SR) return toast('Speech recognition not supported in this browser.', 4200);
      rec = new SR();
      rec.continuous = false;
      rec.interimResults = false;
      rec.lang = 'en-US';
      rec.onresult = (e) => {
        const t = (e.results?.[0]?.[0]?.transcript || '').trim();
        if (!t) return;
        chat('You', t);
        const low = t.toLowerCase();
        if (!low.startsWith('planner')) {
          speak('Start with ‚ÄúPlanner ‚Ä¶‚Äù then your request. Try again.').catch(()=>{});
          setTimeout(()=>{ try{ rec.start(); }catch{} }, 350);
          return;
        }
        const cleaned = t.replace(/^planner[:,\\-‚Äî‚Äì]*\\s*/i, '').trim();
        speak(`I heard: ${cleaned || 'your request'}. Great. Now ask me one more thing, starting with ‚ÄúPlanner ‚Ä¶‚Äù.`).catch(()=>{});
        setTimeout(()=>{ try{ rec.start(); }catch{} }, 700);
      };
      rec.onend = () => {};
      try { rec.start(); } catch {}
    };

    document.getElementById('answer').addEventListener('click', async () => {
      const hon = document.getElementById('hon').value;
      const n = document.getElementById('name').value.trim();
      if (!n || !surname(n)) return toast('Please enter your name (so we can address you properly).', 2600);
      localStorage.setItem('dpp_hostHonorific', hon);
      localStorage.setItem('dpp_hostFullName', n);
      localStorage.setItem('dpp_hostSurname', surname(n));
      const code = document.getElementById('code').value.trim();
      if (code) sessionStorage.setItem('dpp_accessCode', code);

      await unlock();
      await ring();
      const addr = `${hon} ${surname(n)}`;
      chat('Planner', `Good evening ${addr}. I‚Äôm your Event Planner. How can I be of service? (Say ‚ÄúPlanner ‚Ä¶‚Äù)`);
      await speak(`Good evening ${addr}. I‚Äôm your Event Planner. How can I be of service?`).catch(()=>{});
      document.getElementById('answer').disabled = true;
      document.getElementById('hang').disabled = false;
      startListening();
    });

    document.getElementById('hang').addEventListener('click', () => {
      try { rec?.stop?.(); } catch {}
      document.getElementById('hang').disabled = true;
      document.getElementById('answer').disabled = false;
      toast('Call ended.');
    });

    document.getElementById('goBeta').addEventListener('click', () => {
      const hon = encodeURIComponent(document.getElementById('hon').value);
      const n = encodeURIComponent(document.getElementById('name').value.trim());
      const c = encodeURIComponent(document.getElementById('code').value.trim());
      const qs = `?honorific=${hon}&name=${n}${c ? `&code=${c}` : ''}`;
      window.location.href = '/' + qs;
    });
  </script>
</body>
</html>

