<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dinner Party Planner</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Montserrat:wght@400;600&family=Cormorant+Garamond:wght@400;600&family=Cinzel:wght@400;600&family=Libre+Baskerville:wght@400;700&family=Great+Vibes&display=swap">
  <style>
:root{
  --navy:#1E3A5F; --navy-dark:#152b46;
  --navy-light:#2B5B93;
  --gold:#C9A227; --gold-light:#D4B03A; --gold-dark:#8b6c18;
  --cream:#FDF8F3; --cream-dark:#EFE6DD;
  --text:#1f2937; --text-light:#6b7280;
  --success:#16a34a; --success-light:#dcfce7;
  --error:#dc2626; --error-light:#fee2e2;
}
*{box-sizing:border-box;}
html,body{height:100%;}
body{
  margin:0;
  font-family: Georgia, serif;
  background:
    radial-gradient(1200px 600px at 20% 0%, rgba(201,162,39,0.10), transparent 55%),
    radial-gradient(900px 520px at 95% 10%, rgba(30,58,95,0.12), transparent 52%),
    linear-gradient(180deg, #ffffff 0%, var(--cream) 55%, var(--cream) 100%);
  color:var(--text);
}

/* ===== BASE LAYOUT ===== */
.container{
  width: min(1100px, calc(100vw - 2.25rem));
  margin: 0 auto;
  padding: 1.25rem 0 3rem;
}

/* ===== STEP "SCREEN" FRAME ===== */
section[id^="step"]{
  border: 2px solid rgba(30,58,95,0.18);
  border-radius: 18px;
  background: rgba(255,255,255,0.70);
  box-shadow: 0 16px 44px rgba(0,0,0,0.07);
  padding: 1.25rem;
  margin: 0.75rem 0 1.5rem;
}
section[id^="step"] .card{
  background: rgba(255,255,255,0.94);
}

/* ===== TOP BAR ===== */
.topbar{
  position: sticky;
  top: 0;
  z-index: 50;
  background: rgba(255,255,255,0.86);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(17,24,39,0.06);
}
.topbar-inner{
  width: min(1100px, calc(100vw - 2.25rem));
  margin: 0 auto;
  padding: 0.85rem 0;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 1rem;
}
.brand{display:flex;align-items:center;gap:0.85rem;min-width:0;}
.brand-icon{
  width: 40px; height: 40px;
  display:flex;align-items:center;justify-content:center;
  border-radius: 12px;
  background: linear-gradient(135deg, rgba(30,58,95,0.10) 0%, rgba(201,162,39,0.14) 100%);
  border: 1px solid rgba(17,24,39,0.08);
  font-size: 1.25rem;
}
.brand-title{
  font-family: 'Playfair Display', serif;
  font-weight: 600;
  letter-spacing: 0.01em;
  color: var(--navy);
  line-height: 1.1;
  font-size: 1.05rem;
}
.brand-tagline{
  font-size: 0.88rem;
  color: var(--text-light);
  line-height: 1.25;
}
.beta-pill{
  display:inline-flex;
  align-items:center;
  padding: 0.25rem 0.6rem;
  border-radius: 999px;
  font-size: 0.78rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--navy);
  background: rgba(30,58,95,0.08);
  border: 1px solid rgba(30,58,95,0.14);
}

/* ===== PROGRESS ===== */
.progress{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 0.55rem;
  padding: 0.8rem 0 1.25rem;
}
.progress-step{
  width: 36px; height: 36px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--text-light);
  background: rgba(255,255,255,0.9);
  border: 1px solid rgba(17,24,39,0.10);
  cursor: pointer;
  transition: all 0.2s ease;
  user-select:none;
}
.progress-step:hover{ border-color: rgba(30,58,95,0.25); color: var(--navy); }
.progress-step.active{
  color: white;
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
  border-color: rgba(30,58,95,0.35);
  box-shadow: 0 8px 18px rgba(30,58,95,0.20);
}
.progress-step.complete{
  color: var(--navy);
  background: rgba(30,58,95,0.08);
  border-color: rgba(30,58,95,0.18);
}
.progress-line{
  width: 26px; height: 2px;
  background: rgba(17,24,39,0.12);
  border-radius: 999px;
}
.progress-line.complete{
  background: rgba(30,58,95,0.35);
}

/* ===== IN-STEP NAV (MAJOR POINTS) ===== */
.section-nav{
  position: sticky;
  top: 74px; /* below topbar */
  z-index: 40;
  display:flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items:center;
  justify-content: center;
  padding: 0.75rem 0.8rem;
  margin: 0.3rem 0 0.85rem;
  border-radius: 14px;
  background: rgba(255,255,255,0.88);
  border: 1px solid rgba(17,24,39,0.10);
  backdrop-filter: blur(8px);
}
.section-nav.hidden{ display:none !important; }
.section-nav .label{
  font-size: 0.78rem;
  font-weight: 800;
  letter-spacing: 0.10em;
  text-transform: uppercase;
  color: rgba(17,24,39,0.55);
  margin-right: 0.25rem;
}
.section-nav-btn{
  appearance:none;
  border: 1px solid rgba(17,24,39,0.12);
  background: rgba(255,255,255,0.92);
  color: rgba(17,24,39,0.78);
  padding: 0.5rem 0.75rem;
  border-radius: 999px;
  font: inherit;
  font-weight: 800;
  font-size: 0.88rem;
  cursor: pointer;
  transition: all 0.18s ease;
}
.section-nav-btn:hover{
  border-color: rgba(30,58,95,0.25);
  color: var(--navy);
}
.section-nav-btn.active{
  border-color: rgba(30,58,95,0.35);
  background: rgba(30,58,95,0.08);
  color: var(--navy);
}
[data-screen]{ scroll-margin-top: 120px; }

/* ===== CARDS + FORMS ===== */
.card{
  background: rgba(255,255,255,0.92);
  border: 1px solid rgba(17,24,39,0.10);
  border-radius: 16px;
  padding: 2rem;
  box-shadow: 0 12px 30px rgba(0,0,0,0.06);
  margin: 0 0 1.25rem 0;
}
.card-title{
  font-family: 'Playfair Display', serif;
  font-size: 1.6rem;
  margin: 0 0 0.45rem;
  color: var(--navy);
}
.card-subtitle{
  margin: 0 0 1.25rem;
  color: var(--text-light);
  line-height: 1.55;
  font-size: 1.02rem;
}
.form-row{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
.form-group{ margin: 0 0 1rem; }
label{
  display:block;
  font-weight: 700;
  margin: 0 0 0.45rem;
  color: rgba(17,24,39,0.88);
}
input[type="text"], input[type="date"], textarea, select{
  width: 100%;
  padding: 0.9rem 1rem;
  border-radius: 12px;
  border: 1px solid rgba(17,24,39,0.14);
  background: rgba(255,255,255,0.95);
  font: inherit;
  outline: none;
  transition: box-shadow 0.2s ease, border-color 0.2s ease;
}
textarea{ resize: vertical; }
input[type="text"]:focus, input[type="date"]:focus, textarea:focus, select:focus{
  border-color: rgba(30,58,95,0.45);
  box-shadow: 0 0 0 4px rgba(30,58,95,0.10);
}

/* ===== CHIPS ===== */
.chip-group{ display:flex; flex-wrap: wrap; gap: 0.55rem; margin-top: 0.75rem; }
.chip{
  display:inline-flex;
  align-items:center;
  gap: 0.45rem;
  padding: 0.55rem 0.85rem;
  border-radius: 999px;
  border: 1px solid rgba(17,24,39,0.12);
  background: rgba(255,255,255,0.92);
  color: rgba(17,24,39,0.80);
  font-weight: 700;
  font-size: 0.9rem;
  cursor: pointer;
  user-select: none;
  transition: all 0.18s ease;
}
.chip:hover{ border-color: rgba(30,58,95,0.25); color: var(--navy); }
.chip.selected{
  border-color: rgba(30,58,95,0.35);
  background: rgba(30,58,95,0.08);
  color: var(--navy);
}

/* ===== STEP 1 HERO ===== */
#step1{ padding-bottom: 0.5rem; }
.step1-hero{
  display:grid;
  grid-template-columns: 1.1fr 0.9fr;
  gap: 1.25rem;
  align-items: start;
  margin-top: 0.25rem;
}
.hero-panel{
  border-radius: 18px;
  padding: 2.25rem;
  background:
    radial-gradient(700px 380px at 15% 10%, rgba(201,162,39,0.18), transparent 60%),
    radial-gradient(640px 360px at 95% 30%, rgba(30,58,95,0.18), transparent 58%),
    linear-gradient(180deg, rgba(255,255,255,0.96) 0%, rgba(255,255,255,0.86) 100%);
  border: 1px solid rgba(17,24,39,0.10);
  box-shadow: 0 18px 50px rgba(0,0,0,0.08);
  overflow: hidden;
  position: relative;
}
.hero-kicker{
  display:inline-flex;
  align-items:center;
  gap: 0.5rem;
  font-weight: 800;
  letter-spacing: 0.10em;
  text-transform: uppercase;
  font-size: 0.78rem;
  color: rgba(30,58,95,0.85);
  margin-bottom: 0.75rem;
}
.hero-title{
  font-family: 'Playfair Display', serif;
  font-size: clamp(2.1rem, 3.4vw, 3rem);
  line-height: 1.06;
  color: var(--navy);
  margin: 0 0 0.75rem;
}
.hero-lede{
  font-size: 1.08rem;
  line-height: 1.65;
  color: rgba(17,24,39,0.74);
  margin: 0 0 1.25rem;
}
.hero-points{
  display:grid;
  grid-template-columns: 1fr;
  gap: 0.75rem;
  margin-top: 0.25rem;
}
.hero-point{
  display:flex;
  gap: 0.75rem;
  align-items:flex-start;
  padding: 0.85rem 0.95rem;
  border-radius: 14px;
  background: rgba(255,255,255,0.72);
  border: 1px solid rgba(17,24,39,0.08);
}
.hero-point .dot{
  width: 12px; height: 12px; border-radius: 999px;
  background: var(--gold);
  box-shadow: 0 0 0 4px rgba(201,162,39,0.16);
  margin-top: 0.25rem;
  flex: 0 0 auto;
}
.hero-point .text{ color: rgba(17,24,39,0.78); line-height: 1.5; }
.hero-point .text strong{ color: rgba(17,24,39,0.92); }
.hero-mini{
  display:flex;
  flex-wrap: wrap;
  gap: 0.55rem;
  margin-top: 1.15rem;
}
.mini-pill{
  display:inline-flex;
  align-items:center;
  padding: 0.4rem 0.7rem;
  border-radius: 999px;
  font-size: 0.85rem;
  font-weight: 700;
  color: rgba(17,24,39,0.72);
  border: 1px solid rgba(17,24,39,0.10);
  background: rgba(255,255,255,0.75);
}
.hero-entry{ display:flex; flex-direction: column; gap: 1rem; }
.entry-card{ margin: 0; }
.drawer{
  padding: 0;
  overflow: hidden;
}
.drawer > summary{
  list-style: none;
  cursor: pointer;
  padding: 1.25rem 1.35rem;
  border-bottom: 1px solid rgba(17,24,39,0.08);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 1rem;
}
.drawer > summary::-webkit-details-marker{ display:none; }
.drawer > summary .sum-title{
  font-family: 'Playfair Display', serif;
  font-size: 1.25rem;
  color: var(--navy);
}
.drawer > summary .sum-hint{
  color: var(--text-light);
  font-size: 0.92rem;
}
.drawer[open] > summary{ background: rgba(30,58,95,0.04); }
.drawer-body{ padding: 1.25rem 1.35rem 1.35rem; }

    /* ===== INSPIRATION CARDS ===== */
    .inspiration-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1.25rem;
    }
    .inspiration-card {
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 1.25rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.25s;
    }
    .inspiration-card:hover {
      border-color: var(--gold);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(201,162,39,0.15);
    }
    .inspiration-card.selected {
      border-color: var(--navy);
      background: rgba(30,58,95,0.06);
    }
    .inspiration-card .icon { font-size: 2rem; margin-bottom: 0.6rem; }
    .inspiration-card .title {
      font-weight: 600; font-size: 0.9rem;
      color: var(--navy);
      margin-bottom: 0.35rem;
      font-family: 'Playfair Display', serif;
    }
    .inspiration-card .desc {
      font-size: 0.8rem;
      color: var(--text-light);
      line-height: 1.4;
    }
    
    /* ===== STYLE CARDS ===== */
    .style-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .style-layout {
      display: grid;
      grid-template-columns: 1fr 1.15fr;
      gap: 1.25rem;
      margin-top: 1rem;
      align-items: start;
    }
    .style-panel {
      background: var(--cream);
      border: 1px solid var(--cream-dark);
      border-radius: 14px;
      padding: 1rem;
    }
    .style-panel h4 {
      font-size: 0.8rem;
      color: var(--text-light);
      margin: 0 0 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
    }
    .style-preview {
      background: white;
      border: 2px solid var(--cream-dark);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    .style-preview-header {
      padding: 0.9rem 1.1rem;
      border-bottom: 1px solid var(--cream-dark);
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 1rem;
    }
    .style-preview-header .label {
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-light);
      font-weight: 700;
    }
    .style-preview-header .hint {
      font-size: 0.85rem;
      color: var(--text-light);
      font-style: italic;
      text-align: right;
    }
    .menu-card-preview {
      padding: 1.6rem 1.5rem;
      min-height: 420px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .menu-card-preview .preview-title {
      font-size: 1.9rem;
      color: var(--navy);
      line-height: 1.1;
    }
    .menu-card-preview .preview-meta {
      font-size: 0.95rem;
      color: var(--text-light);
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .menu-card-preview .preview-divider {
      height: 1px;
      background: rgba(17,24,39,0.10);
      margin: 0.6rem 0 0.2rem;
    }
    .menu-card-preview .preview-course {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 0.75rem;
      padding: 0.35rem 0;
      align-items: baseline;
    }
    .menu-card-preview .preview-course-type {
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--gold);
      font-weight: 700;
    }
    .menu-card-preview .preview-course-name {
      font-size: 1.02rem;
      color: var(--text);
    }
    .menu-card-preview .preview-footer {
      margin-top: auto;
      font-size: 0.85rem;
      color: var(--text-light);
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .style-card {
      background: white;
      border: 2px solid var(--cream-dark);
      border-radius: 12px;
      padding: 1.125rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .style-card:hover { border-color: var(--gold); }
    .style-card.selected {
      border-color: var(--navy);
      background: rgba(30,58,95,0.03);
    }
    .style-card .name {
      font-weight: 600; font-size: 0.95rem;
      color: var(--navy);
      margin-bottom: 0.3rem;
      font-family: 'Playfair Display', serif;
    }
    .style-card .desc {
      font-size: 0.85rem;
      color: var(--text-light);
    }
    
    /* ===== CUISINE CASCADING ===== */
    .cuisine-section {
      margin-top: 1.25rem;
      padding: 1.25rem;
      background: var(--cream);
      border-radius: 12px;
      border: 1px solid var(--cream-dark);
    }
    .cuisine-section h4 {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-bottom: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
    }
    
    /* ===== EXPERT CARDS ===== */
    .expert-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
      margin-top: 1.25rem;
    }
    .expert-card {
      background: white;
      border: 2px solid var(--cream-dark);
      border-radius: 14px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.25s;
      text-align: center;
    }
    .expert-card:hover {
      border-color: var(--gold);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    }
    .expert-card.selected {
      border-color: var(--navy);
      background: linear-gradient(180deg, rgba(30,58,95,0.04) 0%, rgba(201,162,39,0.04) 100%);
    }
    .expert-card .icon { font-size: 2.75rem; margin-bottom: 0.875rem; }
    .expert-card .name {
      font-family: 'Playfair Display', serif;
      font-size: 1.2rem; font-weight: 600;
      color: var(--navy);
      margin-bottom: 0.35rem;
    }
    .expert-card .credentials {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 0.6rem;
      line-height: 1.4;
    }
    .expert-card .philosophy {
      font-size: 0.9rem;
      font-style: italic;
      color: var(--gold-dark);
    }
    
    /* ===== CHAT ===== */
    .chat-container {
      background: white;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-top: 1.5rem;
    }
    .chat-header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
      color: white;
      padding: 1.125rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.875rem;
    }
    .chat-header .spacer { margin-left: auto; }
    .chat-controls { display:flex; gap:0.6rem; align-items:center; }
    .chat-controls label { display:flex; gap:0.4rem; align-items:center; font-size:0.85rem; opacity:0.95; }
    .chat-controls input[type="checkbox"] { transform: translateY(1px); }
    .status-pill {
      display:inline-flex;
      align-items:center;
      gap:0.45rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.20);
      background: rgba(255,255,255,0.10);
      font-size: 0.82rem;
      line-height: 1;
      white-space: nowrap;
    }
    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.35);
    }
    .status-dot.listening { background: #22c55e; }
    .status-dot.thinking { background: #f59e0b; }
    .status-dot.speaking { background: #60a5fa; }
    .status-dot.off { background: rgba(255,255,255,0.25); }
    .mic-banner {
      background: rgba(201,162,39,0.15);
      border-top: 1px solid rgba(201,162,39,0.35);
      border-bottom: 1px solid rgba(201,162,39,0.35);
      color: white;
      padding: 0.55rem 1.25rem;
      font-size: 0.85rem;
    }
    .mic-banner strong { color: white; }
    .mic-status {
      display: inline-flex;
      gap: 0.5rem;
      align-items: center;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.92);
    }
    .mic-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.35);
      box-shadow: 0 0 0 0 rgba(201,162,39,0.0);
    }
    .mic-dot.on {
      background: var(--gold);
      animation: pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(201,162,39,0.55); }
      100% { box-shadow: 0 0 0 10px rgba(201,162,39,0); }
    }
    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      background: rgba(17,24,39,0.92);
      color: white;
      padding: 12px 14px;
      border-radius: 12px;
      max-width: min(520px, calc(100vw - 32px));
      font-size: 0.92rem;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }
    .toast.hidden { display:none; }
    .interim {
      padding: 0.6rem 1.25rem;
      background: rgba(255,255,255,0.08);
      border-top: 1px solid rgba(255,255,255,0.16);
      color: rgba(255,255,255,0.92);
      font-size: 0.9rem;
      font-style: italic;
    }
    .interim.hidden { display:none; }
    .chat-header .icon { font-size: 1.75rem; }
    .chat-header .name {
      font-family: 'Playfair Display', serif;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .chat-messages {
      height: 380px;
      overflow-y: auto;
      padding: 1.25rem;
      background: var(--cream);
    }
    .chat-message {
      margin-bottom: 1.125rem;
      max-width: 88%;
    }
    .chat-message.user { margin-left: auto; }
    .chat-message .bubble {
      padding: 0.875rem 1.125rem;
      border-radius: 14px;
      line-height: 1.55;
      font-size: 0.95rem;
    }
    .chat-message.assistant .bubble {
      background: white;
      border: 1px solid var(--cream-dark);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .chat-message.user .bubble {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      color: white;
    }
    .chat-input-area {
      display: flex;
      gap: 0.6rem;
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--cream-dark);
      background: white;
    }
    .chat-input-area input { flex: 1; }
    .mic-btn { padding: 0.95rem 1rem; min-width: 120px; }
    
    /* ===== MENU CARDS ===== */
    .menu-card {
      background: white;
      border: 2px solid var(--cream-dark);
      border-radius: 14px;
      padding: 1.75rem;
      margin-bottom: 1.25rem;
      cursor: pointer;
      transition: all 0.25s;
      position: relative;
    }
    .menu-card:hover {
      border-color: var(--gold);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    }
    .menu-card.selected {
      border-color: var(--navy);
      background: linear-gradient(135deg, rgba(30,58,95,0.03) 0%, rgba(201,162,39,0.03) 100%);
    }
    .menu-card.selected::after {
      content: '‚úì';
      position: absolute;
      top: 1.25rem; right: 1.25rem;
      width: 32px; height: 32px;
      background: var(--navy);
      color: white;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem;
      font-weight: bold;
    }
    .menu-card .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    .menu-card .title {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem; font-weight: 600;
      color: var(--navy);
    }
    .menu-card .cost-badge {
      background: var(--cream);
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--gold-dark);
      font-weight: 600;
    }
    .menu-card .personality {
      font-size: 0.95rem;
      font-style: italic;
      color: var(--text-light);
      margin-bottom: 1rem;
      line-height: 1.5;
    }
    .menu-card .courses {
      border-top: 1px solid var(--cream-dark);
      padding-top: 1rem;
    }
    .menu-card .course {
      display: grid;
      grid-template-columns: 120px 1fr auto;
      gap: 0.5rem;
      padding: 0.5rem 0;
      font-size: 0.95rem;
      align-items: baseline;
    }
    .menu-card .course-type {
      font-weight: 600;
      color: var(--gold-dark);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .menu-card .course-name { color: var(--text); }
    .menu-card .course-wine {
      font-size: 0.85rem;
      color: var(--gold);
      font-style: italic;
    }
    
    /* ===== STAFFING ===== */
    .staffing-option {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      padding: 1.25rem;
      border: 2px solid var(--cream-dark);
      border-radius: 12px;
      cursor: pointer;
      margin-bottom: 0.875rem;
      transition: all 0.2s;
    }
    .staffing-option:hover { border-color: var(--gold); }
    .staffing-option.selected {
      border-color: var(--navy);
      background: rgba(30,58,95,0.03);
    }
    .staffing-option .icon { font-size: 2.25rem; }
    .staffing-option .info h4 {
      font-weight: 600;
      color: var(--navy);
      margin-bottom: 0.25rem;
      font-size: 1.05rem;
    }
    .staffing-option .info p {
      font-size: 0.9rem;
      color: var(--text-light);
    }
    .staffing-option .time {
      margin-left: auto;
      text-align: right;
      font-size: 0.85rem;
      color: var(--gold-dark);
      font-weight: 600;
    }
    
    /* ===== BUTTONS ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.95rem 2rem;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.25s;
      text-decoration: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(30,58,95,0.25);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30,58,95,0.35);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      background: white;
      color: var(--navy);
      border: 2px solid var(--navy);
    }
    .btn-secondary:hover { background: var(--cream); }
    .btn-gold {
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(201,162,39,0.3);
    }
    .btn-gold:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(201,162,39,0.4);
    }
    .btn-outline {
      background: transparent;
      color: var(--text-light);
      border: 2px solid var(--cream-dark);
    }
    .btn-outline:hover {
      border-color: var(--navy);
      color: var(--navy);
    }
    .actions {
      display: flex;
      gap: 0.875rem;
      justify-content: center;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    
    /* ===== LOADING ===== */
    .loading {
      text-align: center;
      padding: 4rem 2rem;
    }
    .spinner {
      width: 50px; height: 50px;
      border: 4px solid var(--cream-dark);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.25rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading p {
      color: var(--text-light);
      font-size: 1.1rem;
      font-style: italic;
    }
    
    /* ===== MESSAGES ===== */
    .success-msg {
      background: var(--success-light);
      border: 1px solid #86efac;
      color: #166534;
      padding: 1rem 1.25rem;
      border-radius: 10px;
      margin: 1rem 0;
      font-size: 0.95rem;
    }
    .error-msg {
      background: var(--error-light);
      border: 1px solid #fca5a5;
      color: #991b1b;
      padding: 1rem 1.25rem;
      border-radius: 10px;
      margin: 1rem 0;
      font-size: 0.95rem;
    }
    
    /* ===== SECTION TITLE ===== */
    .section-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--navy);
      text-align: center;
      margin: 2rem 0 1.5rem;
    }
    
    /* ===== PRINT PRODUCTS ===== */
    .print-section {
      background: var(--cream);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1.25rem;
    }
    .print-section h4 {
      font-family: 'Playfair Display', serif;
      font-size: 1.15rem;
      color: var(--navy);
      margin-bottom: 1rem;
    }
    .avery-product {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.875rem 1rem;
      background: white;
      border-radius: 8px;
      margin-bottom: 0.6rem;
      border: 1px solid var(--cream-dark);
    }
    .avery-product .info { flex: 1; }
    .avery-product .sku {
      font-weight: 600;
      color: var(--navy);
      font-size: 0.95rem;
    }
    .avery-product .details {
      font-size: 0.85rem;
      color: var(--text-light);
    }
    .avery-product .btn {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    
    /* ===== COOKBOOK PREVIEW ===== */
    .cookbook-preview {
      background: var(--cream);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }
    .cookbook-preview h4 {
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem;
      color: var(--navy);
      margin-bottom: 1.25rem;
    }
    .cookbook-sections {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 0.6rem;
    }
    .cookbook-section {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.625rem 0.875rem;
      background: white;
      border-radius: 8px;
      font-size: 0.9rem;
      border: 1px solid var(--cream-dark);
    }
    .cookbook-section::before {
      content: '‚úì';
      color: var(--success);
      font-weight: bold;
    }
    
    /* ===== FOOTER ===== */
    footer {
      text-align: center;
      padding: 2.5rem 1rem;
      color: var(--text-light);
      font-size: 0.9rem;
      border-top: 1px solid var(--cream-dark);
      margin-top: 3rem;
      background: white;
    }
    footer a { color: var(--navy); }
    
    /* ===== UTILITIES ===== */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-2 { margin-top: 2rem; }
    
    /* ===== RESPONSIVE ===== */
    @media (max-width: 700px) {
      body { font-size: 16px; }
      .brand-title { font-size: 1rem; }
      .brand-tagline { display:none; }
      .card { padding: 1.5rem; }
      .form-row { grid-template-columns: 1fr; }
      .inspiration-grid { grid-template-columns: repeat(2, 1fr); }
      .expert-grid { grid-template-columns: 1fr; }
      .menu-card .course { grid-template-columns: 1fr; gap: 0.25rem; }
      .menu-card .course-wine { margin-left: 0; }
      .style-layout { grid-template-columns: 1fr; }
      .menu-card-preview { min-height: 360px; padding: 1.25rem; }
      .menu-card-preview .preview-course { grid-template-columns: 1fr; gap: 0.2rem; }
      .progress-step { width: 30px; height: 30px; font-size: 0.8rem; }
      .progress-line { width: 18px; }
      .btn { padding: 0.85rem 1.5rem; }
      .step1-hero { grid-template-columns: 1fr; }
      .hero-panel { padding: 1.75rem; }
      .hero-mini { margin-top: 0.9rem; }
      section[id^="step"]{ padding: 1rem; }
      .section-nav{ top: 62px; padding: 0.65rem 0.65rem; }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-icon">üçΩÔ∏è</div>
        <div class="brand-text">
          <div class="brand-title">Dinner Party Planner</div>
          <div class="brand-tagline">Create unforgettable experiences</div>
        </div>
      </div>
      <div class="topbar-right">
        <span class="beta-pill">Beta</span>
      </div>
    </div>
  </header>
  
  <div class="container">
    <!-- Progress -->
    <div class="progress">
      <div class="progress-step active" id="dot1" onclick="jumpToStep(1)">1</div>
      <div class="progress-line" id="line1"></div>
      <div class="progress-step" id="dot2" onclick="jumpToStep(2)">2</div>
      <div class="progress-line" id="line2"></div>
      <div class="progress-step" id="dot3" onclick="jumpToStep(3)">3</div>
      <div class="progress-line" id="line3"></div>
      <div class="progress-step" id="dot4" onclick="jumpToStep(4)">4</div>
      <div class="progress-line" id="line4"></div>
      <div class="progress-step" id="dot5" onclick="jumpToStep(5)">5</div>
      <div class="progress-line" id="line5"></div>
      <div class="progress-step" id="dot6" onclick="jumpToStep(6)">6</div>
      <div class="progress-line" id="line6"></div>
      <div class="progress-step" id="dot7" onclick="jumpToStep(7)">7</div>
    </div>

    <div class="section-nav hidden" id="sectionNav" aria-label="On this step"></div>
    
    <!-- Step 1: Access Code -->
    <section id="step1">
      <div class="step1-hero">
        <div class="hero-panel">
          <div class="hero-kicker">Your private dinner-party concierge</div>
          <h2 class="hero-title">Make a beautiful plan ‚Äî then enjoy your own party.</h2>
          <p class="hero-lede">
            In a few minutes, you‚Äôll have a complete menu, a beverage program, a shopping list, and a cooking timeline ‚Äî
            all tailored to your guests and your style.
          </p>
          <div class="hero-points">
            <div class="hero-point"><span class="dot"></span><div class="text"><strong>Fast decisions.</strong> One clear choice at a time ‚Äî no overwhelm.</div></div>
            <div class="hero-point"><span class="dot"></span><div class="text"><strong>Execution-ready.</strong> Recipes, prep plan, and service flow that actually works.</div></div>
            <div class="hero-point"><span class="dot"></span><div class="text"><strong>Printables included.</strong> Place cards, menus, invitations, and a polished cookbook.</div></div>
          </div>
          <div class="hero-mini" aria-label="What you‚Äôll get">
            <span class="mini-pill">Menus</span>
            <span class="mini-pill">Shopping list</span>
            <span class="mini-pill">Timeline</span>
            <span class="mini-pill">Wine tiers</span>
            <span class="mini-pill">Cookbook (DOCX + HTML)</span>
          </div>
        </div>

        <div class="hero-entry">
          <div class="card entry-card" data-screen="Access">
            <h2 class="card-title">Welcome, Host</h2>
            <p class="card-subtitle">Enter your access code to start.</p>
            <div class="form-group">
              <label for="accessCode">Access Code</label>
              <input type="text" id="accessCode" placeholder="Enter your beta access code" autocomplete="off">
            </div>
            <div id="codeMessage"></div>
            <div class="actions" style="margin-top:1rem">
              <button class="btn btn-primary" onclick="validateCode()">Begin Planning</button>
            </div>
          </div>

          <details class="card drawer" data-screen="Planner (optional)">
            <summary>
              <div>
                <div class="sum-title">Talk to your Planner (optional)</div>
                <div class="sum-hint">Ask a quick question ‚Äî voice or type.</div>
              </div>
              <span class="beta-pill" style="letter-spacing:0.02em;text-transform:none;font-weight:700;font-size:0.85rem">üóÇÔ∏è</span>
            </summary>
            <div class="drawer-body">
              <div class="chat-container">
                <div class="chat-header">
                  <span class="icon">üóÇÔ∏è</span>
                  <span class="name">The Planner</span>
                  <span class="spacer"></span>
                  <div class="chat-controls">
                    <span class="mic-status"><span class="mic-dot" id="plannerMicDot"></span><span id="plannerMicText">Mic off</span></span>
                    <span class="status-pill"><span class="status-dot off" id="plannerStatusDot"></span><span id="plannerStatusText">Idle</span></span>
                    <label><input type="checkbox" id="plannerVoiceToggle"> Voice</label>
                    <label><input type="checkbox" id="plannerAutoSendToggle" checked> Auto-send</label>
                    <label><input type="checkbox" id="plannerHandsFreeToggle"> Hands-free</label>
                    <button class="btn btn-outline" style="padding:0.45rem 0.8rem;font-size:0.85rem" onclick="enableAudio()">Enable audio</button>
                  </div>
                </div>
                <div class="mic-banner hidden" id="plannerMicBanner"><strong>Microphone ON</strong> ‚Äî your speech is transcribed in this browser. Click ‚ÄúStop Mic‚Äù to turn it off.</div>
                <div class="interim hidden" id="plannerInterim"></div>
                <div class="chat-messages" id="plannerMessages"></div>
                <div class="chat-input-area">
                  <input type="text" id="plannerInput" placeholder="Ask the Planner..." onkeypress="if(event.key==='Enter')sendPlannerChat()">
                  <button class="btn btn-outline mic-btn" id="plannerMicBtn" onclick="togglePlannerMic()">Start Mic</button>
                  <button class="btn btn-primary" onclick="sendPlannerChat()">Send</button>
                </div>
              </div>
            </div>
          </details>
        </div>
      </div>
    </section>
    
    <!-- Step 2: Event Details -->
    <section id="step2" class="hidden">
      <div class="card" data-screen="Event details">
        <h2 class="card-title">Event Details</h2>
        <p class="card-subtitle">Tell us about your dinner party ‚Äî the basics help us personalize everything.</p>
        <div class="form-row">
          <div class="form-group">
            <label for="eventTitle">Event Name</label>
            <input type="text" id="eventTitle" placeholder="e.g., Anniversary Celebration">
          </div>
          <div class="form-group">
            <label for="eventDate">Date</label>
            <input type="date" id="eventDate">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="guestCount">Number of Guests</label>
            <select id="guestCount">
              <option value="2">2 guests (Intimate)</option>
              <option value="4">4 guests</option>
              <option value="6" selected>6 guests</option>
              <option value="8">8 guests</option>
              <option value="10">10 guests</option>
              <option value="12">12 guests (Large)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="serviceTime">Service Time</label>
            <select id="serviceTime">
              <option value="6:00 PM">6:00 PM</option>
              <option value="6:30 PM">6:30 PM</option>
              <option value="7:00 PM" selected>7:00 PM</option>
              <option value="7:30 PM">7:30 PM</option>
              <option value="8:00 PM">8:00 PM</option>
              <option value="8:30 PM">8:30 PM</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="guestList">Guest Names <span style="font-weight:normal;color:var(--text-light)">(for place cards, one per line)</span></label>
          <textarea id="guestList" rows="4" placeholder="Jane Smith&#10;John Smith&#10;..."></textarea>
        </div>
        <div class="form-group">
          <label>Guest Details <span style="font-weight:normal;color:var(--text-light)">(auto-formatted; edit as needed)</span></label>
          <div id="guestDetails"></div>
        </div>
      </div>
      
      <div class="card" data-screen="Printed style">
        <h2 class="card-title">Menu Card Style</h2>
        <p class="card-subtitle">Choose the aesthetic for your printed materials.</p>
        <div class="style-layout">
          <div class="style-panel">
            <h4>Styles</h4>
            <div class="style-grid" id="styleGrid"></div>
          </div>
          <div class="style-preview" aria-live="polite">
            <div class="style-preview-header">
              <div class="label">Live preview</div>
              <div class="hint">This is what guests will see on the table.</div>
            </div>
            <div class="menu-card-preview" id="stylePreview"></div>
          </div>
        </div>
      </div>
      
      <div class="actions">
        <button class="btn btn-secondary" onclick="goToStep(1)">Back</button>
        <button class="btn btn-primary" onclick="goToStep(3)">Continue</button>
      </div>
    </section>
    
    <!-- Step 3: Preferences -->
    <section id="step3" class="hidden">
      <div class="card" data-screen="Inspiration">
        <h2 class="card-title">Menu Inspiration</h2>
        <p class="card-subtitle">What kind of dining experience are you creating? This guides our menu suggestions.</p>
        <div class="inspiration-grid" id="inspirationGrid"></div>
        
        <div id="customMenuInput" class="hidden" style="margin-top:1.5rem">
          <div class="form-group">
            <label for="customMenu">Your Menu</label>
            <textarea id="customMenu" rows="6" placeholder="Enter your planned courses..."></textarea>
          </div>
        </div>
      </div>
      
      <div class="card" data-screen="Budget & skill">
        <h2 class="card-title">Budget & Skill Level</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="foodBudget">Food Budget (per person)</label>
            <select id="foodBudget">
              <option value="$30-45">$30-45 ‚Äî Casual Elegant</option>
              <option value="$45-60" selected>$45-60 ‚Äî Classic Dinner Party</option>
              <option value="$60-80">$60-80 ‚Äî Upscale</option>
              <option value="$80-100">$80-100 ‚Äî Premium</option>
              <option value="$100+">$100+ ‚Äî Luxe</option>
            </select>
          </div>
          <div class="form-group">
            <label for="wineBudget">Wine Budget (total)</label>
            <select id="wineBudget">
              <option value="$50-80">$50-80</option>
              <option value="$80-120" selected>$80-120</option>
              <option value="$120-180">$120-180</option>
              <option value="$180-250">$180-250</option>
              <option value="$250+">$250+</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="skillLevel">Your Cooking Experience</label>
          <select id="skillLevel">
            <option value="beginner">Beginner ‚Äî I follow recipes carefully</option>
            <option value="intermediate" selected>Intermediate ‚Äî Comfortable improvising</option>
            <option value="advanced">Advanced ‚Äî Professionally trained or serious home cook</option>
          </select>
        </div>
      </div>
      
      <div class="card" data-screen="Preferences">
        <h2 class="card-title">Taste Preferences</h2>
        <div class="form-group">
          <label>Cuisine Direction</label>
          <div class="chip-group" id="cuisineChips"></div>
          <div id="cuisineSubOptions" class="cuisine-section hidden"></div>
        </div>
        <div class="form-group">
          <label>Favorites <span style="font-weight:normal;color:var(--text-light)">(select all that apply)</span></label>
          <div class="chip-group" id="likesChips"></div>
        </div>
        <div class="form-group">
          <label>Avoid</label>
          <div class="chip-group" id="dislikesChips"></div>
        </div>
        <div class="form-group">
          <label>Dietary Restrictions</label>
          <div class="chip-group" id="restrictionsChips"></div>
        </div>
      </div>
      
      <div class="actions">
        <button class="btn btn-secondary" onclick="goToStep(2)">Back</button>
        <button class="btn btn-primary" onclick="goToStep(4)">Continue</button>
      </div>
    </section>
    
    <!-- Step 4: Expert Consultation -->
    <section id="step4" class="hidden">
      <div class="card" data-screen="Choose an expert">
        <h2 class="card-title">Expert Consultation</h2>
        <p class="card-subtitle">Before we design your menu, would you like to consult with our experts? They can help refine your vision and answer questions. This is optional but recommended.</p>
        <div class="expert-grid" id="expertGrid"></div>
        <div class="actions" style="margin-top:1.5rem">
          <button class="btn btn-outline" onclick="skipConsultation()">Skip ‚Äî Generate Menus</button>
        </div>
      </div>
      
      <div id="chatSection" class="hidden" data-screen="Consultation chat">
        <div class="chat-container">
          <div class="chat-header">
            <span class="icon" id="chatIcon">üë®‚Äçüç≥</span>
            <span class="name" id="chatName">The Chef</span>
            <span class="spacer"></span>
            <div class="chat-controls">
              <span class="mic-status"><span class="mic-dot" id="expertMicDot"></span><span id="expertMicText">Mic off</span></span>
              <span class="status-pill"><span class="status-dot off" id="expertStatusDot"></span><span id="expertStatusText">Idle</span></span>
              <label><input type="checkbox" id="expertVoiceToggle"> Voice</label>
              <label><input type="checkbox" id="expertAutoSendToggle" checked> Auto-send</label>
              <label><input type="checkbox" id="expertHandsFreeToggle"> Hands-free</label>
              <button class="btn btn-outline" style="padding:0.45rem 0.8rem;font-size:0.85rem" onclick="enableAudio()">Enable audio</button>
            </div>
          </div>
          <div class="mic-banner hidden" id="expertMicBanner"><strong>Microphone ON</strong> ‚Äî your speech is transcribed in this browser. Click ‚ÄúStop Mic‚Äù to turn it off.</div>
          <div class="interim hidden" id="expertInterim"></div>
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Ask a question or share your vision..." onkeypress="if(event.key==='Enter')sendChat()">
            <button class="btn btn-outline mic-btn" id="expertMicBtn" onclick="toggleExpertMic()">Start Mic</button>
            <button class="btn btn-primary" onclick="sendChat()">Send</button>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-secondary" onclick="goToStep(3)">Back to Preferences</button>
          <button class="btn btn-outline" onclick="endChat()">End Consultation</button>
          <button class="btn btn-gold" onclick="proceedToMenus()">Generate Menus ‚Üí</button>
        </div>
      </div>
    </section>
    
    <!-- Step 5: Menu Selection -->
    <section id="step5" class="hidden">
      <h2 class="section-title">Choose Your Menu</h2>
      
      <div id="menuLoading" class="loading hidden">
        <div class="spinner"></div>
        <p>Our culinary team is crafting your personalized menus...</p>
      </div>
      
      <div id="menuList"></div>
      
      <div id="menuActions" class="actions hidden">
        <button class="btn btn-secondary" onclick="goToStep(4)">Back</button>
        <button class="btn btn-outline" onclick="rejectMenus()">None of These Work</button>
        <button class="btn btn-outline" onclick="loadWineTiers()">Get beverage options</button>
        <button class="btn btn-primary" id="selectMenuBtn" onclick="selectMenu()" disabled>Select This Menu</button>
      </div>
      
      <div id="rejectionChat" class="hidden">
        <div class="card" data-screen="Adjust the menus">
          <h3 class="card-title">Let's Find Your Perfect Menu</h3>
          <p class="card-subtitle">I sense none of these hit the mark. Help me understand what you're looking for...</p>
          <div class="chat-container">
            <div class="chat-header">
              <span class="icon">üë®‚Äçüç≥</span>
              <span class="name">The Chef</span>
            </div>
            <div class="chat-messages" id="rejectionMessages"></div>
            <div class="chat-input-area">
              <input type="text" id="rejectionInput" placeholder="What did you imagine for this dinner?" onkeypress="if(event.key==='Enter')sendRejection()">
              <button class="btn btn-primary" onclick="sendRejection()">Send</button>
            </div>
          </div>
          <div class="actions">
            <button class="btn btn-gold" onclick="regenerateMenus()">Generate New Menus</button>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Step 6: Staffing -->
    <section id="step6" class="hidden">
      <div class="card" data-screen="Staffing">
        <h2 class="card-title">Kitchen Staffing</h2>
        <p class="card-subtitle">How will you be staffing your kitchen? This affects your prep timeline and what's realistic to execute.</p>
        <div id="staffingOptions"></div>
      </div>
      
      <div class="card" data-screen="Selected menu">
        <h3 class="card-title" style="font-size:1.2rem">Your Selected Menu</h3>
        <div id="selectedMenuSummary"></div>
      </div>

      <div class="card" data-screen="Sommelier">
        <h2 class="card-title">Sommelier Service (After Menu Choice)</h2>
        <p class="card-subtitle">Ask about serving order, decanting, glassware, cocktails/mocktails, and how the pairings work.</p>
        <div class="chat-container">
          <div class="chat-header">
            <span class="icon">üç∑</span>
            <span class="name">The Sommelier</span>
            <span class="spacer"></span>
            <div class="chat-controls">
              <span class="mic-status"><span class="mic-dot" id="sommMicDot"></span><span id="sommMicText">Mic off</span></span>
              <span class="status-pill"><span class="status-dot off" id="sommStatusDot"></span><span id="sommStatusText">Idle</span></span>
              <label><input type="checkbox" id="sommVoiceToggle"> Voice</label>
              <label><input type="checkbox" id="sommAutoSendToggle" checked> Auto-send</label>
              <label><input type="checkbox" id="sommHandsFreeToggle"> Hands-free</label>
              <button class="btn btn-outline" style="padding:0.45rem 0.8rem;font-size:0.85rem" onclick="enableAudio()">Enable audio</button>
            </div>
          </div>
          <div class="mic-banner hidden" id="sommMicBanner"><strong>Microphone ON</strong> ‚Äî your speech is transcribed in this browser. Click ‚ÄúStop Mic‚Äù to turn it off.</div>
          <div class="interim hidden" id="sommInterim"></div>
          <div class="chat-messages" id="sommMessages"></div>
          <div class="chat-input-area">
            <input type="text" id="sommInput" placeholder="Ask the Sommelier..." onkeypress="if(event.key==='Enter')sendSommChat()">
            <button class="btn btn-outline mic-btn" id="sommMicBtn" onclick="toggleSommMic()">Start Mic</button>
            <button class="btn btn-primary" onclick="sendSommChat()">Send</button>
          </div>
        </div>
      </div>

      <div class="card" data-screen="Cookbook format">
        <h2 class="card-title">Cookbook Format</h2>
        <p class="card-subtitle">Choose a layout for printing and sharing.</p>
        <div class="form-group">
          <label for="cookbookFormat">Format</label>
          <select id="cookbookFormat" onchange="selectCookbookFormat(this.value)">
            <option value="cards">Recipe Cards</option>
            <option value="binder" selected>3-Ring Binder (Full Cookbook)</option>
            <option value="gift">Gift Presentation</option>
            <option value="lesson">Cooking School Lesson Plan</option>
            <option value="graphic">Graphic Novel (Storyboard)</option>
          </select>
        </div>
      </div>
      
      <div class="actions">
        <button class="btn btn-secondary" onclick="goToStep(5)">Back</button>
        <button class="btn btn-gold" onclick="generateCookbook()">Generate Complete Cookbook</button>
      </div>
    </section>
    
    <!-- Step 7: Cookbook & Downloads -->
    <section id="step7" class="hidden">
      <div id="cookbookLoading" class="loading hidden">
        <div class="spinner"></div>
        <p>Creating your complete cookbook with recipes, timeline, and shopping list...</p>
      </div>
      
      <div id="cookbookComplete" class="hidden">
        <div class="card text-center" data-screen="Cookbook">
          <h2 class="card-title">üéâ Your Cookbook is Ready!</h2>
          <p class="card-subtitle">Your complete dinner party cookbook has been generated with all 15 sections.</p>
          
          <div class="cookbook-preview">
            <h4>Your Cookbook Includes:</h4>
            <div class="cookbook-sections" id="cookbookSectionsList"></div>
          </div>
          
          <div class="actions">
            <button class="btn btn-gold" onclick="downloadCookbook()">üì• Download DOCX Cookbook</button>
            <button class="btn btn-outline" onclick="viewCookbookHtml()">View / Print HTML Cookbook</button>
          </div>
        </div>
        
        <div class="card" data-screen="Print products">
          <h2 class="card-title">Print Products</h2>
          <p class="card-subtitle">Download print-ready files formatted for Avery paper products.</p>
          
          <div class="print-section">
            <h4>üìç Place Cards</h4>
            <div id="placeCardProducts"></div>
          </div>
          
          <div class="print-section">
            <h4>üìã Menu Cards</h4>
            <div id="menuCardProducts"></div>
          </div>
          
          <div class="print-section">
            <h4>üíå Invitations</h4>
            <div id="invitationProducts"></div>
          </div>
        </div>
        
        <div class="actions">
          <button class="btn btn-secondary" onclick="startOver()">Plan Another Party</button>
        </div>
      </div>
    </section>
    
    <footer>
      <p>Dinner Party Planner &copy; 2025</p>
      <p style="font-size:0.75rem;margin-top:0.35rem;opacity:0.7">AI-assisted recipe development. Recipes are original adaptations inspired by classic techniques.</p>
    </footer>
  </div>

  <div class="toast hidden" id="toast"></div>
  
  <script>
    // ============================================================
    // STATE
    // ============================================================
    let DATA = {};
    let currentStep = 1;
    let maxStepReached = 1;
    let accessCode = '';
    let selectedStyle = 'classic';
    let selectedInspiration = 'chefs-tasting';
    let selectedCuisine = null;
    let selectedSubCuisine = null;
    let likes = [];
    let dislikes = [];
    let restrictions = [];
    let selectedExpert = null;
    let chatHistory = [];
    let menus = [];
    let selectedMenu = null;
    let selectedStaffing = 'solo';
    let selectedCookbookFormat = 'binder';
    let rejectionHistory = [];
    let cookbookId = null;
    let wineTiers = null;
    let wineTiersLoading = false;
    let guests = [];
    let plannerHistory = [];
    let sommHistory = [];
    let speech = { planner: null, expert: null, somm: null };
    let mic = { planner: false, expert: false, somm: false };
    let audioUnlocked = false;
    // Persistent WebAudio context for TTS playback (more reliable than HTMLAudioElement
    // across async boundaries once user gesture has resumed the context).
    let ttsAudio = { ctx: null };
    let speaking = { planner: false, expert: false, somm: false };
    
    // ============================================================
    // INITIALIZATION
    // ============================================================
    async function init() {
      try {
        const res = await fetch('/api/data');
        DATA = await res.json();
      } catch (e) {
        console.error('Failed to load data:', e);
      }
      
      initStyleGrid();
      initInspirationGrid();
      initCuisineChips();
      initPreferenceChips();
      initExpertGrid();
      initStaffingOptions();
      initAveryProducts();
      initCookbookSections();
      
      // Set default date 2 weeks out
      const defaultDate = new Date();
      defaultDate.setDate(defaultDate.getDate() + 14);
      document.getElementById('eventDate').value = defaultDate.toISOString().split('T')[0];

      // Keep style preview in sync with event details
      ['eventTitle', 'eventDate', 'serviceTime'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', () => renderStylePreview());
        if (el) el.addEventListener('change', () => renderStylePreview());
      });
      
      // Enter key for access code
      document.getElementById('accessCode').addEventListener('keypress', e => {
        if (e.key === 'Enter') validateCode();
      });

      // Any attempt to use voice should unlock audio automatically.
      ['plannerVoiceToggle','expertVoiceToggle','sommVoiceToggle'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', () => { if (el.checked) enableAudio(); });
      });

      // Also unlock audio on the first tap/click anywhere (required by some browsers).
      window.addEventListener('pointerdown', () => enableAudio(), { once: true, passive: true });

      // Restore access code for this tab session (so refresh doesn‚Äôt force re-entry)
      restoreSession();

      // Guest details live formatting
      document.getElementById('guestList').addEventListener('input', () => rebuildGuests());
      document.getElementById('guestCount').addEventListener('change', () => rebuildGuests());
      rebuildGuests();

      // Initialize planner + somm chat
      initPlannerChat();
      initSommChat();

      // Hands-free toggles: start/stop listening automatically
      const plannerHF = document.getElementById('plannerHandsFreeToggle');
      if (plannerHF) plannerHF.addEventListener('change', () => {
        setHandsFree('planner', plannerHF.checked);
      });
      const expertHF = document.getElementById('expertHandsFreeToggle');
      if (expertHF) expertHF.addEventListener('change', () => {
        setHandsFree('expert', expertHF.checked);
      });
      const sommHF = document.getElementById('sommHandsFreeToggle');
      if (sommHF) sommHF.addEventListener('change', () => {
        setHandsFree('somm', sommHF.checked);
      });

      // Build the in-step nav on first load (Step 1).
      updateSectionNav();
    }
    
    document.addEventListener('DOMContentLoaded', init);

    function voiceEnabled(id) {
      const el = document.getElementById(id);
      return !!el && el.checked;
    }

    function autoSendEnabled(id) {
      const el = document.getElementById(id);
      return !!el && el.checked;
    }

    function showToast(message, ms=2600) {
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = message;
      t.classList.remove('hidden');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => t.classList.add('hidden'), ms);
    }

    function setMicUi(role, isOn) {
      mic[role] = !!isOn;
      const dot = document.getElementById(role + 'MicDot');
      const text = document.getElementById(role + 'MicText');
      const banner = document.getElementById(role + 'MicBanner');
      const btn = document.getElementById(role + 'MicBtn');
      if (dot) dot.classList.toggle('on', !!isOn);
      if (text) text.textContent = isOn ? 'Listening‚Ä¶' : 'Mic off';
      if (banner) banner.classList.toggle('hidden', !isOn);
      if (btn) btn.textContent = isOn ? 'Stop Mic' : 'Start Mic';
    }

    async function enableAudio() {
      // Must be called from a user gesture.
      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (AudioCtx && !ttsAudio.ctx) ttsAudio.ctx = new AudioCtx();
        if (ttsAudio.ctx && ttsAudio.ctx.state !== 'running') {
          await ttsAudio.ctx.resume().catch(()=>{});
        }
        audioUnlocked = true;
        // Keep this silent; hands-free should feel automatic.
      } catch {
        audioUnlocked = true;
        // Keep this silent; hands-free should feel automatic.
      }
    }

    function setStatus(role, status) {
      const dot = document.getElementById(role + 'StatusDot');
      const text = document.getElementById(role + 'StatusText');
      if (!dot || !text) return;
      dot.classList.remove('listening', 'thinking', 'speaking', 'off');
      if (status === 'listening') { dot.classList.add('listening'); text.textContent = 'Listening'; return; }
      if (status === 'thinking') { dot.classList.add('thinking'); text.textContent = 'Thinking'; return; }
      if (status === 'speaking') { dot.classList.add('speaking'); text.textContent = 'Speaking'; return; }
      dot.classList.add('off'); text.textContent = 'Idle';
    }

    function sanitizeSpeechText(text) {
      let t = String(text || '');
      // Remove markdown/code
      t = t.replace(/```[\s\S]*?```/g, ' ');
      t = t.replace(/\*\*(.*?)\*\*/g, '$1');
      t = t.replace(/\*(.*?)\*/g, '$1');
      t = t.replace(/`([^`]+)`/g, '$1');
      // Replace punctuation so it's not "read out"
      t = t.replace(/[‚Äú‚Äù]/g, '"').replace(/[‚Äò‚Äô]/g, "'");
      t = t.replace(/[(){}\[\]:;]/g, ' ');
      t = t.replace(/[‚Äî‚Äì]/g, ' ');
      t = t.replace(/[!?]+/g, '. ');
      // Collapse whitespace
      t = t.replace(/\s+/g, ' ').trim();
      return t;
    }

    async function speak(text, voiceRole) {
      // Avoid speaking empty or placeholder responses.
      const t = sanitizeSpeechText(text);
      if (!t || t === '...') return;
      try {
        // Try to unlock audio automatically (Send/Hands-free is a user gesture).
        if (!audioUnlocked) await enableAudio();

        const res = await fetch('/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ voice: voiceRole, text: t })
        });
        if (!res.ok) {
          const j = await res.json().catch(()=>null);
          // Prefer ElevenLabs; avoid "stock voice" fallback when it isn't configured.
          const msg = j?.error ? String(j.error) : 'ElevenLabs voice failed.';
          const extra = j?.upstreamStatus ? ` (upstream ${j.upstreamStatus})` : '';
          showToast(`ElevenLabs: ${msg}${extra}`);
          // Only fall back if ElevenLabs is up but transiently fails.
          const shouldFallback = !/not configured/i.test(msg);
          if (shouldFallback) return speakWithDeviceVoice(t);
          return;
        }
        const ab = await res.arrayBuffer();
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;
        if (!ttsAudio.ctx) ttsAudio.ctx = new AudioCtx();
        if (ttsAudio.ctx.state !== 'running') {
          // If this fails, browser is still blocking audio activation.
          await ttsAudio.ctx.resume().catch(() => {});
        }

        const decode = (ctx, buf) => new Promise((resolve, reject) => {
          try {
            const p = ctx.decodeAudioData(buf, resolve, reject);
            // Some browsers return a promise; if so, hook it too.
            if (p && typeof p.then === 'function') p.then(resolve).catch(reject);
          } catch (e) { reject(e); }
        });

        const audioBuffer = await decode(ttsAudio.ctx, ab.slice(0));
        const src = ttsAudio.ctx.createBufferSource();
        src.buffer = audioBuffer;
        src.connect(ttsAudio.ctx.destination);
        await new Promise((resolve) => {
          src.onended = () => resolve();
          try { src.start(0); } catch { resolve(); }
        });
      } catch {
        // If anything goes wrong, use device voice (best-effort).
        return speakWithDeviceVoice(t);
      }
    }

    function speakWithDeviceVoice(text) {
      return new Promise((resolve) => {
        try {
          if (!('speechSynthesis' in window)) return resolve();
          const u = new SpeechSynthesisUtterance(sanitizeSpeechText(text));
          u.rate = 1.0;
          u.pitch = 1.0;
          u.volume = 1.0;
          u.onend = () => resolve();
          u.onerror = () => resolve();
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(u);
        } catch {
          resolve();
        }
      });
    }

    async function ensureMicPermission() {
      if (!navigator.mediaDevices?.getUserMedia) throw new Error('Microphone not supported');
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(t => t.stop());
    }

    const ROLE_CFG = {
      planner: {
        inputId: 'plannerInput',
        interimId: 'plannerInterim',
        voiceId: 'plannerVoiceToggle',
        autoSendId: 'plannerAutoSendToggle',
        handsFreeId: 'plannerHandsFreeToggle',
        send: () => sendPlannerChat(),
      },
      expert: {
        inputId: 'chatInput',
        interimId: 'expertInterim',
        voiceId: 'expertVoiceToggle',
        autoSendId: 'expertAutoSendToggle',
        handsFreeId: 'expertHandsFreeToggle',
        send: () => sendChat(),
      },
      somm: {
        inputId: 'sommInput',
        interimId: 'sommInterim',
        voiceId: 'sommVoiceToggle',
        autoSendId: 'sommAutoSendToggle',
        handsFreeId: 'sommHandsFreeToggle',
        send: () => sendSommChat(),
      }
    };

    function handsFreeOn(role) {
      const cfg = ROLE_CFG[role];
      const el = cfg ? document.getElementById(cfg.handsFreeId) : null;
      return !!el && el.checked;
    }

    function setChecked(id, v) {
      const el = document.getElementById(id);
      if (el) el.checked = !!v;
    }

    function stopRoleMic(role) {
      try {
        if (speech[role]) speech[role].stop();
      } catch {}
    }

    async function startRoleMic(role, opts = {}) {
      const cfg = ROLE_CFG[role];
      if (!cfg) return;
      if (speech[role]) return;
      if (speaking[role]) return;

      if (opts.ensurePermission) {
        try {
          await ensureMicPermission();
        } catch {
          showToast('Microphone permission denied or not available.');
          return;
        }
      }

      const rec = createRecognizer((text) => {
        const input = document.getElementById(cfg.inputId);
        if (input) input.value = text;
        const interim = document.getElementById(cfg.interimId);
        if (interim) { interim.textContent = text; interim.classList.remove('hidden'); }
      }, () => {
        speech[role] = null;
        // In hands-free mode, we'll restart after the assistant finishes speaking.
        if (!handsFreeOn(role)) setMicUi(role, false);
        const interim = document.getElementById(cfg.interimId);
        if (interim) interim.classList.add('hidden');
        if (autoSendEnabled(cfg.autoSendId)) cfg.send();
        if (!handsFreeOn(role)) showToast('Microphone off.');
      });

      if (!rec) { showToast('Speech recognition not supported in this browser.'); return; }
      speech[role] = rec;
      setMicUi(role, true);
      setStatus(role, 'listening');
      showToast(handsFreeOn(role) ? 'Hands-free: listening. Speak, pause, and it will send.' : 'Microphone on. Speak now, then click Stop Mic.');
      try {
        rec.start();
      } catch {
        speech[role] = null;
        setMicUi(role, false);
        showToast('Unable to start speech recognition. Try clicking Start Mic once.');
      }
    }

    async function setHandsFree(role, enabled) {
      const cfg = ROLE_CFG[role];
      if (!cfg) return;
      if (enabled) {
        // Make hands-free "one switch": enable voice replies + auto-send.
        setChecked(cfg.voiceId, true);
        setChecked(cfg.autoSendId, true);
        enableAudio();
        await startRoleMic(role, { ensurePermission: true });
      } else {
        stopRoleMic(role);
        setMicUi(role, false);
        setStatus(role, 'idle');
      }
    }

    async function resumeHandsFree(role) {
      if (!handsFreeOn(role)) return;
      if (speech[role]) return;
      if (speaking[role]) return;
      // No permission prompts here: the user enables hands-free once per session.
      await startRoleMic(role, { ensurePermission: false });
    }

    function createRecognizer(onText, onEnd) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      const rec = new SR();
      rec.continuous = false;
      rec.interimResults = true;
      rec.lang = 'en-US';
      let silenceTimer = null;
      let noSpeechTimer = null;
      let lastTranscript = '';
      let lastFinal = '';
      const resetSilence = () => {
        clearTimeout(silenceTimer);
        // Hands-free should feel natural: give a bit more time before cutting off.
        silenceTimer = setTimeout(() => {
          try { rec.stop(); } catch {}
        }, 900);
      };
      const clearNoSpeech = () => {
        clearTimeout(noSpeechTimer);
        noSpeechTimer = null;
      };
      rec.onresult = (e) => {
        clearNoSpeech();
        const idx = (e.results?.length || 1) - 1;
        const result = e.results?.[idx];
        const text = (result?.[0]?.transcript || '').trim();
        if (text) lastTranscript = text;
        if (result?.isFinal && text) lastFinal = text;
        // Show interim/live text; auto-send will use final if available.
        if (text) onText(text);
        resetSilence();
      };
      rec.onstart = () => {
        // If nothing is recognized within 6 seconds, surface a helpful hint.
        clearNoSpeech();
        noSpeechTimer = setTimeout(() => {
          showToast('No speech detected. Check your mic permission and selected input device.');
          try { rec.stop(); } catch {}
        }, 6000);
      };
      rec.onspeechstart = () => resetSilence();
      rec.onspeechend = () => {
        // When browser thinks speech ended, stop soon
        clearTimeout(silenceTimer);
        silenceTimer = setTimeout(() => {
          try { rec.stop(); } catch {}
        }, 250);
      };
      rec.onend = () => {
        clearNoSpeech();
        onEnd(lastFinal || lastTranscript);
      };
      rec.onerror = (e) => {
        clearNoSpeech();
        showToast(`Speech error: ${e?.error || 'unknown'}`);
        onEnd(lastFinal || lastTranscript);
      };
      return rec;
    }

    // =========================
    // Planner chat (Step 1)
    // =========================
    function initPlannerChat() {
      plannerHistory = [{
        role: 'assistant',
        content: "Welcome ‚Äî I‚Äôm your Planner. If you‚Äôd like, tell me what kind of night you want to host (intimate, festive, elegant, casual) and any dietary must‚Äëdos."
      }];
      renderPlannerChat();
    }

    function renderPlannerChat() {
      const container = document.getElementById('plannerMessages');
      if (!container) return;
      container.innerHTML = plannerHistory.map(msg => `
        <div class="chat-message ${msg.role}">
          <div class="bubble">${formatChatMessage(msg.content)}</div>
        </div>
      `).join('');
      container.scrollTop = container.scrollHeight;
    }

    async function sendPlannerChat() {
      const input = document.getElementById('plannerInput');
      const message = (input?.value || '').trim();
      if (!message) return;
      plannerHistory.push({ role: 'user', content: message });
      input.value = '';
      renderPlannerChat();

      plannerHistory.push({ role: 'assistant', content: '...' });
      renderPlannerChat();
      setStatus('planner', 'thinking');

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            persona: 'planner',
            messages: plannerHistory.slice(0, -1),
            context: getContext()
          })
        });
        const data = await res.json();
        const reply = data.response || 'Please try again.';
        plannerHistory[plannerHistory.length - 1] = { role: 'assistant', content: reply };
        renderPlannerChat();
        if (voiceEnabled('plannerVoiceToggle') || handsFreeOn('planner')) {
          setStatus('planner', 'speaking');
          speaking.planner = true;
          await speak(reply, 'planner');
          speaking.planner = false;
          setStatus('planner', handsFreeOn('planner') ? 'listening' : 'idle');
        } else {
          setStatus('planner', 'idle');
        }
        await resumeHandsFree('planner');
      } catch {
        plannerHistory[plannerHistory.length - 1] = { role: 'assistant', content: 'Connection error. Please try again.' };
        renderPlannerChat();
        setStatus('planner', 'idle');
      }
    }

    async function togglePlannerMic() {
      if (!speech.planner) return startRoleMic('planner', { ensurePermission: true });
      stopRoleMic('planner');
      const cfg = ROLE_CFG.planner;
      if (cfg) setChecked(cfg.handsFreeId, false);
      setMicUi('planner', false);
      setStatus('planner', 'idle');
    }

    // =========================
    // Expert mic + voice (Step 4)
    // =========================
    async function toggleExpertMic() {
      if (!speech.expert) return startRoleMic('expert', { ensurePermission: true });
      stopRoleMic('expert');
      const cfg = ROLE_CFG.expert;
      if (cfg) setChecked(cfg.handsFreeId, false);
      setMicUi('expert', false);
      setStatus('expert', 'idle');
    }
    
    // ============================================================
    // INIT HELPERS
    // ============================================================
    const STYLE_FONTS = {
      classic: "'Libre Baskerville', Georgia, serif",
      modern: "'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
      romantic: "'Cormorant Garamond', Georgia, serif",
      artdeco: "'Cinzel', Georgia, serif",
      rustic: "'Libre Baskerville', Georgia, serif",
      botanical: "'Cormorant Garamond', Georgia, serif",
      coastal: "'Playfair Display', Georgia, serif",
      urban: "'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif"
    };

    const STYLE_PRESETS = {
      classic: { bg: '#ffffff', border: 'rgba(17,24,39,0.10)', accent: '#1E3A5F' },
      modern: { bg: '#ffffff', border: 'rgba(17,24,39,0.12)', accent: '#111827' },
      romantic: { bg: '#fffaf7', border: 'rgba(201,162,39,0.35)', accent: '#C9A227' },
      artdeco: { bg: '#0b1220', border: 'rgba(201,162,39,0.65)', accent: '#C9A227', ink: '#f8fafc' },
      rustic: { bg: '#fbf7f1', border: 'rgba(30,58,95,0.18)', accent: '#1E3A5F' },
      botanical: { bg: '#f7fbf7', border: 'rgba(22,163,74,0.25)', accent: '#166534' },
      coastal: { bg: '#f6fbff', border: 'rgba(2,132,199,0.22)', accent: '#0284c7' },
      urban: { bg: '#ffffff', border: 'rgba(17,24,39,0.16)', accent: '#111827' }
    };

    function initStyleGrid() {
      const grid = document.getElementById('styleGrid');
      if (!DATA.MENU_STYLES) return;
      grid.innerHTML = DATA.MENU_STYLES.map(s => `
        <div class="style-card ${selectedStyle === s.id ? 'selected' : ''}" onclick="selectStyle('${s.id}')">
          <div class="name" style="font-family:${STYLE_FONTS[s.id] || `'Playfair Display', Georgia, serif`};">${s.name}</div>
          <div class="desc" style="font-family:${STYLE_FONTS[s.id] || `inherit`};">${s.desc}</div>
        </div>
      `).join('');
      renderStylePreview();
    }

    function renderStylePreview() {
      const el = document.getElementById('stylePreview');
      if (!el) return;

      const preset = STYLE_PRESETS[selectedStyle] || STYLE_PRESETS.classic;
      const font = STYLE_FONTS[selectedStyle] || "'Playfair Display', Georgia, serif";
      const ink = preset.ink || '#111827';

      const eventTitle = document.getElementById('eventTitle').value || 'Dinner Party';
      const eventDate = document.getElementById('eventDate').value || '';
      const serviceTime = document.getElementById('serviceTime').value || '7:00 PM';

      // Always show a complete, high-confidence preview (sample content).
      const previewCourses = [
        { type: 'Amuse-Bouche', name: 'Seasonal bite ¬∑ bright acid ¬∑ crisp texture' },
        { type: 'First Course', name: 'Elegant starter ¬∑ chilled or warm' },
        { type: 'Second Course', name: 'Green course ¬∑ palate reset' },
        { type: 'Main Course', name: 'Signature centerpiece ¬∑ refined comfort' },
        { type: 'Dessert', name: 'Clean finish ¬∑ light sweetness' }
      ];

      el.style.background = preset.bg;
      el.style.borderColor = preset.border;
      el.style.color = ink;
      el.style.fontFamily = font;

      const accentRule = selectedStyle === 'artdeco'
        ? `border-top: 2px solid ${preset.accent}; border-bottom: 2px solid ${preset.accent};`
        : `border-top: 2px solid ${preset.accent};`;

      el.innerHTML = `
        <div class="preview-title" style="font-family:${font}; color:${ink};">${escapeHtml(eventTitle)}</div>
        <div class="preview-meta" style="color:${selectedStyle==='artdeco' ? 'rgba(248,250,252,0.75)' : 'var(--text-light)'};">
          <span><strong>Date:</strong> ${escapeHtml(eventDate || 'TBD')}</span>
          <span><strong>Service:</strong> ${escapeHtml(serviceTime)}</span>
        </div>
        <div class="preview-divider" style="${accentRule} background:transparent;"></div>
        <div>
          ${previewCourses.map(c => `
            <div class="preview-course">
              <div class="preview-course-type" style="color:${preset.accent};">${escapeHtml(c.type)}</div>
              <div class="preview-course-name" style="color:${ink};">${escapeHtml(c.name)}</div>
            </div>
          `).join('')}
        </div>
        <div class="preview-footer" style="color:${selectedStyle==='artdeco' ? 'rgba(248,250,252,0.70)' : 'var(--text-light)'};">
          <span style="letter-spacing:0.08em;text-transform:uppercase;">${escapeHtml((DATA.MENU_STYLES || []).find(s=>s.id===selectedStyle)?.name || 'Style')}</span>
          <span>Printed menu card</span>
        </div>
      `;
    }

    function escapeHtml(str) {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    
    function initInspirationGrid() {
      const grid = document.getElementById('inspirationGrid');
      if (!DATA.MENU_INSPIRATIONS) return;
      grid.innerHTML = DATA.MENU_INSPIRATIONS.map(i => `
        <div class="inspiration-card ${selectedInspiration === i.id ? 'selected' : ''}" onclick="selectInspiration('${i.id}')">
          <div class="icon">${i.icon}</div>
          <div class="title">${i.title}</div>
          <div class="desc">${i.desc}</div>
        </div>
      `).join('');
    }
    
    function initCuisineChips() {
      const container = document.getElementById('cuisineChips');
      if (!DATA.CUISINES) return;
      container.innerHTML = Object.entries(DATA.CUISINES).map(([key, c]) => `
        <span class="chip ${selectedCuisine === key ? 'selected' : ''}" onclick="selectCuisine('${key}')">${c.label}</span>
      `).join('');
    }
    
    function initPreferenceChips() {
      const likeOptions = ['Beef', 'Lamb', 'Pork', 'Veal', 'Seafood', 'Shellfish', 'Poultry', 'Duck', 'Game', 'Pasta', 'Rich Sauces', 'Light & Fresh', 'Mushrooms', 'Truffles', 'Cheese', 'Chocolate', 'Fruit Desserts', 'Custards'];
      const dislikeOptions = ['Shellfish', 'Raw Fish', 'Organ Meats', 'Blue Cheese', 'Very Spicy', 'Olives', 'Anchovies', 'Cilantro', 'Lamb', 'Game', 'Fennel'];
      const restrictionOptions = ['Gluten-Free', 'Dairy-Free', 'Nut Allergy', 'Vegetarian', 'Vegan', 'Pescatarian', 'Low Sodium', 'Low Sugar', 'Kosher', 'Halal'];
      
      document.getElementById('likesChips').innerHTML = likeOptions.map(o => `
        <span class="chip" onclick="toggleChip(this, 'likes', '${o}')">${o}</span>
      `).join('');
      
      document.getElementById('dislikesChips').innerHTML = dislikeOptions.map(o => `
        <span class="chip" onclick="toggleChip(this, 'dislikes', '${o}')">${o}</span>
      `).join('');
      
      document.getElementById('restrictionsChips').innerHTML = restrictionOptions.map(o => `
        <span class="chip" onclick="toggleChip(this, 'restrictions', '${o}')">${o}</span>
      `).join('');
    }
    
    function initExpertGrid() {
      const grid = document.getElementById('expertGrid');
      if (!DATA.personas) return;
      grid.innerHTML = Object.entries(DATA.personas).map(([key, p]) => `
        <div class="expert-card" onclick="selectExpert('${key}')">
          <div class="icon">${p.icon}</div>
          <div class="name">${p.name}</div>
          <div class="credentials">${p.credentials}</div>
          <div class="philosophy">${p.philosophy}</div>
        </div>
      `).join('');
    }
    
    function initStaffingOptions() {
      const container = document.getElementById('staffingOptions');
      if (!DATA.STAFFING) return;
      container.innerHTML = DATA.STAFFING.map(s => `
        <div class="staffing-option ${selectedStaffing === s.id ? 'selected' : ''}" onclick="selectStaffingOption('${s.id}')">
          <span class="icon">${s.icon}</span>
          <div class="info">
            <h4>${s.name}</h4>
            <p>${s.desc}</p>
          </div>
          <div class="time">~${s.activeMin} min<br>active</div>
        </div>
      `).join('');
    }
    
    function initAveryProducts() {
      if (!DATA.AVERY_PRODUCTS) return;
      
      document.getElementById('placeCardProducts').innerHTML = DATA.AVERY_PRODUCTS.placeCards.map(p => `
        <div class="avery-product">
          <div class="info">
            <div class="sku">Avery ${p.sku} ‚Äî ${p.name}</div>
            <div class="details">${p.size} ‚Ä¢ ${p.perSheet}/sheet ‚Ä¢ ${p.desc}</div>
          </div>
          <button class="btn btn-outline" onclick="downloadPrintProduct('placeCards', '${p.sku}')">Download PDF</button>
        </div>
      `).join('');
      
      document.getElementById('menuCardProducts').innerHTML = DATA.AVERY_PRODUCTS.menuCards.map(p => `
        <div class="avery-product">
          <div class="info">
            <div class="sku">Avery ${p.sku} ‚Äî ${p.name}</div>
            <div class="details">${p.size} ‚Ä¢ ${p.perSheet}/sheet</div>
          </div>
          <button class="btn btn-outline" onclick="downloadPrintProduct('menuCards', '${p.sku}')">Download PDF</button>
        </div>
      `).join('');
      
      document.getElementById('invitationProducts').innerHTML = DATA.AVERY_PRODUCTS.invitations.map(p => `
        <div class="avery-product">
          <div class="info">
            <div class="sku">Avery ${p.sku} ‚Äî ${p.name}</div>
            <div class="details">${p.size} ‚Ä¢ ${p.perSheet}/sheet</div>
          </div>
          <button class="btn btn-outline" onclick="downloadPrintProduct('invitations', '${p.sku}')">Download PDF</button>
        </div>
      `).join('');
    }
    
    function initCookbookSections() {
      const container = document.getElementById('cookbookSectionsList');
      if (!DATA.COOKBOOK_SECTIONS) {
        const defaultSections = ['Cover Page', 'Menu Overview', 'Wine Program', 'Complete Recipes', 'Shopping List', 'Day-Before Prep', 'Day-Of Timeline', 'Plating Guides', 'Table Setting', 'Service Notes', 'Ambiance & Music', 'Final Checklist', 'AI Image Prompts', 'Notes Pages', 'Copyright'];
        container.innerHTML = defaultSections.map(s => `<div class="cookbook-section">${s}</div>`).join('');
      } else {
        container.innerHTML = DATA.COOKBOOK_SECTIONS.map(s => `<div class="cookbook-section">${s}</div>`).join('');
      }
    }
    
    // ============================================================
    // NAVIGATION
    // ============================================================
    function goToStep(step) {
      // Update max reached
      if (step > maxStepReached) maxStepReached = step;
      
      // Hide all steps
      for (let i = 1; i <= 7; i++) {
        document.getElementById('step' + i).classList.add('hidden');
      }
      
      // Show target step
      document.getElementById('step' + step).classList.remove('hidden');
      currentStep = step;
      
      // Update progress
      updateProgress();
      updateSectionNav();
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function jumpToStep(step) {
      if (step <= maxStepReached) {
        goToStep(step);
      }
    }
    
    function updateProgress() {
      for (let i = 1; i <= 7; i++) {
        const dot = document.getElementById('dot' + i);
        const line = document.getElementById('line' + i);
        
        dot.classList.remove('active', 'complete');
        if (line) line.classList.remove('complete');
        
        if (i < currentStep) {
          dot.classList.add('complete');
          if (line) line.classList.add('complete');
        } else if (i === currentStep) {
          dot.classList.add('active');
        }
      }
    }

    function slugify(s) {
      return String(s || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '')
        .slice(0, 40) || 'section';
    }

    function updateSectionNav() {
      const nav = document.getElementById('sectionNav');
      if (!nav) return;

      const stepEl = document.getElementById('step' + currentStep);
      if (!stepEl) {
        nav.classList.add('hidden');
        nav.innerHTML = '';
        return;
      }

      const candidates = Array.from(stepEl.querySelectorAll('[data-screen]')).filter((el) => {
        if (el.classList.contains('hidden')) return false;
        // Only include elements actually visible (details counts as visible even if closed, which is fine for Step 1)
        return true;
      });

      // Don‚Äôt show if there's nothing to navigate.
      if (candidates.length <= 1) {
        nav.classList.add('hidden');
        nav.innerHTML = '';
        return;
      }

      const items = candidates.map((el, idx) => {
        const label = el.getAttribute('data-screen') || `Section ${idx + 1}`;
        if (!el.id) el.id = `step${currentStep}-${slugify(label)}-${idx}`;
        return { id: el.id, label };
      });

      nav.classList.remove('hidden');
      nav.innerHTML =
        `<span class="label">On this step</span>` +
        items.map((it, i) => `<button class="section-nav-btn ${i === 0 ? 'active' : ''}" data-target="${it.id}">${escapeHtml(it.label)}</button>`).join('');

      const buttons = Array.from(nav.querySelectorAll('.section-nav-btn'));
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-target');
          const target = id ? document.getElementById(id) : null;
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            buttons.forEach((b) => b.classList.toggle('active', b === btn));
          }
        });
      });
    }
    
    // ============================================================
    // STEP 1: ACCESS CODE
    // ============================================================
    async function validateCode() {
      const code = document.getElementById('accessCode').value.trim();
      const msgEl = document.getElementById('codeMessage');
      
      if (!code) {
        msgEl.innerHTML = '<div class="error-msg">Please enter an access code.</div>';
        return;
      }
      
      try {
        const res = await fetch('/api/validate-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });
        const data = await res.json();
        
        if (data.valid) {
          accessCode = code;
          sessionStorage.setItem('dpp_accessCode', accessCode);
          msgEl.innerHTML = `<div class="success-msg">‚úì Access granted! ${data.remaining ? `(${data.remaining} generations remaining)` : ''}</div>`;
          setTimeout(() => goToStep(2), 800);
        } else {
          msgEl.innerHTML = `<div class="error-msg">${data.message || 'Invalid access code.'}</div>`;
        }
      } catch (err) {
        msgEl.innerHTML = '<div class="error-msg">Connection error. Please try again.</div>';
      }
    }

    async function restoreSession() {
      const saved = sessionStorage.getItem('dpp_accessCode');
      if (!saved) return;
      try {
        const res = await fetch('/api/validate-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: saved })
        });
        const data = await res.json();
        if (data.valid) {
          accessCode = saved;
          document.getElementById('accessCode').value = saved;
          maxStepReached = Math.max(maxStepReached, 2);
          goToStep(2);
        } else {
          sessionStorage.removeItem('dpp_accessCode');
        }
      } catch {
        // If offline, keep them on step 1; they can retry.
      }
    }
    
    // ============================================================
    // STEP 2: STYLES
    // ============================================================
    function selectStyle(id) {
      selectedStyle = id;
      initStyleGrid();
      renderStylePreview();
    }
    
    // ============================================================
    // STEP 3: PREFERENCES
    // ============================================================
    function selectInspiration(id) {
      selectedInspiration = id;
      initInspirationGrid();
      
      // Show custom menu input if "I Already Know" selected
      const customInput = document.getElementById('customMenuInput');
      if (id === 'custom') {
        customInput.classList.remove('hidden');
      } else {
        customInput.classList.add('hidden');
      }
    }
    
    function selectCuisine(key) {
      selectedCuisine = selectedCuisine === key ? null : key;
      selectedSubCuisine = null;
      initCuisineChips();
      updateCuisineSubOptions();
    }
    
    function updateCuisineSubOptions() {
      const container = document.getElementById('cuisineSubOptions');
      
      if (!selectedCuisine || !DATA.CUISINES) {
        container.classList.add('hidden');
        return;
      }
      
      const cuisine = DATA.CUISINES[selectedCuisine];
      let html = '';
      
      if (cuisine.regions) {
        html += '<h4>Regions</h4><div class="chip-group">';
        html += cuisine.regions.map(r => `
          <span class="chip ${selectedSubCuisine === r ? 'selected' : ''}" onclick="selectSubCuisine('${r}')">${r}</span>
        `).join('');
        html += '</div>';
      }
      
      if (cuisine.styles) {
        html += '<h4 style="margin-top:1rem">Styles</h4><div class="chip-group">';
        html += cuisine.styles.map(s => `
          <span class="chip ${selectedSubCuisine === s ? 'selected' : ''}" onclick="selectSubCuisine('${s}')">${s}</span>
        `).join('');
        html += '</div>';
      }
      
      if (cuisine.countries) {
        html += '<h4>Countries</h4><div class="chip-group">';
        html += Object.entries(cuisine.countries).map(([k, c]) => `
          <span class="chip ${selectedSubCuisine === c.label ? 'selected' : ''}" onclick="selectSubCuisineCountry('${k}', '${c.label}')">${c.label}</span>
        `).join('');
        html += '</div>';
        
        // Show regions for selected country
        const selectedCountryKey = Object.keys(cuisine.countries).find(k => cuisine.countries[k].label === selectedSubCuisine);
        if (selectedCountryKey) {
          const country = cuisine.countries[selectedCountryKey];
          if (country.regions) {
            html += '<h4 style="margin-top:1rem">Regions</h4><div class="chip-group">';
            html += country.regions.map(r => `
              <span class="chip" onclick="selectSubCuisine('${selectedSubCuisine} ‚Äî ${r}')">${r}</span>
            `).join('');
            html += '</div>';
          }
        }
      }
      
      container.innerHTML = html;
      container.classList.remove('hidden');
    }
    
    function selectSubCuisine(value) {
      selectedSubCuisine = value;
      updateCuisineSubOptions();
    }
    
    function selectSubCuisineCountry(key, label) {
      selectedSubCuisine = label;
      updateCuisineSubOptions();
    }
    
    function toggleChip(el, category, value) {
      el.classList.toggle('selected');
      const arr = category === 'likes' ? likes : category === 'dislikes' ? dislikes : restrictions;
      const idx = arr.indexOf(value);
      if (idx > -1) {
        arr.splice(idx, 1);
      } else {
        arr.push(value);
      }
    }
    
    // ============================================================
    // STEP 4: EXPERT CONSULTATION
    // ============================================================
    function selectExpert(key) {
      selectedExpert = key;
      const persona = DATA.personas[key];
      
      // Update expert cards
      document.querySelectorAll('.expert-card').forEach((card, i) => {
        const cardKey = Object.keys(DATA.personas)[i];
        card.classList.toggle('selected', cardKey === key);
      });
      
      // Show chat section
      document.getElementById('chatSection').classList.remove('hidden');
      document.getElementById('chatIcon').textContent = persona.icon;
      document.getElementById('chatName').textContent = persona.name;
      
      // Initialize chat with greeting
      chatHistory = [];
      const greeting = getExpertGreeting(key);
      chatHistory.push({ role: 'assistant', content: greeting });
      renderChat();
    }
    
    function getExpertGreeting(key) {
      const eventTitle = document.getElementById('eventTitle').value || 'your dinner party';
      const guestCount = document.getElementById('guestCount').value;
      const inspiration = DATA.MENU_INSPIRATIONS?.find(i => i.id === selectedInspiration)?.title || 'special';
      
      const greetings = {
        chef: `Hi ‚Äî I‚Äôm your Chef for ${eventTitle}. How can I help?`,
        sommelier: `What a pleasure to help with ${eventTitle}! Before we discuss wines, tell me about your guests. Are they adventurous with wine, or do they prefer familiar favorites? And is there a memorable bottle you've shared before that we might echo?`,
        instructor: `Hello! I'm here to make sure ${eventTitle} runs smoothly for your ${guestCount} guests. First, tell me about your kitchen setup and how much time you'll have for prep. What's your biggest concern about executing this dinner?`,
        all: `Welcome! The three of us are excited to help plan ${eventTitle}.\n\n**Chef:** Let's start with your vision ‚Äî what flavors are you craving?\n\n**Sommelier:** I'll ensure every course has the perfect pour.\n\n**Instructor:** And I'll make sure you can execute it all calmly.\n\nWhat would you like to discuss first?`,
        photographer: `Hello! I'm here to help you capture beautiful images of ${eventTitle}. First question: would you like me to create image prompts based on YOUR dining room and what you already have, or shall I propose an ideal setting?\n\nIf you'd like prompts tailored to your space, tell me about your dining room ‚Äî the table shape, wood tone, wall colors, lighting, and any special pieces you'd like featured.`,
        tablescaper: `Welcome! I'm so excited to help stage ${eventTitle} for ${guestCount} guests. The table is your stage before a single dish arrives ‚Äî it sets the entire mood.\n\nTell me about your space: What's your table shape and size? Do you have existing linens, chargers, or centerpiece vessels you'd like to incorporate? And what feeling do you want guests to have when they first see the table?`,
        plating: `Hello! I'm here to help your dishes look as extraordinary as they taste at ${eventTitle}. Every plate is a composition ‚Äî and I'll help you think like a professional.\n\nFirst, tell me about your plating experience. Are you comfortable with tweezers and squeeze bottles, or would you prefer techniques that are elegant but approachable? And do you have rimmed or rimless plates?`
      };
      
      return greetings[key] || greetings.chef;
    }
    
    function renderChat() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = chatHistory.map(msg => `
        <div class="chat-message ${msg.role}">
          <div class="bubble">${formatChatMessage(msg.content)}</div>
        </div>
      `).join('');
      container.scrollTop = container.scrollHeight;
    }
    
    function formatChatMessage(content) {
      return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    }
    
    async function sendChat() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;
      
      chatHistory.push({ role: 'user', content: message });
      input.value = '';
      renderChat();
      
      // Typing indicator
      chatHistory.push({ role: 'assistant', content: '...' });
      renderChat();
      setStatus('expert', 'thinking');
      
      try {
        const menuForChat = (selectedMenu !== null && menus && menus[selectedMenu]) ? menus[selectedMenu] : null;
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: accessCode,
            persona: selectedExpert,
            messages: chatHistory.slice(0, -1),
            context: getContext(),
            menu: menuForChat
          })
        });
        const data = await res.json();
        
        chatHistory[chatHistory.length - 1] = { role: 'assistant', content: data.response || 'Please try again.' };
        renderChat();
        if (voiceEnabled('expertVoiceToggle')) {
          const role = (selectedExpert === 'sommelier') ? 'sommelier' : (selectedExpert === 'chef' ? 'chef' : 'planner');
          setStatus('expert', 'speaking');
          speaking.expert = true;
          await speak(chatHistory[chatHistory.length - 1].content, role);
          speaking.expert = false;
          setStatus('expert', handsFreeOn('expert') ? 'listening' : 'idle');
        } else if (handsFreeOn('expert')) {
          // Hands-free without voice still cycles listening.
          setStatus('expert', 'listening');
        } else {
          setStatus('expert', 'idle');
        }
        await resumeHandsFree('expert');
      } catch (err) {
        chatHistory[chatHistory.length - 1] = { role: 'assistant', content: 'Connection error. Please try again.' };
        renderChat();
        setStatus('expert', 'idle');
      }
    }

    // =========================
    // Sommelier chat (Step 6)
    // =========================
    function initSommChat() {
      sommHistory = [{
        role: 'assistant',
        content: "I‚Äôm your Sommelier. Once you‚Äôve chosen a menu, ask me how to serve it: order, temps, decanting, glassware, and cocktails/mocktails."
      }];
      renderSommChat();
    }

    function renderSommChat() {
      const container = document.getElementById('sommMessages');
      if (!container) return;
      sommHistory = sommHistory.slice(-40);
      container.innerHTML = sommHistory.map(msg => `
        <div class="chat-message ${msg.role}">
          <div class="bubble">${formatChatMessage(msg.content)}</div>
        </div>
      `).join('');
      container.scrollTop = container.scrollHeight;
    }

    async function sendSommChat() {
      const input = document.getElementById('sommInput');
      const message = (input?.value || '').trim();
      if (!message) return;
      sommHistory.push({ role: 'user', content: message });
      input.value = '';
      renderSommChat();

      sommHistory.push({ role: 'assistant', content: '...' });
      renderSommChat();
      setStatus('somm', 'thinking');

      try {
        const menuForChat = (selectedMenu !== null && menus && menus[selectedMenu]) ? menus[selectedMenu] : null;
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            persona: 'sommelier',
            messages: sommHistory.slice(0, -1),
            context: getContext(),
            menu: menuForChat
          })
        });
        const data = await res.json();
        const reply = data.response || 'Please try again.';
        sommHistory[sommHistory.length - 1] = { role: 'assistant', content: reply };
        renderSommChat();
        if (voiceEnabled('sommVoiceToggle') || handsFreeOn('somm')) {
          setStatus('somm', 'speaking');
          speaking.somm = true;
          await speak(reply, 'sommelier');
          speaking.somm = false;
          setStatus('somm', handsFreeOn('somm') ? 'listening' : 'idle');
        } else {
          setStatus('somm', 'idle');
        }
        await resumeHandsFree('somm');
      } catch {
        sommHistory[sommHistory.length - 1] = { role: 'assistant', content: 'Connection error. Please try again.' };
        renderSommChat();
        setStatus('somm', 'idle');
      }
    }

    async function toggleSommMic() {
      if (!speech.somm) return startRoleMic('somm', { ensurePermission: true });
      stopRoleMic('somm');
      const cfg = ROLE_CFG.somm;
      if (cfg) setChecked(cfg.handsFreeId, false);
      setMicUi('somm', false);
      setStatus('somm', 'idle');
    }
    
    function getContext() {
      return {
        eventTitle: document.getElementById('eventTitle').value,
        eventDate: document.getElementById('eventDate').value,
        guestCount: document.getElementById('guestCount').value,
        guestList: document.getElementById('guestList').value,
        guests: guests,
        serviceTime: document.getElementById('serviceTime').value,
        foodBudget: document.getElementById('foodBudget').value,
        wineBudget: document.getElementById('wineBudget').value,
        skillLevel: document.getElementById('skillLevel').value,
        menuStyle: selectedStyle,
        inspiration: selectedInspiration,
        cuisine: selectedCuisine,
        subCuisine: selectedSubCuisine,
        likes: likes,
        dislikes: dislikes,
        restrictions: restrictions
      };
    }

    function normalizeTitle(name) {
      const s = (name || '').trim();
      const lowered = s.toLowerCase();
      const titles = ['dr.', 'dr', 'mr.', 'mr', 'mrs.', 'mrs', 'ms.', 'ms', 'prof.', 'prof', 'rev.', 'rev', 'hon.', 'hon'];
      const hit = titles.find(t => lowered.startsWith(t + ' '));
      if (!hit) return null;
      if (hit.startsWith('dr')) return 'Dr.';
      if (hit.startsWith('mr')) return 'Mr.';
      if (hit.startsWith('mrs')) return 'Mrs.';
      if (hit.startsWith('ms')) return 'Ms.';
      if (hit.startsWith('prof')) return 'Prof.';
      if (hit.startsWith('rev')) return 'Rev.';
      if (hit.startsWith('hon')) return 'Hon.';
      return null;
    }

    function stripTitle(name) {
      const t = normalizeTitle(name);
      if (!t) return (name || '').trim();
      return (name || '').trim().replace(new RegExp('^' + t.replace('.', '\\\\.') + '\\\\s+', 'i'), '');
    }

    function parseGuestLine(line) {
      const raw = (line || '').trim();
      if (!raw) return null;

      // Couples: "Fred/Alice Smith", "Fred & Alice Smith"
      const coupleMatch = raw.match(/^(.+?)(?:\s*\/\s*|\s*&\s*)(.+)$/);
      if (coupleMatch) {
        const left = coupleMatch[1].trim();
        const right = coupleMatch[2].trim();
        const leftNoTitle = stripTitle(left);
        const rightNoTitle = stripTitle(right);
        // If right contains a last name and left doesn't, assume shared last name from right.
        const rightParts = rightNoTitle.split(/\s+/).filter(Boolean);
        const leftParts = leftNoTitle.split(/\s+/).filter(Boolean);
        const rightLast = rightParts.length > 1 ? rightParts[rightParts.length - 1] : null;
        const leftHasLast = leftParts.length > 1;
        const leftFirst = leftParts[0] || leftNoTitle;
        const rightFirst = rightParts[0] || rightNoTitle;
        const lastName = rightLast && !leftHasLast ? rightLast : null;

        const display = lastName ? `${leftFirst} & ${rightFirst} ${lastName}` : `${leftFirst} & ${rightFirst}`;
        return {
          raw,
          name: display,
          addressing: 'first',
          title: null,
          dietaryConcern: false
        };
      }

      const title = normalizeTitle(raw);
      const name = raw;
      // Default addressing: if title present, use title; else first names for friendliness.
      return {
        raw,
        name,
        addressing: title ? 'title' : 'first',
        title: title,
        dietaryConcern: false
      };
    }

    function displayNameForGuest(g) {
      const name = (g?.name || '').trim();
      const addressing = g?.addressing || 'first';
      const title = g?.title || normalizeTitle(name);
      const nameNoTitle = stripTitle(name);
      const parts = nameNoTitle.split(/\s+/).filter(Boolean);
      const first = parts[0] || nameNoTitle;
      const last = parts.length > 1 ? parts[parts.length - 1] : '';

      if (addressing === 'first') return first || name;
      if (addressing === 'full') return nameNoTitle || name;
      if (addressing === 'title') {
        const t = title || 'Mr./Ms.';
        return last ? `${t} ${last}` : `${t} ${nameNoTitle || name}`;
      }
      if (addressing === 'custom') return name || '';
      return name || '';
    }

    function rebuildGuests() {
      const count = parseInt(document.getElementById('guestCount').value || '6', 10) || 6;
      const lines = String(document.getElementById('guestList').value || '')
        .split('\\n')
        .map(s => s.trim())
        .filter(Boolean);

      const parsed = lines.map(parseGuestLine).filter(Boolean);

      // Preserve existing edits where possible by index.
      const next = [];
      for (let i = 0; i < count; i++) {
        const existing = guests[i];
        const fromLine = parsed[i];
        const base = fromLine || { raw: '', name: `Guest-${i + 1}`, addressing: 'first', title: null, dietaryConcern: false };
        next[i] = {
          ...base,
          // preserve user edits
          name: existing?.name && existing?.name !== `Guest-${i + 1}` ? existing.name : base.name,
          addressing: existing?.addressing || base.addressing,
          title: existing?.title ?? base.title,
          dietaryConcern: typeof existing?.dietaryConcern === 'boolean' ? existing.dietaryConcern : base.dietaryConcern
        };
      }
      guests = next.map(g => ({
        ...g,
        displayName: displayNameForGuest(g)
      }));
      renderGuestDetails();
    }

    function renderGuestDetails() {
      const container = document.getElementById('guestDetails');
      if (!container) return;
      container.innerHTML = `
        <div style="display:grid;gap:0.5rem">
          ${guests.map((g, i) => `
            <div style="display:grid;grid-template-columns: 1.2fr 0.8fr 0.7fr;gap:0.6rem;align-items:center;padding:0.6rem;border:1px solid var(--cream-dark);border-radius:10px;background:white;">
              <div>
                <div style="font-size:0.8rem;color:var(--text-light);margin-bottom:0.2rem;">Guest ${i + 1}</div>
                <input type="text" value="${(g.name || '').replace(/\"/g,'&quot;')}" oninput="updateGuestName(${i}, this.value)" />
                <div style="font-size:0.8rem;color:var(--text-light);margin-top:0.25rem;">Place card: <strong>${(g.displayName || '').replace(/</g,'&lt;')}</strong></div>
              </div>
              <div>
                <div style="font-size:0.8rem;color:var(--text-light);margin-bottom:0.2rem;">Addressing</div>
                <select onchange="updateGuestAddressing(${i}, this.value)">
                  <option value="first" ${g.addressing==='first'?'selected':''}>First name</option>
                  <option value="title" ${g.addressing==='title'?'selected':''}>Title + last</option>
                  <option value="full" ${g.addressing==='full'?'selected':''}>Full name</option>
                  <option value="custom" ${g.addressing==='custom'?'selected':''}>Custom</option>
                </select>
              </div>
              <div>
                <div style="font-size:0.8rem;color:var(--text-light);margin-bottom:0.2rem;">Dietary concern</div>
                <label style="display:flex;gap:0.5rem;align-items:center;">
                  <input type="checkbox" ${g.dietaryConcern ? 'checked' : ''} onchange="updateGuestDietary(${i}, this.checked)" />
                  <span>${g.dietaryConcern ? 'Yes' : 'No'}</span>
                </label>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function updateGuestName(i, value) {
      guests[i].name = value;
      guests[i].title = normalizeTitle(value) || guests[i].title;
      guests[i].displayName = displayNameForGuest(guests[i]);
      renderGuestDetails();
    }
    function updateGuestAddressing(i, value) {
      guests[i].addressing = value;
      guests[i].displayName = displayNameForGuest(guests[i]);
      renderGuestDetails();
    }
    function updateGuestDietary(i, checked) {
      guests[i].dietaryConcern = !!checked;
      renderGuestDetails();
    }
    
    function endChat() {
      document.getElementById('chatSection').classList.add('hidden');
      selectedExpert = null;
      document.querySelectorAll('.expert-card').forEach(c => c.classList.remove('selected'));
    }
    
    function skipConsultation() {
      proceedToMenus();
    }
    
    async function proceedToMenus() {
      goToStep(5);
      await generateMenus();
    }
    
    // ============================================================
    // STEP 5: MENU SELECTION
    // ============================================================
    async function generateMenus() {
      document.getElementById('menuLoading').classList.remove('hidden');
      document.getElementById('menuList').innerHTML = '';
      document.getElementById('menuActions').classList.add('hidden');
      document.getElementById('rejectionChat').classList.add('hidden');
      
      try {
        const res = await fetch('/api/generate-menus', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: accessCode,
            context: getContext(),
            chatHistory: chatHistory,
            rejectionHistory: rejectionHistory
          })
        });
        const data = await res.json();
        
        document.getElementById('menuLoading').classList.add('hidden');
        
        if (data.menus && data.menus.length > 0) {
          menus = data.menus;
          renderMenus();
          document.getElementById('menuActions').classList.remove('hidden');
        } else {
          document.getElementById('menuList').innerHTML = '<div class="error-msg">Unable to generate menus. Please try again.</div>';
        }
      } catch (err) {
        document.getElementById('menuLoading').classList.add('hidden');
        document.getElementById('menuList').innerHTML = '<div class="error-msg">Connection error. Please try again.</div>';
      }
    }
    
    function renderMenus() {
      const container = document.getElementById('menuList');
      container.innerHTML = menus.map((menu, i) => `
        <div class="menu-card ${selectedMenu === i ? 'selected' : ''}" onclick="highlightMenu(${i})">
          <div class="menu-header">
            <div class="title">${menu.title}</div>
            <div class="cost-badge">${menu.foodCost}</div>
          </div>
          <div class="personality">${menu.personality}</div>
          <div class="courses">
            ${menu.courses.map(c => `
              <div class="course">
                <span class="course-type">${c.type}</span>
                <span class="course-name">${c.name}</span>
                ${c.wine ? `<span class="course-wine">üç∑ ${c.wine}</span>` : ''}
              </div>
            `).join('')}
          </div>
          <div style="margin-top:0.75rem;font-size:0.9rem;color:var(--gold-dark)">Wine: ${menu.wineCost}</div>
          ${selectedMenu === i && wineTiers ? `
            <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--cream-dark);font-size:0.92rem">
              <div style="font-weight:600;color:var(--navy);margin-bottom:0.5rem">Beverage options</div>
              ${wineTiers.alcoholAllowed === false ? `<div style="color:var(--text-light);font-style:italic;margin-bottom:0.6rem">Alcohol is disabled for this context (e.g., Ramadan/Halal). Showing mocktails; wine tiers omitted.</div>` : ''}
              ${wineTiers.eventBeverages ? `
                <div style="margin-bottom:0.75rem">
                  <div style="font-weight:600;color:var(--gold-dark)">Welcome</div>
                  ${wineTiers.eventBeverages.welcomeCocktail ? `<div><strong>Cocktail:</strong> ${wineTiers.eventBeverages.welcomeCocktail}</div>` : ''}
                  ${wineTiers.eventBeverages.welcomeMocktail ? `<div><strong>Mocktail:</strong> ${wineTiers.eventBeverages.welcomeMocktail}</div>` : ''}
                </div>
              ` : ''}
              ${(wineTiers.courses || []).filter(x => x.selectedWine || x.type).map(x => `
                <div style="margin-bottom:0.75rem">
                  <div style="font-weight:600;color:var(--gold-dark)">${x.type}: <span style="font-weight:400;color:var(--text)">${x.selectedWine || '‚Äî'}</span></div>
                  ${x.cocktail ? `<div style="margin-top:0.25rem"><strong>Cocktail:</strong> ${x.cocktail.name}${x.cocktail.notes ? ` ‚Äî <span style="color:var(--text-light)">${x.cocktail.notes}</span>` : ''}</div>` : ''}
                  ${x.mocktail ? `<div style="margin-top:0.25rem"><strong>Mocktail:</strong> ${x.mocktail.name}${x.mocktail.notes ? ` ‚Äî <span style="color:var(--text-light)">${x.mocktail.notes}</span>` : ''}</div>` : ''}
                  <div style="margin-top:0.35rem;display:grid;gap:0.35rem">
                    ${['topShelf','under80','under20','bond'].map(k => {
                      const t = x.tiers?.[k];
                      if (!t) return '';
                      if (wineTiers.alcoholAllowed === false) return '';
                      const q = encodeURIComponent(t.vivinoQuery || t.wine || '');
                      const link = q ? `https://www.vivino.com/search/wines?q=${q}` : '';
                      return `<div><strong>${t.title}:</strong> ${t.wine}${t.notes ? ` ‚Äî <span style="color:var(--text-light)">${t.notes}</span>` : ''}${link ? ` ‚Äî <a href="${link}" target="_blank" rel="noopener noreferrer">Vivino search</a>` : ''}</div>`;
                    }).join('')}
                  </div>
                </div>
              `).join('')}
              ${wineTiers.disclaimer ? `<div style="color:var(--text-light);font-style:italic">${wineTiers.disclaimer}</div>` : ''}
            </div>
          ` : ''}
        </div>
      `).join('');
    }
    
    function highlightMenu(index) {
      selectedMenu = index;
      wineTiers = null;
      renderMenus();
      document.getElementById('selectMenuBtn').disabled = false;
    }

    async function loadWineTiers() {
      if (selectedMenu === null) return;
      if (wineTiersLoading) return;
      wineTiersLoading = true;
      try {
        const res = await fetch('/api/wine-tiers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: accessCode,
            menu: menus[selectedMenu],
            context: getContext(),
            chatHistory: chatHistory
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Wine tiers failed');
        wineTiers = data;
        renderMenus();
      } catch (e) {
        alert('Error generating wine tiers. Please try again.');
      } finally {
        wineTiersLoading = false;
      }
    }
    
    function selectMenu() {
      if (selectedMenu === null) return;
      
      const menu = menus[selectedMenu];
      document.getElementById('selectedMenuSummary').innerHTML = `
        <div style="font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--navy);margin-bottom:0.5rem">${menu.title}</div>
        <div style="font-style:italic;color:var(--text-light);margin-bottom:1rem">${menu.personality}</div>
        ${menu.courses.map(c => `
          <div style="padding:0.4rem 0;font-size:0.95rem;display:flex;gap:0.75rem">
            <strong style="color:var(--gold-dark);min-width:100px">${c.type}:</strong>
            <span>${c.name}</span>
          </div>
        `).join('')}
        <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--cream-dark);font-size:0.9rem;color:var(--text-light)">
          Food: ${menu.foodCost} | Wine: ${menu.wineCost}
        </div>
      `;
      
      goToStep(6);
    }
    
    function rejectMenus() {
      document.getElementById('menuActions').classList.add('hidden');
      document.getElementById('rejectionChat').classList.remove('hidden');
      
      rejectionHistory = [{
        role: 'assistant',
        content: rejectionHistory.length === 0 
          ? "I sense none of these hit the mark. Help me understand ‚Äî what did you imagine when you first thought about this dinner? Was there a dish, an ingredient, or a moment you were hoping to create?"
          : "I hear you. Let's dig deeper. Tell me about your guests ‚Äî what would make them feel truly celebrated? Sometimes the best menus come from understanding the people around the table."
      }];
      renderRejectionChat();
    }
    
    function renderRejectionChat() {
      const container = document.getElementById('rejectionMessages');
      container.innerHTML = rejectionHistory.map(msg => `
        <div class="chat-message ${msg.role}">
          <div class="bubble">${formatChatMessage(msg.content)}</div>
        </div>
      `).join('');
      container.scrollTop = container.scrollHeight;
    }
    
    async function sendRejection() {
      const input = document.getElementById('rejectionInput');
      const message = input.value.trim();
      if (!message) return;
      
      rejectionHistory.push({ role: 'user', content: message });
      input.value = '';
      renderRejectionChat();
      
      rejectionHistory.push({ role: 'assistant', content: '...' });
      renderRejectionChat();
      
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: accessCode,
            persona: 'chef',
            messages: rejectionHistory.slice(0, -1),
            context: getContext()
          })
        });
        const data = await res.json();
        
        rejectionHistory[rejectionHistory.length - 1] = { 
          role: 'assistant', 
          content: data.response || "I understand. Tell me more about what you're envisioning..." 
        };
        renderRejectionChat();
      } catch (err) {
        rejectionHistory[rejectionHistory.length - 1] = { 
          role: 'assistant', 
          content: "I hear you. Tell me more about your vision for this dinner." 
        };
        renderRejectionChat();
      }
    }
    
    async function regenerateMenus() {
      document.getElementById('rejectionChat').classList.add('hidden');
      selectedMenu = null;
      await generateMenus();
    }
    
    // ============================================================
    // STEP 6: STAFFING
    // ============================================================
    function selectStaffingOption(id) {
      selectedStaffing = id;
      initStaffingOptions();
    }

    function selectCookbookFormat(value) {
      selectedCookbookFormat = value || 'binder';
    }
    
    // ============================================================
    // STEP 7: COOKBOOK
    // ============================================================
    async function generateCookbook() {
      goToStep(7);
      document.getElementById('cookbookLoading').classList.remove('hidden');
      document.getElementById('cookbookComplete').classList.add('hidden');
      
      try {
        const res = await fetch('/api/generate-cookbook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: accessCode,
            menu: menus[selectedMenu],
            context: getContext(),
            staffing: selectedStaffing,
            chatHistory: chatHistory,
            format: selectedCookbookFormat
          })
        });
        const data = await res.json();
        
        document.getElementById('cookbookLoading').classList.add('hidden');
        
        if (data.success) {
          cookbookId = data.cookbookId;
          document.getElementById('cookbookComplete').classList.remove('hidden');
        } else {
          document.getElementById('cookbookComplete').innerHTML = `<div class="error-msg">${data.message || 'Error generating cookbook.'}</div>`;
          document.getElementById('cookbookComplete').classList.remove('hidden');
        }
      } catch (err) {
        document.getElementById('cookbookLoading').classList.add('hidden');
        document.getElementById('cookbookComplete').innerHTML = '<div class="error-msg">Connection error. Please try again.</div>';
        document.getElementById('cookbookComplete').classList.remove('hidden');
      }
    }
    
    async function downloadCookbook() {
      try {
        const res = await fetch('/api/download-cookbook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: accessCode,
            cookbookId: cookbookId
          })
        });
        
        if (res.ok) {
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const eventTitle = document.getElementById('eventTitle').value || 'Dinner_Party';
          a.download = eventTitle.replace(/[^a-zA-Z0-9]/g, '_') + '_Cookbook.docx';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } else {
          alert('Error downloading cookbook. Please try again.');
        }
      } catch (err) {
        alert('Connection error. Please try again.');
      }
    }

    function viewCookbookHtml() {
      if (!cookbookId) {
        alert('Cookbook not ready yet.');
        return;
      }
      window.open(`/cookbook/${cookbookId}`, '_blank', 'noopener,noreferrer');
    }
    
    function downloadPrintProduct(type, sku) {
      if (!cookbookId) {
        alert('Generate your cookbook first.');
        return;
      }
      // Download as a file via POST -> blob
      fetch('/api/print-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cookbookId, type, sku })
      }).then(async (res) => {
        if (!res.ok) throw new Error('PDF generation failed');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Avery_${sku}_${type}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }).catch(() => {
        alert('Error generating PDF. Please try again.');
      });
    }
    
    function startOver() {
      selectedMenu = null;
      menus = [];
      chatHistory = [];
      rejectionHistory = [];
      cookbookId = null;
      maxStepReached = 2;
      goToStep(2);
    }
  </script>
</body>
</html>
