<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dinner Party Planner</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --navy: #1E3A5F;
      --gold: #C9A227;
      --green: #2D6A4F;
      --cream: #FDF8F3;
      --gray: #6B7C85;
      --light: #F5F5F0;
    }
    
    body {
      font-family: 'Georgia', serif;
      background: var(--cream);
      color: #333;
      line-height: 1.6;
    }
    
    /* Login Screen */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
      width: 100%;
    }
    
    .login-box h1 { color: var(--navy); margin-bottom: 10px; }
    .login-box .subtitle { color: var(--gray); margin-bottom: 30px; }
    .login-box .beta-badge {
      display: inline-block;
      background: var(--gold);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      margin-bottom: 20px;
    }
    
    .login-box input {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: center;
      font-family: monospace;
      letter-spacing: 2px;
    }
    
    .login-box input:focus {
      outline: none;
      border-color: var(--green);
    }
    
    .login-box button {
      width: 100%;
      padding: 14px;
      background: var(--green);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 15px;
    }
    
    .login-box button:hover { background: #245a40; }
    
    .login-error {
      color: #c0392b;
      margin-top: 15px;
      font-size: 14px;
    }
    
    .login-info {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      font-size: 13px;
      color: var(--gray);
    }
    
    /* Main App */
    .app-container {
      display: none;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .app-container.active { display: block; }
    
    /* Header */
    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 2px solid var(--navy);
      margin-bottom: 30px;
    }
    
    header h1 { color: var(--navy); font-size: 28px; }
    header .tagline { color: var(--gold); font-size: 14px; margin-top: 5px; }
    
    .usage-badge {
      display: inline-block;
      background: var(--light);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--gray);
      margin-top: 10px;
    }
    
    /* Progress Steps */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 0 10px;
    }
    
    .progress-step {
      flex: 1;
      text-align: center;
      padding: 10px 5px;
      font-size: 12px;
      color: var(--gray);
      border-bottom: 3px solid #ddd;
      cursor: pointer;
    }
    
    .progress-step.active {
      color: var(--green);
      border-color: var(--green);
      font-weight: bold;
    }
    
    .progress-step.completed {
      color: var(--navy);
      border-color: var(--navy);
    }
    
    /* Wizard Steps */
    .wizard-step {
      display: none;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .wizard-step.active { display: block; }
    
    .wizard-step h2 {
      color: var(--navy);
      margin-bottom: 20px;
      font-size: 22px;
    }
    
    /* Form Elements */
    label {
      display: block;
      margin-bottom: 15px;
    }
    
    label span {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-family: inherit;
      border: 2px solid #ddd;
      border-radius: 8px;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--green);
    }
    
    textarea { resize: vertical; min-height: 100px; }
    
    /* Selection Cards */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .selection-card {
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .selection-card:hover { border-color: var(--gray); }
    .selection-card.selected {
      border-color: var(--green);
      background: #f0f7f4;
    }
    
    .selection-card h4 { color: var(--navy); margin-bottom: 5px; }
    .selection-card p { font-size: 13px; color: var(--gray); }
    
    /* Menu Options */
    .menu-option {
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 10px;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .menu-option:hover { border-color: var(--gray); }
    .menu-option.selected {
      border-color: var(--green);
      background: #f0f7f4;
    }
    
    .menu-option h3 {
      color: var(--navy);
      display: flex;
      justify-content: space-between;
    }
    
    .menu-option .cost { color: var(--green); font-weight: normal; }
    .menu-option .theme { color: var(--gray); font-size: 14px; margin: 5px 0 10px; }
    .menu-option .courses { font-size: 13px; line-height: 1.8; }
    .menu-option .course-type { color: var(--gold); font-weight: bold; }
    
    /* Buttons */
    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }
    
    .btn {
      flex: 1;
      padding: 14px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
    }
    
    .btn-primary {
      background: var(--green);
      color: white;
    }
    
    .btn-primary:hover { background: #245a40; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    
    .btn-secondary {
      background: var(--light);
      color: var(--navy);
    }
    
    .btn-secondary:hover { background: #e5e5e0; }
    
    .btn-generate {
      background: var(--navy);
      color: white;
      padding: 16px 30px;
      font-size: 18px;
    }
    
    .btn-generate:hover { background: #152d4a; }
    
    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }
    
    .loading .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #ddd;
      border-top-color: var(--green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Cookbook Output */
    .cookbook-preview {
      background: var(--light);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .cookbook-preview h3 { color: var(--navy); margin-bottom: 15px; }
    
    .cookbook-section {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .cookbook-section h4 {
      color: var(--green);
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .cookbook-section p {
      font-size: 13px;
      color: var(--gray);
      margin: 3px 0;
    }
    
    .download-btn {
      display: block;
      width: 100%;
      padding: 16px;
      background: var(--navy);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .download-btn:hover { background: #152d4a; }
    
    /* Logout */
    .logout-btn {
      position: fixed;
      top: 15px;
      right: 15px;
      padding: 8px 15px;
      background: transparent;
      border: 1px solid var(--gray);
      border-radius: 20px;
      font-size: 12px;
      color: var(--gray);
      cursor: pointer;
    }
    
    .logout-btn:hover { background: var(--light); }
    
    /* Info Boxes */
    .info-box {
      background: #E8F4F8;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
    }
    
    .info-box.warning {
      background: #FFF3CD;
      color: #856404;
    }
    
    /* Responsive */
    @media (max-width: 600px) {
      .card-grid { grid-template-columns: 1fr; }
      .btn-row { flex-direction: column; }
      .progress-step { font-size: 10px; padding: 8px 2px; }
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <div class="beta-badge">BETA</div>
      <h1>üçΩÔ∏è Dinner Party Planner</h1>
      <p class="subtitle">Professional cookbook generator</p>
      
      <input type="text" id="accessCodeInput" placeholder="Enter access code" maxlength="20">
      <button onclick="validateAccess()">Enter</button>
      
      <div id="loginError" class="login-error" style="display:none"></div>
      
      <div class="login-info">
        Beta testers: Enter the access code provided to you.
      </div>
    </div>
  </div>
  
  <!-- MAIN APP -->
  <div id="appContainer" class="app-container">
    <button class="logout-btn" onclick="logout()">Logout</button>
    
    <header>
      <h1>üçΩÔ∏è Dinner Party Planner</h1>
      <p class="tagline">French Portions ‚Ä¢ Make-Ahead Optimized ‚Ä¢ Professional Cookbook</p>
      <div id="usageBadge" class="usage-badge"></div>
    </header>
    
    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-step active" data-step="1">‚ë† Event</div>
      <div class="progress-step" data-step="2">‚ë° Preferences</div>
      <div class="progress-step" data-step="3">‚ë¢ Menu</div>
      <div class="progress-step" data-step="4">‚ë£ Timeline</div>
      <div class="progress-step" data-step="5">‚ë§ Cookbook</div>
    </div>
    
    <!-- STEP 1: Event Details -->
    <div id="step1" class="wizard-step active">
      <h2>‚ë† Event Details</h2>
      
      <label>
        <span>Event Name</span>
        <input type="text" id="eventTitle" value="Dinner Party" placeholder="e.g., Anniversary Dinner">
      </label>
      
      <label>
        <span>Date</span>
        <input type="date" id="eventDate">
      </label>
      
      <label>
        <span>Service Time</span>
        <input type="time" id="eventTime" value="19:00">
      </label>
      
      <label>
        <span>Number of Guests</span>
        <select id="guestCount">
          <option value="4">4 guests</option>
          <option value="6" selected>6 guests</option>
          <option value="8">8 guests</option>
          <option value="10">10 guests</option>
          <option value="12">12 guests</option>
        </select>
      </label>
      
      <label>
        <span>Guest Names (optional, one per line)</span>
        <textarea id="guestList" placeholder="John & Jane Smith&#10;Michael Brown&#10;..."></textarea>
      </label>
      
      <div class="btn-row">
        <button class="btn btn-primary" onclick="goToStep(2)">Continue ‚Üí</button>
      </div>
    </div>
    
    <!-- STEP 2: Preferences -->
    <div id="step2" class="wizard-step">
      <h2>‚ë° Your Preferences</h2>
      
      <label>
        <span>Budget (per person, food only)</span>
        <select id="budgetTier">
          <option value="$15-25">$15-25 (casual)</option>
          <option value="$30-50" selected>$30-50 (nice dinner)</option>
          <option value="$60-100">$60-100 (special occasion)</option>
          <option value="$100+">$100+ (luxury)</option>
        </select>
      </label>
      
      <label>
        <span>Your Cooking Skill</span>
        <select id="skillLevel">
          <option value="beginner">Beginner ‚Äî clear instructions please</option>
          <option value="intermediate" selected>Intermediate ‚Äî comfortable in kitchen</option>
          <option value="advanced">Advanced ‚Äî bring on the challenge</option>
        </select>
      </label>
      
      <label>
        <span>Cuisine Preferences</span>
        <div class="card-grid" id="cuisineGrid">
          <div class="selection-card" data-cuisine="French" onclick="toggleCuisine(this)">
            <h4>üá´üá∑ French</h4>
            <p>Classic techniques, elegant</p>
          </div>
          <div class="selection-card" data-cuisine="Italian" onclick="toggleCuisine(this)">
            <h4>üáÆüáπ Italian</h4>
            <p>Rustic warmth, fresh flavors</p>
          </div>
          <div class="selection-card" data-cuisine="American" onclick="toggleCuisine(this)">
            <h4>üá∫üá∏ American</h4>
            <p>Steakhouse, regional</p>
          </div>
          <div class="selection-card" data-cuisine="Mediterranean" onclick="toggleCuisine(this)">
            <h4>üåä Mediterranean</h4>
            <p>Seafood, olive oil, fresh</p>
          </div>
          <div class="selection-card" data-cuisine="Asian" onclick="toggleCuisine(this)">
            <h4>ü•¢ Asian Fusion</h4>
            <p>Modern techniques, bold</p>
          </div>
          <div class="selection-card" data-cuisine="Any" onclick="toggleCuisine(this)">
            <h4>üåç Surprise Me</h4>
            <p>Open to anything</p>
          </div>
        </div>
      </label>
      
      <label>
        <span>Ingredients to Feature (loves)</span>
        <input type="text" id="ingredientLoves" placeholder="e.g., lamb, seafood, mushrooms">
      </label>
      
      <label>
        <span>Ingredients to Avoid</span>
        <input type="text" id="ingredientAvoids" placeholder="e.g., cilantro, blue cheese">
      </label>
      
      <label>
        <span>Dietary Restrictions</span>
        <div class="card-grid" id="dietaryGrid">
          <div class="selection-card small" data-dietary="none" onclick="toggleDietary(this)">None</div>
          <div class="selection-card small" data-dietary="vegetarian" onclick="toggleDietary(this)">Vegetarian</div>
          <div class="selection-card small" data-dietary="gluten-free" onclick="toggleDietary(this)">Gluten-Free</div>
          <div class="selection-card small" data-dietary="dairy-free" onclick="toggleDietary(this)">Dairy-Free</div>
          <div class="selection-card small" data-dietary="nut-free" onclick="toggleDietary(this)">Nut-Free</div>
        </div>
      </label>
      
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
        <button class="btn btn-generate" onclick="generateMenus()">‚ú® Generate 5 Menu Options</button>
      </div>
    </div>
    
    <!-- STEP 3: Menu Selection -->
    <div id="step3" class="wizard-step">
      <h2>‚ë¢ Choose Your Menu</h2>
      
      <div id="menuLoading" class="loading" style="display:none">
        <div class="spinner"></div>
        <p>Creating personalized menus...</p>
        <p style="font-size:13px">This takes 15-30 seconds</p>
      </div>
      
      <div id="menuResults"></div>
      
      <div id="menuActions" style="display:none">
        <div class="btn-row">
          <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
          <button class="btn btn-secondary" onclick="generateMenus()">üîÑ Regenerate</button>
          <button class="btn btn-primary" id="selectMenuBtn" disabled onclick="goToStep(4)">Select Menu ‚Üí</button>
        </div>
      </div>
    </div>
    
    <!-- STEP 4: Timeline Selection -->
    <div id="step4" class="wizard-step">
      <h2>‚ë£ Choose Your Timeline</h2>
      <p style="color:var(--gray);margin-bottom:20px">How much help do you have?</p>
      
      <div id="staffingOptions">
        <div class="selection-card" data-staffing="solo" onclick="selectStaffing(this)">
          <h4>üë®‚Äçüç≥ Solo Cook</h4>
          <p>All tasks on you ‚Äî maximum prep-ahead strategy</p>
        </div>
        <div class="selection-card" data-staffing="helper1" onclick="selectStaffing(this)">
          <h4>üë• +1 Helper</h4>
          <p>You handle technique, helper preps & plates</p>
        </div>
        <div class="selection-card" data-staffing="helper2" onclick="selectStaffing(this)">
          <h4>üë•üë§ +2 Helpers</h4>
          <p>Full team ‚Äî parallel workflows</p>
        </div>
        <div class="selection-card" data-staffing="chef" onclick="selectStaffing(this)">
          <h4>üë®‚Äçüç≥‚≠ê Hired Chef</h4>
          <p>You host only ‚Äî stay out of kitchen!</p>
        </div>
      </div>
      
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
        <button class="btn btn-primary" id="toStep5Btn" disabled onclick="buildCookbook()">Build Cookbook ‚Üí</button>
      </div>
    </div>
    
    <!-- STEP 5: Cookbook Output -->
    <div id="step5" class="wizard-step">
      <h2>‚ë§ Your Cookbook</h2>
      
      <div id="cookbookLoading" class="loading" style="display:none">
        <div class="spinner"></div>
        <p>Building your cookbook...</p>
      </div>
      
      <div id="cookbookPreview"></div>
      
      <button class="download-btn" id="downloadBtn" style="display:none" onclick="downloadDocx()">
        üìÑ Download Complete Cookbook (DOCX)
      </button>
      
      <div class="btn-row" style="margin-top:20px">
        <button class="btn btn-secondary" onclick="goToStep(4)">‚Üê Change Timeline</button>
        <button class="btn btn-secondary" onclick="startOver()">üîÑ Start Over</button>
      </div>
    </div>
  </div>
  
  <script>
    // ============================================================
    // STATE
    // ============================================================
    let accessCode = null;
    let currentStep = 1;
    let selectedCuisines = [];
    let selectedDietary = [];
    let generatedMenus = [];
    let selectedMenu = null;
    let selectedStaffing = null;
    let cookbookData = null;
    
    // ============================================================
    // API CALLS
    // ============================================================
    const API_BASE =
  (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
    ? 'http://localhost:3000'
    : '';
    
    async function apiCall(endpoint, data = {}) {
      const response = await fetch(API_BASE + endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Access-Code': accessCode
        },
        body: JSON.stringify({ ...data, accessCode, code: accessCode })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || error.error || 'Request failed');
      }
      
      return response;
    }
    
    // ============================================================
    // AUTH
    // ============================================================
    async function validateAccess() {
      const code = document.getElementById('accessCodeInput').value.trim().toUpperCase();
      const errorEl = document.getElementById('loginError');
      
      if (!code) {
        errorEl.textContent = 'Please enter an access code';
        errorEl.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch(API_BASE + '/api/validate-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accessCode: code, code })
        });
        
        const data = await response.json();
        
        if (!data.valid) {
          errorEl.textContent = data.message || 'Invalid access code';
          errorEl.style.display = 'block';
          return;
        }
        
        // Success
        accessCode = code;
        localStorage.setItem('dinnerPlannerCode', code);
        
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appContainer').classList.add('active');
        
        updateUsageBadge(data.usage);
        setDefaultDate();
        
      } catch (err) {
        errorEl.textContent = 'Connection error. Please try again.';
        errorEl.style.display = 'block';
      }
    }
    
    function logout() {
      accessCode = null;
      localStorage.removeItem('dinnerPlannerCode');
      document.getElementById('appContainer').classList.remove('active');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('accessCodeInput').value = '';
      startOver();
    }
    
    function updateUsageBadge(usage) {
      const badge = document.getElementById('usageBadge');
      if (usage.remaining === 'unlimited') {
        badge.textContent = 'Admin Access';
      } else {
        badge.textContent = `${usage.remaining} generations remaining`;
      }
    }
    
    // Check for saved code on load
    async function checkSavedCode() {
      const saved = localStorage.getItem('dinnerPlannerCode');
      if (saved) {
        document.getElementById('accessCodeInput').value = saved;
        await validateAccess();
      }
    }
    
    // ============================================================
    // NAVIGATION
    // ============================================================
    function goToStep(step) {
      currentStep = step;
      
      document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
      document.getElementById('step' + step).classList.add('active');
      
      document.querySelectorAll('.progress-step').forEach((s, i) => {
        s.classList.remove('active', 'completed');
        if (i + 1 < step) s.classList.add('completed');
        if (i + 1 === step) s.classList.add('active');
      });
      
      window.scrollTo(0, 0);
    }
    
    function startOver() {
      selectedCuisines = [];
      selectedDietary = [];
      generatedMenus = [];
      selectedMenu = null;
      selectedStaffing = null;
      cookbookData = null;
      
      document.querySelectorAll('.selection-card').forEach(c => c.classList.remove('selected'));
      document.querySelectorAll('.menu-option').forEach(c => c.classList.remove('selected'));
      document.getElementById('selectMenuBtn').disabled = true;
      document.getElementById('toStep5Btn').disabled = true;
      
      goToStep(1);
    }
    
    // ============================================================
    // PREFERENCES
    // ============================================================
    function toggleCuisine(el) {
      const cuisine = el.dataset.cuisine;
      el.classList.toggle('selected');
      
      if (el.classList.contains('selected')) {
        if (!selectedCuisines.includes(cuisine)) selectedCuisines.push(cuisine);
      } else {
        selectedCuisines = selectedCuisines.filter(c => c !== cuisine);
      }
    }
    
    function toggleDietary(el) {
      const dietary = el.dataset.dietary;
      el.classList.toggle('selected');
      
      if (el.classList.contains('selected')) {
        if (!selectedDietary.includes(dietary)) selectedDietary.push(dietary);
      } else {
        selectedDietary = selectedDietary.filter(d => d !== dietary);
      }
    }
    
    // ============================================================
    // MENU GENERATION
    // ============================================================
    async function generateMenus() {
      goToStep(3);
      
      document.getElementById('menuLoading').style.display = 'block';
      document.getElementById('menuResults').innerHTML = '';
      document.getElementById('menuActions').style.display = 'none';
      
      const preferences = {
        guestCount: document.getElementById('guestCount').value,
        budget: document.getElementById('budgetTier').value,
        skillLevel: document.getElementById('skillLevel').value,
        cuisines: selectedCuisines.length ? selectedCuisines : ['Any'],
        loves: document.getElementById('ingredientLoves').value,
        avoids: document.getElementById('ingredientAvoids').value,
        dietary: selectedDietary.filter(d => d !== 'none')
      };
      
      try {
        const response = await apiCall('/api/generate-menus', { preferences });
        const data = await response.json();
        
        generatedMenus = data.menus;
        renderMenus();
        
        document.getElementById('menuLoading').style.display = 'none';
        document.getElementById('menuActions').style.display = 'block';
        
      } catch (err) {
        document.getElementById('menuLoading').style.display = 'none';
        document.getElementById('menuResults').innerHTML = `
          <div class="info-box warning">
            <strong>Error:</strong> ${err.message}<br>
            <button class="btn btn-secondary" style="margin-top:10px" onclick="generateMenus()">Try Again</button>
          </div>
        `;
      }
    }
    
    function renderMenus() {
      const container = document.getElementById('menuResults');
      container.innerHTML = generatedMenus.map((menu, i) => `
        <div class="menu-option" data-index="${i}" onclick="selectMenu(${i})">
          <h3>
            ${menu.title}
            <span class="cost">${menu.foodCost}</span>
          </h3>
          <div class="theme">${menu.theme || ''}</div>
          <div class="courses">
            ${menu.courses.map(c => `
              <div><span class="course-type">${c.type}:</span> ${c.name}</div>
            `).join('')}
          </div>
          <div style="margin-top:10px;font-size:12px;color:var(--gray)">
            Wine budget: ${menu.wineCost || 'TBD'}
          </div>
        </div>
      `).join('');
    }
    
    function selectMenu(index) {
      selectedMenu = generatedMenus[index];
      
      document.querySelectorAll('.menu-option').forEach((m, i) => {
        m.classList.toggle('selected', i === index);
      });
      
      document.getElementById('selectMenuBtn').disabled = false;
    }
    
    // ============================================================
    // STAFFING
    // ============================================================
    function selectStaffing(el) {
      selectedStaffing = el.dataset.staffing;
      
      document.querySelectorAll('#staffingOptions .selection-card').forEach(c => {
        c.classList.remove('selected');
      });
      el.classList.add('selected');
      
      document.getElementById('toStep5Btn').disabled = false;
    }
    
    // ============================================================
    // COOKBOOK
    // ============================================================
    async function buildCookbook() {
      goToStep(5);
      
      document.getElementById('cookbookLoading').style.display = 'block';
      document.getElementById('cookbookPreview').innerHTML = '';
      document.getElementById('downloadBtn').style.display = 'none';
      
      try {
        const response = await apiCall('/api/build-cookbook', {
          menu: selectedMenu,
          guestCount: parseInt(document.getElementById('guestCount').value),
          serviceTime: document.getElementById('eventTime').value,
          staffing: selectedStaffing
        });
        
        const data = await response.json();
        cookbookData = data.cookbook;
        
        renderCookbookPreview();
        
        document.getElementById('cookbookLoading').style.display = 'none';
        document.getElementById('downloadBtn').style.display = 'block';
        
      } catch (err) {
        document.getElementById('cookbookLoading').style.display = 'none';
        document.getElementById('cookbookPreview').innerHTML = `
          <div class="info-box warning">
            <strong>Error:</strong> ${err.message}
          </div>
        `;
      }
    }
    
    function renderCookbookPreview() {
      const cb = cookbookData;
      const preview = document.getElementById('cookbookPreview');
      
      preview.innerHTML = `
        <div class="cookbook-preview">
          <h3>üìñ Your Complete Cookbook Includes:</h3>
          
          <div class="cookbook-section">
            <h4>üçΩÔ∏è The Menu</h4>
            ${selectedMenu.courses.map(c => `<p><strong>${c.type}:</strong> ${c.name}</p>`).join('')}
          </div>
          
          <div class="cookbook-section">
            <h4>üç∑ Wine & Spirits</h4>
            ${Object.entries(cb.wines).map(([k, w]) => `<p><strong>${k}:</strong> ${w.name} (${w.price})</p>`).join('')}
          </div>
          
          <div class="cookbook-section">
            <h4>üõí Shopping List</h4>
            <p>${Object.values(cb.shopping).flat().length} items across ${Object.keys(cb.shopping).length} categories</p>
            <p>Scaled for ${document.getElementById('guestCount').value} guests</p>
          </div>
          
          <div class="cookbook-section">
            <h4>üìÖ Day-Before Prep</h4>
            ${cb.dayBeforePrep.slice(0, 3).map(t => `<p>‚òê ${t.name} (${t.time} min)</p>`).join('')}
            <p>...and ${cb.dayBeforePrep.length - 3} more tasks</p>
          </div>
          
          <div class="cookbook-section">
            <h4>‚è∞ Day-Of Timeline</h4>
            ${cb.timeline.map(t => `<p><strong>${t.time}:</strong> ${t.tasks[0]}</p>`).join('')}
          </div>
          
          <div class="cookbook-section">
            <h4>üì¶ Also Included</h4>
            <p>‚úì Table setting guide</p>
            <p>‚úì Plating guide with portions</p>
            <p>‚úì Tips & emergency fixes</p>
            <p>‚úì Final checklist</p>
            <p>‚úì AI image prompts</p>
          </div>
        </div>
      `;
    }
    
    // ============================================================
    // DOCX DOWNLOAD
    // ============================================================
    async function downloadDocx() {
      const btn = document.getElementById('downloadBtn');
      btn.textContent = '‚è≥ Generating...';
      btn.disabled = true;
      
      try {
        const response = await fetch(API_BASE + '/api/generate-docx', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Access-Code': accessCode
          },
          body: JSON.stringify({
            accessCode,
            eventTitle: document.getElementById('eventTitle').value || 'Dinner Party',
            eventDate: document.getElementById('eventDate').value,
            eventTime: document.getElementById('eventTime').value,
            guestCount: parseInt(document.getElementById('guestCount').value),
            menu: selectedMenu,
            staffing: selectedStaffing,
            cookbook: cookbookData
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to generate document');
        }
        
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (document.getElementById('eventTitle').value || 'Dinner_Party').replace(/[^a-z0-9]/gi, '_') + '_Cookbook.docx';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
      } catch (err) {
        alert('Error: ' + err.message);
      }
      
      btn.textContent = 'üìÑ Download Complete Cookbook (DOCX)';
      btn.disabled = false;
    }
    
    // ============================================================
    // UTILITIES
    // ============================================================
    function setDefaultDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('eventDate').value = today;
    }
    
    // ============================================================
    // INIT
    // ============================================================
    checkSavedCode();
  </script>
</body>
</html>
