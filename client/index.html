<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dinner Party Planner</title>
  <style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Source+Sans+3:wght@400;500;600&display=swap');
:root{
  --navy:#1E3A5F; --navy-dark:#152b46; --navy-light:#2f5686;
  --gold:#C9A227; --gold-light:#D4B03A; --gold-dark:#b88916;
  --cream:#FDF8F3; --cream-dark:#EFE6DD; --cream-bright:#fffaf6;
  --text:#1f2937; --text-light:#6b7280;
  --success:#16a34a; --success-light:#dcfce7;
  --error:#dc2626; --error-light:#fee2e2;
  --shadow-card: 0 12px 30px rgba(30,58,95,0.12);
  --shadow-soft: 0 8px 20px rgba(30,58,95,0.08);
  --shadow-highlight: 0 10px 25px rgba(201,162,39,0.25);
}
* { box-sizing: border-box; }
body{
  margin: 0;
  font-family: "Source Sans 3", "Helvetica Neue", Arial, sans-serif;
  background: radial-gradient(circle at top, #ffffff 0%, var(--cream) 45%, #f7efe6 100%);
  color:var(--text);
  line-height: 1.6;
}    
img { max-width: 100%; }
a { color: var(--navy); }

.container{
  max-width: 1120px;
  margin: -2.5rem auto 3.5rem;
  padding: 0 1.5rem 3rem;
  position: relative;
  z-index: 2;
}

.header{
  background:
    radial-gradient(circle at 20% 10%, rgba(255,255,255,0.35), transparent 50%),
    radial-gradient(circle at 80% 0%, rgba(201,162,39,0.25), transparent 45%),
    linear-gradient(135deg, #152b46 0%, #1f3d63 35%, #2c4f7a 70%, #1b3656 100%);
  color: white;
  text-align: center;
  padding: 4.5rem 1.5rem 6rem;
  position: relative;
  overflow: hidden;
}
.header::after{
  content: '';
  position: absolute;
  left: -10%;
  right: -10%;
  bottom: -60px;
  height: 120px;
  background: var(--cream);
  transform: skewY(-3deg);
  box-shadow: 0 -10px 30px rgba(21,43,70,0.2);
}
.header-content{
  max-width: 720px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}
.header-icon{
  width: 74px;
  height: 74px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 2.2rem;
  background: rgba(255,255,255,0.16);
  border: 1px solid rgba(255,255,255,0.35);
  box-shadow: var(--shadow-soft);
  margin-bottom: 1rem;
}
.header h1{
  font-family: "Playfair Display", serif;
  font-size: 3rem;
  margin: 0.2rem 0 0.4rem;
  letter-spacing: 0.02em;
}
.header p{
  margin: 0;
  color: rgba(255,255,255,0.85);
  font-size: 1.1rem;
}

.card{
  background: linear-gradient(180deg, #ffffff 0%, var(--cream-bright) 100%);
  border: 1px solid rgba(30,58,95,0.08);
  border-radius: 18px;
  padding: 2rem;
  box-shadow: var(--shadow-card);
  margin-bottom: 1.5rem;
}
.card-title{
  font-family: "Playfair Display", serif;
  font-size: 1.6rem;
  color: var(--navy);
  margin: 0 0 0.35rem;
}
.card-subtitle{
  color: var(--text-light);
  margin: 0 0 1.25rem;
}

.form-row{
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 1rem;
}
.form-group label{
  display: block;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--navy);
  margin-bottom: 0.4rem;
}
.form-group input,
.form-group select,
.form-group textarea{
  width: 100%;
  padding: 0.75rem 0.9rem;
  border-radius: 12px;
  border: 1px solid rgba(30,58,95,0.15);
  background: white;
  font-size: 0.95rem;
  box-shadow: inset 0 1px 2px rgba(15,23,42,0.08);
  transition: border-color 0.2s, box-shadow 0.2s;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus{
  outline: none;
  border-color: var(--navy);
  box-shadow: 0 0 0 3px rgba(30,58,95,0.15);
}

.progress{
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.6rem;
  margin: 1.5rem auto 2.5rem;
  flex-wrap: wrap;
}
.progress-step{
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: white;
  border: 2px solid var(--cream-dark);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-light);
  font-weight: 600;
  box-shadow: var(--shadow-soft);
  transition: all 0.2s;
}
.progress-step.active{
  background: var(--navy);
  border-color: var(--navy);
  color: white;
  box-shadow: var(--shadow-highlight);
}
.progress-step.complete{
  background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
  border-color: var(--gold-dark);
  color: white;
}
.progress-line{
  width: 28px;
  height: 3px;
  border-radius: 999px;
  background: var(--cream-dark);
}
.progress-line.complete{
  background: linear-gradient(90deg, var(--gold) 0%, var(--navy) 100%);
}
    /* ===== INSPIRATION CARDS ===== */
    .inspiration-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1.25rem;
    }
    .inspiration-card {
      background: white;
      border: 1px solid rgba(30,58,95,0.08);
      border-radius: 12px;
      padding: 1.25rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.25s;
      box-shadow: var(--shadow-soft);
    }
    .inspiration-card:hover {
      border-color: var(--gold);
      transform: translateY(-3px);
      box-shadow: var(--shadow-highlight);
    }
    .inspiration-card.selected {
      border-color: var(--navy);
      background: rgba(30,58,95,0.06);
    }
    .inspiration-card .icon { font-size: 2rem; margin-bottom: 0.6rem; }
    .inspiration-card .title {
      font-weight: 600; font-size: 0.9rem;
      color: var(--navy);
      margin-bottom: 0.35rem;
      font-family: 'Playfair Display', serif;
    }
    .inspiration-card .desc {
      font-size: 0.8rem;
      color: var(--text-light);
      line-height: 1.4;
    }
    
    /* ===== STYLE CARDS ===== */
    .style-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .style-card {
      background: white;
      border: 1px solid rgba(30,58,95,0.08);
      border-radius: 12px;
      padding: 1.125rem;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow-soft);
    }
    .style-card:hover { border-color: var(--gold); box-shadow: var(--shadow-highlight); }
    .style-card.selected {
      border-color: var(--navy);
      background: rgba(30,58,95,0.03);
    }
    .style-card .name {
      font-weight: 600; font-size: 0.95rem;
      color: var(--navy);
      margin-bottom: 0.3rem;
      font-family: 'Playfair Display', serif;
    }
    .style-card .desc {
      font-size: 0.85rem;
      color: var(--text-light);
    }
    
    /* ===== CHIPS ===== */
    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.45rem 0.85rem;
      border-radius: 999px;
      border: 1px solid var(--cream-dark);
      background: white;
      color: var(--navy);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    .chip:hover {
      border-color: var(--gold);
      color: var(--navy);
    }
    .chip.selected {
      border-color: var(--navy);
      background: rgba(30,58,95,0.08);
      color: var(--navy);
    }

    /* ===== CUISINE CASCADING ===== */
    .cuisine-section {
      margin-top: 1.25rem;
      padding: 1.25rem;
      background: var(--cream);
      border-radius: 12px;
      border: 1px solid var(--cream-dark);
    }
    .cuisine-section h4 {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-bottom: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
    }
    
    /* ===== EXPERT CARDS ===== */
    .expert-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
      margin-top: 1.25rem;
    }
    .expert-card {
      background: white;
      border: 1px solid rgba(30,58,95,0.08);
      border-radius: 14px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.25s;
      text-align: center;
      box-shadow: var(--shadow-soft);
    }
    .expert-card:hover {
      border-color: var(--gold);
      transform: translateY(-3px);
      box-shadow: var(--shadow-highlight);
    }
    .expert-card.selected {
      border-color: var(--navy);
      background: linear-gradient(180deg, rgba(30,58,95,0.04) 0%, rgba(201,162,39,0.04) 100%);
    }
    .expert-card .icon { font-size: 2.75rem; margin-bottom: 0.875rem; }
    .expert-card .name {
      font-family: 'Playfair Display', serif;
      font-size: 1.2rem; font-weight: 600;
      color: var(--navy);
      margin-bottom: 0.35rem;
    }
    .expert-card .credentials {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 0.6rem;
      line-height: 1.4;
    }
    .expert-card .philosophy {
      font-size: 0.9rem;
      font-style: italic;
      color: var(--gold-dark);
    }
    
    /* ===== CHAT ===== */
    .chat-container {
      background: white;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-top: 1.5rem;
    }
    .chat-header {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
      color: white;
      padding: 1.125rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.875rem;
    }
    .chat-header .icon { font-size: 1.75rem; }
    .chat-header .name {
      font-family: 'Playfair Display', serif;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .chat-messages {
      height: 380px;
      overflow-y: auto;
      padding: 1.25rem;
      background: var(--cream);
    }
    .chat-message {
      margin-bottom: 1.125rem;
      max-width: 88%;
    }
    .chat-message.user { margin-left: auto; }
    .chat-message .bubble {
      padding: 0.875rem 1.125rem;
      border-radius: 14px;
      line-height: 1.55;
      font-size: 0.95rem;
    }
    .chat-message.assistant .bubble {
      background: white;
      border: 1px solid var(--cream-dark);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .chat-message.user .bubble {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      color: white;
    }
    .chat-input-area {
      display: flex;
      gap: 0.6rem;
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--cream-dark);
      background: white;
    }
    .chat-input-area input { flex: 1; }
    
    /* ===== MENU CARDS ===== */
    .menu-card {
      background: white;
      border: 1px solid rgba(30,58,95,0.08);
      border-radius: 14px;
      padding: 1.75rem;
      margin-bottom: 1.25rem;
      cursor: pointer;
      transition: all 0.25s;
      position: relative;
      box-shadow: var(--shadow-soft);
    }
    .menu-card:hover {
      border-color: var(--gold);
      transform: translateY(-3px);
      box-shadow: var(--shadow-highlight);
    }
    .menu-card.selected {
      border-color: var(--navy);
      background: linear-gradient(135deg, rgba(30,58,95,0.03) 0%, rgba(201,162,39,0.03) 100%);
    }
    .menu-card.selected::after {
      content: '‚úì';
      position: absolute;
      top: 1.25rem; right: 1.25rem;
      width: 32px; height: 32px;
      background: var(--navy);
      color: white;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem;
      font-weight: bold;
    }
    .menu-card .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    .menu-card .title {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem; font-weight: 600;
      color: var(--navy);
    }
    .menu-card .cost-badge {
      background: linear-gradient(135deg, rgba(201,162,39,0.18) 0%, rgba(201,162,39,0.05) 100%);
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--gold-dark);
      font-weight: 600;
      border: 1px solid rgba(201,162,39,0.3);
    }
    .menu-card .personality {
      font-size: 0.95rem;
      font-style: italic;
      color: var(--text-light);
      margin-bottom: 1rem;
      line-height: 1.5;
    }
    .menu-card .courses {
      border-top: 1px solid var(--cream-dark);
      padding-top: 1rem;
    }
    .menu-card .course {
      display: grid;
      grid-template-columns: 120px 1fr auto;
      gap: 0.5rem;
      padding: 0.5rem 0;
      font-size: 0.95rem;
      align-items: baseline;
    }
    .menu-card .course-type {
      font-weight: 600;
      color: var(--gold-dark);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .menu-card .course-name { color: var(--text); }
    .menu-card .course-wine {
      font-size: 0.85rem;
      color: var(--gold);
      font-style: italic;
    }

    .menu-controls {
      display: flex;
      justify-content: center;
      margin: 0.5rem 0 1.5rem;
    }
    .toggle-field {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--cream-dark);
      background: white;
      color: var(--text-light);
      font-size: 0.85rem;
    }
    .toggle-field input {
      accent-color: var(--navy);
    }
    
    /* ===== STAFFING ===== */
    .staffing-option {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      padding: 1.25rem;
      border: 1px solid rgba(30,58,95,0.08);
      border-radius: 12px;
      cursor: pointer;
      margin-bottom: 0.875rem;
      transition: all 0.2s;
      background: white;
      box-shadow: var(--shadow-soft);
    }
    .staffing-option:hover { border-color: var(--gold); box-shadow: var(--shadow-highlight); }
    .staffing-option.selected {
      border-color: var(--navy);
      background: rgba(30,58,95,0.03);
    }
    .staffing-option .icon { font-size: 2.25rem; }
    .staffing-option .info h4 {
      font-weight: 600;
      color: var(--navy);
      margin-bottom: 0.25rem;
      font-size: 1.05rem;
    }
    .staffing-option .info p {
      font-size: 0.9rem;
      color: var(--text-light);
    }
    .staffing-option .time {
      margin-left: auto;
      text-align: right;
      font-size: 0.85rem;
      color: var(--gold-dark);
      font-weight: 600;
    }

    /* ===== DETAIL PREVIEWS ===== */
    .wine-tier-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 0.75rem;
    }
    .wine-tier-card {
      border: 1px solid rgba(30,58,95,0.08);
      border-radius: 12px;
      padding: 1rem;
      background: white;
      box-shadow: var(--shadow-soft);
    }
    .wine-tier-title {
      font-weight: 600;
      color: var(--navy);
      margin-bottom: 0.35rem;
      font-size: 0.95rem;
    }
    .wine-tier-cost {
      font-size: 0.85rem;
      color: var(--gold-dark);
      margin-bottom: 0.5rem;
    }
    .wine-tier-card ul {
      padding-left: 1.1rem;
      margin: 0;
      color: var(--text-light);
      font-size: 0.85rem;
      line-height: 1.4;
    }
    .recipe-card {
      border: 1px solid rgba(30,58,95,0.08);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.9rem;
      background: white;
      box-shadow: var(--shadow-soft);
    }
    .recipe-card h4 {
      margin: 0 0 0.4rem;
      color: var(--navy);
      font-size: 1rem;
    }
    .recipe-meta {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 0.6rem;
    }
    .recipe-card ul,
    .recipe-card ol {
      margin: 0.4rem 0 0.6rem 1.2rem;
      color: var(--text-light);
      font-size: 0.85rem;
    }
    .recipe-why {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 0.6rem;
      font-style: italic;
    }
    .expert-notes {
      display: grid;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .expert-note {
      padding: 0.9rem 1rem;
      border: 1px solid var(--cream-dark);
      border-radius: 10px;
      background: white;
    }
    .expert-note h4 {
      margin: 0 0 0.4rem;
      font-size: 0.95rem;
      color: var(--navy);
    }
    .timeline-list {
      display: grid;
      gap: 0.6rem;
      margin-top: 0.75rem;
    }
    .timeline-item {
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 0.75rem;
      padding: 0.6rem 0.75rem;
      border: 1px solid rgba(30,58,95,0.08);
      border-radius: 10px;
      background: white;
      box-shadow: var(--shadow-soft);
    }
    .timeline-time {
      font-weight: 600;
      color: var(--gold-dark);
      font-size: 0.85rem;
    }
    .timeline-task {
      color: var(--text-light);
      font-size: 0.9rem;
      line-height: 1.4;
    }
    
    /* ===== BUTTONS ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.95rem 2rem;
      border: none;
      border-radius: 999px;
      font-size: 1rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.25s;
      text-decoration: none;
      letter-spacing: 0.02em;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 45%, var(--navy-dark) 100%);
      color: white;
      box-shadow: var(--shadow-soft);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30,58,95,0.35);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      background: white;
      color: var(--navy);
      border: 2px solid rgba(30,58,95,0.4);
      box-shadow: var(--shadow-soft);
    }
    .btn-secondary:hover { background: var(--cream); }
    .btn-gold {
      background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 45%, var(--gold-light) 100%);
      color: white;
      box-shadow: var(--shadow-highlight);
    }
    .btn-gold:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(201,162,39,0.4);
    }
    .btn-outline {
      background: transparent;
      color: var(--text-light);
      border: 2px solid var(--cream-dark);
    }
    .btn-outline:hover {
      border-color: var(--navy);
      color: var(--navy);
    }
    .actions {
      display: flex;
      gap: 0.875rem;
      justify-content: center;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    
    /* ===== LOADING ===== */
    .loading {
      text-align: center;
      padding: 4rem 2rem;
    }
    .spinner {
      width: 50px; height: 50px;
      border: 4px solid var(--cream-dark);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.25rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading p {
      color: var(--text-light);
      font-size: 1.1rem;
      font-style: italic;
    }
    .loading .loading-subtext {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-light);
      font-style: normal;
    }
    
    /* ===== MESSAGES ===== */
    .success-msg {
      background: var(--success-light);
      border: 1px solid #86efac;
      color: #166534;
      padding: 1rem 1.25rem;
      border-radius: 10px;
      margin: 1rem 0;
      font-size: 0.95rem;
    }
    .error-msg {
      background: var(--error-light);
      border: 1px solid #fca5a5;
      color: #991b1b;
      padding: 1rem 1.25rem;
      border-radius: 10px;
      margin: 1rem 0;
      font-size: 0.95rem;
    }
    
    /* ===== SECTION TITLE ===== */
    .section-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--navy);
      background: linear-gradient(90deg, var(--navy), var(--gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
      margin: 2rem 0 1.5rem;
    }
    
    /* ===== PRINT PRODUCTS ===== */
    .print-section {
      background: var(--cream);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1.25rem;
    }
    .print-section h4 {
      font-family: 'Playfair Display', serif;
      font-size: 1.15rem;
      color: var(--navy);
      margin-bottom: 1rem;
    }
    .avery-product {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.875rem 1rem;
      background: white;
      border-radius: 8px;
      margin-bottom: 0.6rem;
      border: 1px solid var(--cream-dark);
    }
    .avery-product .info { flex: 1; }
    .avery-product .sku {
      font-weight: 600;
      color: var(--navy);
      font-size: 0.95rem;
    }
    .avery-product .details {
      font-size: 0.85rem;
      color: var(--text-light);
    }
    .avery-product .btn {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    
    /* ===== COOKBOOK PREVIEW ===== */
    .cookbook-preview {
      background: var(--cream);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }
    .cookbook-preview h4 {
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem;
      color: var(--navy);
      margin-bottom: 1.25rem;
    }
    .cookbook-sections {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 0.6rem;
    }
    .cookbook-section {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.625rem 0.875rem;
      background: white;
      border-radius: 8px;
      font-size: 0.9rem;
      border: 1px solid var(--cream-dark);
    }
    .cookbook-section::before {
      content: '‚úì';
      color: var(--success);
      font-weight: bold;
    }
    
    /* ===== API STATUS ===== */
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .status-online {
      background: var(--success-light);
      color: #166534;
      border: 1px solid #86efac;
    }
    .status-offline {
      background: var(--error-light);
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .footer-version {
      margin-left: 0.6rem;
      color: var(--text-light);
      font-size: 0.85rem;
    }
    .deploy-info {
      margin-top: 0.35rem;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.78);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      text-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    /* ===== FOOTER ===== */
    footer {
      text-align: center;
      padding: 2.5rem 1rem;
      color: var(--text-light);
      font-size: 0.9rem;
      border-top: 1px solid rgba(30,58,95,0.08);
      margin-top: 3rem;
      background: linear-gradient(180deg, #ffffff 0%, var(--cream) 100%);
      box-shadow: 0 -10px 30px rgba(30,58,95,0.08);
    }
    footer a { color: var(--navy); }
    
    /* ===== UTILITIES ===== */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-2 { margin-top: 2rem; }
    
    /* ===== RESPONSIVE ===== */
    @media (max-width: 700px) {
      body { font-size: 16px; }
      .header h1 { font-size: 2rem; }
      .header { padding: 2rem 1rem 3rem; }
      .container { margin: -1.5rem auto 2.5rem; }
      .card { padding: 1.5rem; }
      .form-row { grid-template-columns: 1fr; }
      .inspiration-grid { grid-template-columns: repeat(2, 1fr); }
      .expert-grid { grid-template-columns: 1fr; }
      .menu-card .course { grid-template-columns: 1fr; gap: 0.25rem; }
      .menu-card .course-wine { margin-left: 0; }
      .progress-step { width: 30px; height: 30px; font-size: 0.8rem; }
      .progress-line { width: 18px; }
      .btn { padding: 0.85rem 1.5rem; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="header-icon">üçΩÔ∏è</div>
      <h1>Dinner Party Planner</h1>
      <p>Create Unforgettable Experiences</p>
      <div class="deploy-info" id="deployInfo">Deploy: ‚Äî</div>
    </div>
  </header>
  
  <div class="container">
    <!-- Progress -->
    <div class="progress">
      <div class="progress-step active" id="dot1" onclick="jumpToStep(1)">1</div>
      <div class="progress-line" id="line1"></div>
      <div class="progress-step" id="dot2" onclick="jumpToStep(2)">2</div>
      <div class="progress-line" id="line2"></div>
      <div class="progress-step" id="dot3" onclick="jumpToStep(3)">3</div>
      <div class="progress-line" id="line3"></div>
      <div class="progress-step" id="dot4" onclick="jumpToStep(4)">4</div>
      <div class="progress-line" id="line4"></div>
      <div class="progress-step" id="dot5" onclick="jumpToStep(5)">5</div>
      <div class="progress-line" id="line5"></div>
      <div class="progress-step" id="dot6" onclick="jumpToStep(6)">6</div>
      <div class="progress-line" id="line6"></div>
      <div class="progress-step" id="dot7" onclick="jumpToStep(7)">7</div>
    </div>
    
    <!-- Step 1: Access Code -->
    <section id="step1">
      <div class="card">
        <h2 class="card-title">Welcome, Host</h2>
        <p class="card-subtitle">Enter your access code to begin planning an unforgettable dinner party experience.</p>
        <div class="form-group">
          <label for="accessCode">Access Code</label>
          <input type="text" id="accessCode" placeholder="Enter your beta access code" autocomplete="off">
        </div>
        <div id="codeMessage"></div>
        <div class="actions">
          <button class="btn btn-primary" onclick="validateCode()">Begin Planning</button>
        </div>
      </div>
    </section>
    
    <!-- Step 2: Event Details -->
    <section id="step2" class="hidden">
      <div class="card">
        <h2 class="card-title">Event Details</h2>
        <p class="card-subtitle">Tell us about your dinner party ‚Äî the basics help us personalize everything.</p>
        <div class="form-row">
          <div class="form-group">
            <label for="eventTitle">Event Name</label>
            <input type="text" id="eventTitle" placeholder="e.g., Anniversary Celebration">
          </div>
          <div class="form-group">
            <label for="eventDate">Date</label>
            <input type="date" id="eventDate">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="guestCount">Number of Guests</label>
            <select id="guestCount">
              <option value="2">2 guests (Intimate)</option>
              <option value="4">4 guests</option>
              <option value="6" selected>6 guests</option>
              <option value="8">8 guests</option>
              <option value="10">10 guests</option>
              <option value="12">12 guests (Large)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="serviceTime">Service Time</label>
            <select id="serviceTime">
              <option value="6:00 PM">6:00 PM</option>
              <option value="6:30 PM">6:30 PM</option>
              <option value="7:00 PM" selected>7:00 PM</option>
              <option value="7:30 PM">7:30 PM</option>
              <option value="8:00 PM">8:00 PM</option>
              <option value="8:30 PM">8:30 PM</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="guestList">Guest Names <span style="font-weight:normal;color:var(--text-light)">(for place cards, one per line)</span></label>
          <textarea id="guestList" rows="4" placeholder="Jane Smith&#10;John Smith&#10;..."></textarea>
        </div>
      </div>
      
      <div class="card">
        <h2 class="card-title">Menu Card Style</h2>
        <p class="card-subtitle">Choose the aesthetic for your printed materials.</p>
        <div class="style-grid" id="styleGrid"></div>
      </div>
      
      <div class="actions">
        <button class="btn btn-secondary" onclick="goToStep(1)">Back</button>
        <button class="btn btn-primary" onclick="goToStep(3)">Continue</button>
      </div>
    </section>
    
    <!-- Step 3: Preferences -->
    <section id="step3" class="hidden">
      <div class="card">
        <h2 class="card-title">Cascading Culinary Preferences</h2>
        <div class="form-group">
          <label>Cuisine Direction</label>
          <div class="chip-group" id="cuisineChips"></div>
          <div id="cuisineSubOptions" class="cuisine-section hidden"></div>
        </div>
        <div class="form-group">
          <label>Favorites <span style="font-weight:normal;color:var(--text-light)">(select all that apply)</span></label>
          <div class="chip-group" id="likesChips"></div>
        </div>
        <div class="form-group">
          <label>Avoid</label>
          <div class="chip-group" id="dislikesChips"></div>
        </div>
        <div class="form-group">
          <label>Dietary Restrictions</label>
          <div class="chip-group" id="restrictionsChips"></div>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">Menu Inspiration</h2>
        <p class="card-subtitle">What kind of dining experience are you creating? This guides our menu suggestions.</p>
        <div class="inspiration-grid" id="inspirationGrid"></div>
        
        <div id="customMenuInput" class="hidden" style="margin-top:1.5rem">
          <div class="form-group">
            <label for="customMenu">Your Menu</label>
            <textarea id="customMenu" rows="6" placeholder="Enter your planned courses..."></textarea>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2 class="card-title">Budget & Skill Level</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="foodBudget">Food Budget (per person)</label>
            <select id="foodBudget">
              <option value="$30-45">$30-45 ‚Äî Casual Elegant</option>
              <option value="$45-60" selected>$45-60 ‚Äî Classic Dinner Party</option>
              <option value="$60-80">$60-80 ‚Äî Upscale</option>
              <option value="$80-100">$80-100 ‚Äî Premium</option>
              <option value="$100+">$100+ ‚Äî Luxe</option>
            </select>
          </div>
          <div class="form-group">
            <label for="wineBudget">Wine Budget (total)</label>
            <select id="wineBudget">
              <option value="$50-80">$50-80</option>
              <option value="$80-120" selected>$80-120</option>
              <option value="$120-180">$120-180</option>
              <option value="$180-250">$180-250</option>
              <option value="$250+">$250+</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="skillLevel">Your Cooking Experience</label>
          <select id="skillLevel">
            <option value="beginner">Beginner ‚Äî I follow recipes carefully</option>
            <option value="intermediate" selected>Intermediate ‚Äî Comfortable improvising</option>
            <option value="advanced">Advanced ‚Äî Professionally trained or serious home cook</option>
          </select>
        </div>
      </div>
      
      <div class="actions">
        <button class="btn btn-secondary" onclick="goToStep(2)">Back</button>
        <button class="btn btn-primary" onclick="proceedToMenus()">Continue</button>
      </div>
    </section>
    
    <!-- Step 4: Menu Selection -->
    <section id="step4" class="hidden">
      <h2 class="section-title">Choose Your Menu</h2>

      <div class="menu-controls">
        <label class="toggle-field">
          <input type="checkbox" id="showWineToggle" onchange="toggleWinePairings(this.checked)">
          Show wine pairings
        </label>
      </div>
      
      <div id="menuLoading" class="loading hidden">
        <div class="spinner"></div>
        <p>Our culinary team is crafting your personalized menus...</p>
      </div>
      
      <div id="menuList"></div>
      
      <div id="menuActions" class="actions hidden">
        <button class="btn btn-secondary" onclick="goToStep(3)">Back</button>
        <button class="btn btn-outline" onclick="rejectMenus()">None of These Work</button>
        <button class="btn btn-outline" onclick="goToStep(5)">Consult Experts</button>
        <button class="btn btn-primary" id="selectMenuBtn" onclick="selectMenu()" disabled>Select This Menu</button>
      </div>
      
      <div id="rejectionChat" class="hidden">
        <div class="card">
          <h3 class="card-title">Let's Find Your Perfect Menu</h3>
          <p class="card-subtitle">I sense none of these hit the mark. Help me understand what you're looking for...</p>
          <div class="chat-container">
            <div class="chat-header">
              <span class="icon">üë®‚Äçüç≥</span>
              <span class="name">The Chef</span>
            </div>
            <div class="chat-messages" id="rejectionMessages"></div>
            <div class="chat-input-area">
              <input type="text" id="rejectionInput" placeholder="What did you imagine for this dinner?" onkeypress="if(event.key==='Enter')sendRejection()">
              <button class="btn btn-primary" onclick="sendRejection()">Send</button>
            </div>
          </div>
          <div class="actions">
            <button class="btn btn-gold" onclick="regenerateMenus()">Generate New Menus</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Step 5: Expert Consultation -->
    <section id="step5" class="hidden">
      <div class="card">
        <h2 class="card-title">Expert Consultation</h2>
        <p class="card-subtitle">Want a second opinion or guidance on the menus? Consult our experts anytime.</p>
        <div class="expert-grid" id="expertGrid"></div>
        <div class="actions" style="margin-top:1.5rem">
          <button class="btn btn-outline" onclick="skipConsultation()">Back to Menus</button>
        </div>
      </div>
      
      <div id="chatSection" class="hidden">
        <div class="chat-container">
          <div class="chat-header">
            <span class="icon" id="chatIcon">üë®‚Äçüç≥</span>
            <span class="name" id="chatName">The Chef</span>
          </div>
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Ask a question or share your vision..." onkeypress="if(event.key==='Enter')sendChat()">
            <button class="btn btn-primary" onclick="sendChat()">Send</button>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-secondary" onclick="goToStep(4)">Back to Menus</button>
          <button class="btn btn-outline" onclick="endChat()">End Consultation</button>
          <button class="btn btn-gold" onclick="goToStep(4)">Return to Menus</button>
        </div>
      </div>
    </section>
    
    <!-- Step 6: Staffing -->
    <section id="step6" class="hidden">
      <div class="card">
        <h2 class="card-title">Kitchen Staffing</h2>
        <p class="card-subtitle">How will you be staffing your kitchen? This affects your prep timeline and what's realistic to execute.</p>
        <div id="staffingOptions"></div>
      </div>
      
      <div class="card">
        <h3 class="card-title" style="font-size:1.2rem">Your Selected Menu</h3>
        <div id="selectedMenuSummary"></div>
      </div>

      <div id="detailsLoading" class="loading hidden">
        <div class="spinner"></div>
        <p id="detailsLoadingMessage">Preparing recipes, wine tiers, and timeline...</p>
        <p id="detailsLoadingTimer" class="loading-subtext">Elapsed 0:00 ‚Ä¢ Typical time: up to 5:00</p>
      </div>

      <div class="card">
        <h3 class="card-title" style="font-size:1.2rem">Expert Guidance</h3>
        <div id="expertGuidance"></div>
      </div>

      <div class="card">
        <h3 class="card-title" style="font-size:1.2rem">Wine Pairing Tiers</h3>
        <div id="wineTierList" class="wine-tier-grid"></div>
      </div>

      <div class="card">
        <h3 class="card-title" style="font-size:1.2rem">Recipe Previews</h3>
        <div id="recipePreview"></div>
      </div>

      <div class="card">
        <h3 class="card-title" style="font-size:1.2rem">Day-Of Timeline</h3>
        <div id="timelinePreview" class="timeline-list"></div>
      </div>
      
      <div class="actions">
        <button class="btn btn-secondary" onclick="goToStep(4)">Back</button>
        <button class="btn btn-gold" onclick="generateCookbook()">Generate Complete Cookbook</button>
      </div>
    </section>
    
    <!-- Step 7: Cookbook & Downloads -->
    <section id="step7" class="hidden">
      <div id="cookbookLoading" class="loading hidden">
        <div class="spinner"></div>
        <p>Creating your complete cookbook with recipes, timeline, and shopping list...</p>
      </div>
      
      <div id="cookbookComplete" class="hidden">
        <div class="card text-center">
          <h2 class="card-title">üéâ Your Cookbook is Ready!</h2>
          <p class="card-subtitle">Your complete dinner party cookbook has been generated with all 15 sections.</p>
          
          <div class="cookbook-preview">
            <h4>Your Cookbook Includes:</h4>
            <div class="cookbook-sections" id="cookbookSectionsList"></div>
          </div>
          
          <div class="actions">
            <button class="btn btn-gold" onclick="downloadCookbook()">üì• Download DOCX Cookbook</button>
          </div>
        </div>
        
        <div class="card">
          <h2 class="card-title">Print Products</h2>
          <p class="card-subtitle">Download print-ready files formatted for Avery paper products.</p>
          
          <div class="print-section">
            <h4>üìç Place Cards</h4>
            <div id="placeCardProducts"></div>
          </div>
          
          <div class="print-section">
            <h4>üìã Menu Cards</h4>
            <div id="menuCardProducts"></div>
          </div>
          
          <div class="print-section">
            <h4>üíå Invitations</h4>
            <div id="invitationProducts"></div>
          </div>
        </div>
        
        <div class="actions">
          <button class="btn btn-secondary" onclick="startOver()">Plan Another Party</button>
        </div>
      </div>
    </section>
    
    <footer>
      <p>Dinner Party Planner &copy; 2025</p>
      <p>
        <span id="apiStatus" class="status-pill status-offline">API: Offline</span>
        <span id="apiVersion" class="footer-version">Version: ‚Äî</span>
      </p>
      <p style="font-size:0.75rem;margin-top:0.35rem;opacity:0.7">AI-assisted recipe development. Recipes are original adaptations inspired by classic techniques.</p>
    </footer>
  </div>
  
  <script>
    // ============================================================
    // STATE
    // ============================================================
    let DATA = {};
    let currentStep = 1;
    let maxStepReached = 1;
    let accessCode = '';
    let selectedStyle = 'classic';
    let selectedInspiration = 'chefs-tasting';
    let selectedCuisine = null;
    let selectedSubCuisine = null;
    let likes = [];
    let dislikes = [];
    let restrictions = [];
    let selectedExpert = null;
    let chatHistory = [];
    let menus = [];
    let selectedMenu = null;
    let selectedStaffing = 'solo';
    let rejectionHistory = [];
    let cookbookId = null;
    let audioContext = null;
    let audioUnlocked = false;
    let menuDetailsCache = {};
    let selectedMenuDetails = null;
    let preferencesVisited = false;
    let preferencesCompleted = false;
    let showWinePairings = false;
    let detailsLoadingTimer = null;
    let detailsLoadingStart = null;
    const FETCH_TIMEOUTS_MS = {
      menus: 60000,
      details: 300000
    };
    const API_STATUS_REFRESH_MS = 30000;
    
    // ============================================================
    // INITIALIZATION
    // ============================================================
    async function init() {
      try {
        const res = await fetch('/api/data');
        DATA = await res.json();
      } catch (e) {
        console.error('Failed to load data:', e);
      }
      
      prepareTonePlayback();
      initStyleGrid();
      initInspirationGrid();
      initCuisineChips();
      initPreferenceChips();
      initExpertGrid();
      initStaffingOptions();
      initAveryProducts();
      initCookbookSections();
      loadApiStatus();
      setInterval(loadApiStatus, API_STATUS_REFRESH_MS);
      
      // Set default date 2 weeks out
      const defaultDate = new Date();
      defaultDate.setDate(defaultDate.getDate() + 14);
      document.getElementById('eventDate').value = defaultDate.toISOString().split('T')[0];
      
      // Enter key for access code
      document.getElementById('accessCode').addEventListener('keypress', e => {
        if (e.key === 'Enter') validateCode();
      });
    }
    
    document.addEventListener('DOMContentLoaded', init);
    
    // ============================================================
    // INIT HELPERS
    // ============================================================
    function setApiStatus(isOnline, version, isConfigured) {
      const statusEl = document.getElementById('apiStatus');
      const versionEl = document.getElementById('apiVersion');
      if (!statusEl || !versionEl) return;

      const demoSuffix = isOnline && isConfigured === false ? ' (Demo)' : '';
      statusEl.textContent = `API: ${isOnline ? 'Online' : 'Offline'}${demoSuffix}`;
      statusEl.classList.toggle('status-online', isOnline);
      statusEl.classList.toggle('status-offline', !isOnline);
      versionEl.textContent = version ? `Version: ${version}` : 'Version: ‚Äî';
    }

    function setDeployInfo(deployId) {
      const deployEl = document.getElementById('deployInfo');
      if (!deployEl) return;
      deployEl.textContent = deployId ? `Deploy: ${deployId}` : 'Deploy: ‚Äî';
    }

    async function loadApiStatus() {
      try {
        const res = await fetch('/api/health', { cache: 'no-store' });
        if (!res.ok) {
          throw new Error('Health check failed');
        }
        const data = await res.json();
        setApiStatus(true, data?.version, data?.apiConfigured);
        setDeployInfo(data?.deploy);
      } catch (e) {
        setApiStatus(false);
        setDeployInfo();
      }
    }

    function initStyleGrid() {
      const grid = document.getElementById('styleGrid');
      if (!DATA.MENU_STYLES) return;
      grid.innerHTML = DATA.MENU_STYLES.map(s => `
        <div class="style-card ${selectedStyle === s.id ? 'selected' : ''}" onclick="selectStyle('${s.id}')">
          <div class="name">${s.name}</div>
          <div class="desc">${s.desc}</div>
        </div>
      `).join('');
    }
    
    function initInspirationGrid() {
      const grid = document.getElementById('inspirationGrid');
      if (!DATA.MENU_INSPIRATIONS) return;
      grid.innerHTML = DATA.MENU_INSPIRATIONS.map(i => `
        <div class="inspiration-card ${selectedInspiration === i.id ? 'selected' : ''}" onclick="selectInspiration('${i.id}')">
          <div class="icon">${i.icon}</div>
          <div class="title">${i.title}</div>
          <div class="desc">${i.desc}</div>
        </div>
      `).join('');
    }
    
    function initCuisineChips() {
      const container = document.getElementById('cuisineChips');
      if (!DATA.CUISINES) return;
      container.innerHTML = Object.entries(DATA.CUISINES).map(([key, c]) => `
        <span class="chip ${selectedCuisine === key ? 'selected' : ''}" onclick="selectCuisine('${key}')">${c.label}</span>
      `).join('');
    }
    
    function initPreferenceChips() {
      const likeOptions = ['Beef', 'Lamb', 'Pork', 'Veal', 'Seafood', 'Shellfish', 'Poultry', 'Duck', 'Game', 'Pasta', 'Rich Sauces', 'Light & Fresh', 'Mushrooms', 'Truffles', 'Cheese', 'Chocolate', 'Fruit Desserts', 'Custards'];
      const dislikeOptions = ['Shellfish', 'Raw Fish', 'Organ Meats', 'Blue Cheese', 'Very Spicy', 'Olives', 'Anchovies', 'Cilantro', 'Lamb', 'Game', 'Fennel'];
      const restrictionOptions = ['Gluten-Free', 'Dairy-Free', 'Nut Allergy', 'Vegetarian', 'Vegan', 'Pescatarian', 'Low Sodium', 'Low Sugar', 'Kosher', 'Halal'];
      
      document.getElementById('likesChips').innerHTML = likeOptions.map(o => `
        <span class="chip" onclick="toggleChip(this, 'likes', '${o}')">${o}</span>
      `).join('');
      
      document.getElementById('dislikesChips').innerHTML = dislikeOptions.map(o => `
        <span class="chip" onclick="toggleChip(this, 'dislikes', '${o}')">${o}</span>
      `).join('');
      
      document.getElementById('restrictionsChips').innerHTML = restrictionOptions.map(o => `
        <span class="chip" onclick="toggleChip(this, 'restrictions', '${o}')">${o}</span>
      `).join('');
    }
    
    function initExpertGrid() {
      const grid = document.getElementById('expertGrid');
      if (!DATA.personas) return;
      grid.innerHTML = Object.entries(DATA.personas).map(([key, p]) => `
        <div class="expert-card" onclick="selectExpert('${key}')">
          <div class="icon">${p.icon}</div>
          <div class="name">${p.name}</div>
          <div class="credentials">${p.credentials}</div>
          <div class="philosophy">${p.philosophy}</div>
        </div>
      `).join('');
    }
    
    function initStaffingOptions() {
      const container = document.getElementById('staffingOptions');
      if (!DATA.STAFFING) return;
      container.innerHTML = DATA.STAFFING.map(s => `
        <div class="staffing-option ${selectedStaffing === s.id ? 'selected' : ''}" onclick="selectStaffingOption('${s.id}')">
          <span class="icon">${s.icon}</span>
          <div class="info">
            <h4>${s.name}</h4>
            <p>${s.desc}</p>
          </div>
          <div class="time">~${s.activeMin} min<br>active</div>
        </div>
      `).join('');
    }
    
    function initAveryProducts() {
      if (!DATA.AVERY_PRODUCTS) return;
      
      document.getElementById('placeCardProducts').innerHTML = DATA.AVERY_PRODUCTS.placeCards.map(p => `
        <div class="avery-product">
          <div class="info">
            <div class="sku">Avery ${p.sku} ‚Äî ${p.name}</div>
            <div class="details">${p.size} ‚Ä¢ ${p.perSheet}/sheet ‚Ä¢ ${p.desc}</div>
          </div>
          <button class="btn btn-outline" onclick="downloadPrintProduct('placeCards', '${p.sku}')">Download PDF</button>
        </div>
      `).join('');
      
      document.getElementById('menuCardProducts').innerHTML = DATA.AVERY_PRODUCTS.menuCards.map(p => `
        <div class="avery-product">
          <div class="info">
            <div class="sku">Avery ${p.sku} ‚Äî ${p.name}</div>
            <div class="details">${p.size} ‚Ä¢ ${p.perSheet}/sheet</div>
          </div>
          <button class="btn btn-outline" onclick="downloadPrintProduct('menuCards', '${p.sku}')">Download PDF</button>
        </div>
      `).join('');
      
      document.getElementById('invitationProducts').innerHTML = DATA.AVERY_PRODUCTS.invitations.map(p => `
        <div class="avery-product">
          <div class="info">
            <div class="sku">Avery ${p.sku} ‚Äî ${p.name}</div>
            <div class="details">${p.size} ‚Ä¢ ${p.perSheet}/sheet</div>
          </div>
          <button class="btn btn-outline" onclick="downloadPrintProduct('invitations', '${p.sku}')">Download PDF</button>
        </div>
      `).join('');
    }
    
    function initCookbookSections() {
      const container = document.getElementById('cookbookSectionsList');
      if (!DATA.COOKBOOK_SECTIONS) {
        const defaultSections = ['Cover Page', 'Menu Overview', 'Wine Program', 'Complete Recipes', 'Shopping List', 'Day-Before Prep', 'Day-Of Timeline', 'Plating Guides', 'Table Setting', 'Service Notes', 'Ambiance & Music', 'Final Checklist', 'AI Image Prompts', 'Notes Pages', 'Copyright'];
        container.innerHTML = defaultSections.map(s => `<div class="cookbook-section">${s}</div>`).join('');
      } else {
        container.innerHTML = DATA.COOKBOOK_SECTIONS.map(s => `<div class="cookbook-section">${s}</div>`).join('');
      }
    }
    
    // ============================================================
    // NAVIGATION
    // ============================================================
    function goToStep(step) {
      if (step >= 4 && !preferencesCompleted) {
        step = 3;
      }
      const isStepChange = step !== currentStep;

      if (step <= 3) {
        preferencesCompleted = false;
      }

      // Update max reached
      if (step > maxStepReached) maxStepReached = step;
      
      // Hide all steps
      for (let i = 1; i <= 7; i++) {
        document.getElementById('step' + i).classList.add('hidden');
      }
      
      // Show target step
      document.getElementById('step' + step).classList.remove('hidden');
      currentStep = step;

      if (step === 3) {
        preferencesVisited = true;
      }
      
      // Update progress
      updateProgress();
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });

      if (isStepChange) {
        playStepTone();
      }

      if (step === 6 && selectedMenu !== null) {
        renderTimelinePreview();
        loadMenuDetails();
      }
    }
    
    function jumpToStep(step) {
      if (step <= maxStepReached) {
        goToStep(step);
      }
    }
    
    function updateProgress() {
      for (let i = 1; i <= 7; i++) {
        const dot = document.getElementById('dot' + i);
        const line = document.getElementById('line' + i);
        
        dot.classList.remove('active', 'complete');
        if (line) line.classList.remove('complete');
        
        if (i < currentStep) {
          dot.classList.add('complete');
          if (line) line.classList.add('complete');
        } else if (i === currentStep) {
          dot.classList.add('active');
        }
      }
    }

    function showDetailsLoading(show) {
      const loading = document.getElementById('detailsLoading');
      const messageEl = document.getElementById('detailsLoadingMessage');
      const timerEl = document.getElementById('detailsLoadingTimer');
      if (!loading) return;
      loading.classList.toggle('hidden', !show);

      if (!show) {
        if (detailsLoadingTimer) {
          clearInterval(detailsLoadingTimer);
        }
        detailsLoadingTimer = null;
        detailsLoadingStart = null;
        return;
      }

      detailsLoadingStart = Date.now();
      updateDetailsLoadingStatus(messageEl, timerEl);
      if (detailsLoadingTimer) {
        clearInterval(detailsLoadingTimer);
      }
      detailsLoadingTimer = setInterval(() => updateDetailsLoadingStatus(messageEl, timerEl), 1000);
    }

    function formatDuration(ms) {
      const totalSeconds = Math.max(0, Math.floor(ms / 1000));
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = String(totalSeconds % 60).padStart(2, '0');
      return `${minutes}:${seconds}`;
    }

    function updateDetailsLoadingStatus(messageEl, timerEl) {
      if (!detailsLoadingStart) return;
      const elapsedMs = Date.now() - detailsLoadingStart;
      const elapsedLabel = formatDuration(elapsedMs);
      const maxLabel = formatDuration(FETCH_TIMEOUTS_MS.details);

      if (messageEl) {
        if (elapsedMs < 30000) {
          messageEl.textContent = 'Generating recipes and wine tiers...';
        } else if (elapsedMs < 60000) {
          messageEl.textContent = 'Still working on detailed recipes...';
        } else {
          messageEl.textContent = 'Finalizing wine pairings and prep guidance...';
        }
      }

      if (timerEl) {
        timerEl.textContent = `Elapsed ${elapsedLabel} ‚Ä¢ Typical time: up to ${maxLabel}`;
      }
    }

    async function fetchWithTimeout(url, options, timeoutMs) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch(url, { ...options, signal: controller.signal });
        return res;
      } finally {
        clearTimeout(timeoutId);
      }
    }

    function getSelectedMenuKey(menu) {
      if (!menu) return String(selectedMenu ?? '');
      return String(menu.id ?? menu.title ?? selectedMenu ?? '');
    }

    function renderWineTiers(wineTiers) {
      const container = document.getElementById('wineTierList');
      if (!container) return;

      if (!wineTiers || !wineTiers.length) {
        container.innerHTML = '<div class="error-msg">Wine tiers will appear once menu details are ready.</div>';
        return;
      }

      container.innerHTML = wineTiers.map(tier => `
        <div class="wine-tier-card">
          <div class="wine-tier-title">${tier.label}</div>
          <div class="wine-tier-cost">${tier.totalCost || ''}</div>
          <ul>
            ${(tier.pairings || []).map(p => `<li>${p}</li>`).join('')}
          </ul>
        </div>
      `).join('');
    }

    function renderMenuError(message, detail) {
      const container = document.getElementById('menuList');
      if (!container) return;
      const detailHtml = detail ? `<div style="margin-top:0.5rem;font-size:0.85rem;color:#6b7280">${detail}</div>` : '';
      container.innerHTML = `<div class="error-msg">${message}${detailHtml}</div>`;
    }

    function renderDetailError(message, detail) {
      const detailHtml = detail ? `<div style="margin-top:0.5rem;font-size:0.85rem;color:#6b7280">${detail}</div>` : '';
      const markup = `<div class="error-msg">${message}${detailHtml}</div>`;
      const wineContainer = document.getElementById('wineTierList');
      const recipeContainer = document.getElementById('recipePreview');
      const guidanceContainer = document.getElementById('expertGuidance');
      if (wineContainer) wineContainer.innerHTML = markup;
      if (recipeContainer) recipeContainer.innerHTML = markup;
      if (guidanceContainer) guidanceContainer.innerHTML = markup;
    }

    function allowDemoFallback() {
      if (!DATA) return false;
      return DATA.allowDemoFallback === true;
    }

    function renderRecipePreview(recipes) {
      const container = document.getElementById('recipePreview');
      if (!container) return;

      if (!recipes || !recipes.length) {
        container.innerHTML = '<div class="error-msg">Recipes will appear once menu details are ready.</div>';
        return;
      }

      container.innerHTML = recipes.map(recipe => `
        <div class="recipe-card">
          <h4>${recipe.title || 'Recipe'}</h4>
          <div class="recipe-meta">Serves ${recipe.serves || 6} ‚Ä¢ Active ${recipe.activeTime || '30 min'} ‚Ä¢ Total ${recipe.totalTime || '1 hour'}</div>
          <strong>Ingredients</strong>
          <ul>
            ${(recipe.ingredients || []).map(i => `<li>${i}</li>`).join('')}
          </ul>
          <strong>Method</strong>
          <ol>
            ${(recipe.steps || []).map(s => `<li>${s}</li>`).join('')}
          </ol>
          ${recipe.notes ? `<div class="recipe-meta"><em>${recipe.notes}</em></div>` : ''}
          ${recipe.makeAhead ? `<div class="recipe-meta"><strong>Make Ahead:</strong> ${recipe.makeAhead}</div>` : ''}
          ${recipe.whyItWorks ? `<div class="recipe-why"><strong>Why it works:</strong> ${recipe.whyItWorks}</div>` : ''}
        </div>
      `).join('');
    }

    function renderExpertGuidance(details) {
      const container = document.getElementById('expertGuidance');
      if (!container) return;

      if (!details) {
        container.innerHTML = '<div class="error-msg">Expert notes will appear once details are ready.</div>';
        return;
      }

      const chefNote = details.chefOverview;
      const wineNote = details.wineOverview;

      if (!chefNote && !wineNote) {
        container.innerHTML = '<div class="error-msg">Expert notes were not returned. Try again.</div>';
        return;
      }

      container.innerHTML = `
        <div class="expert-notes">
          ${chefNote ? `<div class="expert-note"><h4>Chef Guidance</h4><div>${chefNote}</div></div>` : ''}
          ${wineNote ? `<div class="expert-note"><h4>Sommelier Guidance</h4><div>${wineNote}</div></div>` : ''}
        </div>
      `;
    }

    function parseServiceTime(timeStr) {
      if (!timeStr) return null;
      const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
      if (!match) return null;
      let hours = parseInt(match[1], 10) % 12;
      const minutes = parseInt(match[2], 10);
      const isPm = match[3].toUpperCase() === 'PM';
      if (isPm) hours += 12;
      const date = new Date();
      date.setHours(hours, minutes, 0, 0);
      return date;
    }

    function formatTime(date) {
      const hours = date.getHours();
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours % 12 || 12;
      return `${displayHours}:${minutes} ${ampm}`;
    }

    function buildTimelineItems() {
      const baseTime = parseServiceTime(document.getElementById('serviceTime').value || '7:00 PM');
      const staffing = DATA.STAFFING?.find(s => s.id === selectedStaffing) || { activeMin: 0 };
      const timeline = [
        { offset: -360, label: 'Final shopping for any last-minute items', offsetLabel: '-6 hr' },
        { offset: -300, label: 'Begin slow-cooking items (braises, stocks)', offsetLabel: '-5 hr' },
        { offset: -240, label: 'Prep remaining vegetables and garnishes', offsetLabel: '-4 hr' },
        { offset: -180, label: 'Start sauces and reductions', offsetLabel: '-3 hr' },
        { offset: -120, label: 'Set out cheese and butter to temper', offsetLabel: '-2 hr' },
        { offset: -90, label: 'Open and decant red wines', offsetLabel: '-90 min' },
        { offset: -60, label: 'Final protein prep, bring to room temp', offsetLabel: '-1 hr' },
        { offset: -45, label: 'Preheat oven, warm plates', offsetLabel: '-45 min' },
        { offset: -30, label: 'Light candles, start music, final touches', offsetLabel: '-30 min' },
        { offset: -15, label: 'Plate amuse-bouche, pour welcome drinks', offsetLabel: '-15 min' },
        { offset: 0, label: 'Guests arrive ‚Äî service begins', offsetLabel: '0' },
        { offset: 15, label: 'Serve amuse-bouche', offsetLabel: '+15 min' },
        { offset: 30, label: 'Fire first course', offsetLabel: '+30 min' },
        { offset: 50, label: 'Clear, serve second course', offsetLabel: '+50 min' },
        { offset: 80, label: 'Fire main course', offsetLabel: '+80 min' },
        { offset: 110, label: 'Clear, prepare dessert', offsetLabel: '+110 min' },
        { offset: 130, label: 'Serve dessert and dessert wine', offsetLabel: '+130 min' },
      ];

      return timeline.map(item => {
        if (!baseTime) {
          return { time: item.offsetLabel, task: item.label };
        }
        const time = new Date(baseTime.getTime() + item.offset * 60000);
        const timeLabel = `${formatTime(time)} (${item.offsetLabel})`;
        return { time: timeLabel, task: item.label };
      }).map(item => ({ ...item, staffingMinutes: staffing.activeMin }));
    }

    function renderTimelinePreview() {
      const container = document.getElementById('timelinePreview');
      if (!container) return;
      const items = buildTimelineItems();
      container.innerHTML = items.map(item => `
        <div class="timeline-item">
          <div class="timeline-time">${item.time}</div>
          <div class="timeline-task">${item.task}</div>
        </div>
      `).join('');
    }

    function parseBudgetRange(value) {
      if (!value) {
        return { min: 80, max: 120 };
      }

      const rangeMatch = value.match(/(\d+)\s*-\s*(\d+)/);
      if (rangeMatch) {
        return { min: parseInt(rangeMatch[1], 10), max: parseInt(rangeMatch[2], 10) };
      }

      const plusMatch = value.match(/(\d+)\s*\+/);
      if (plusMatch) {
        const min = parseInt(plusMatch[1], 10);
        return { min, max: Math.round(min * 1.5) };
      }

      const singleMatch = value.match(/(\d+)/);
      if (singleMatch) {
        const min = parseInt(singleMatch[1], 10);
        return { min, max: Math.round(min * 1.4) };
      }

      return { min: 80, max: 120 };
    }

    function formatBudgetRange(min, max) {
      if (!max || max <= min) {
        return `$${min}+ total`;
      }
      return `$${min}-${max} total`;
    }

    function buildFallbackRecipes(menu) {
      const guestCount = parseInt(document.getElementById('guestCount').value || '6', 10);
      const timeByCourse = {
        'Amuse-Bouche': { active: '20 min', total: '45 min' },
        'First Course': { active: '30 min', total: '1 hour' },
        'Second Course': { active: '25 min', total: '45 min' },
        'Main Course': { active: '45 min', total: '1.5 hours' },
        'Dessert': { active: '35 min', total: '1 hour' }
      };

      return (menu?.courses || []).map(course => {
        const timing = timeByCourse[course.type] || { active: '30 min', total: '1 hour' };
        const title = course.name || course.type;
        return {
          title,
          serves: guestCount,
          activeTime: timing.active,
          totalTime: timing.total,
          ingredients: [
            title,
            'Kosher salt',
            'Freshly ground black pepper',
            'Olive oil or butter',
            'Seasonal herbs'
          ],
          steps: [
            `Prep ingredients for ${title}.`,
            `Cook the core components of ${title} until perfectly done.`,
            `Season, plate, and serve ${title}.`
          ],
          notes: 'Taste and adjust seasoning right before serving.',
          makeAhead: 'Most prep can be completed earlier in the day.'
        };
      });
    }

    function buildFallbackWineTiers(menu) {
      const baseRange = parseBudgetRange(document.getElementById('wineBudget').value || menu?.wineCost || '$80-120');
      const basePairings = (menu?.courses || []).map(course => {
        return course.wine || `${course.type} pairing`;
      });
      const tiers = [
        { id: 'value', label: 'Value', factor: 0.7 },
        { id: 'classic', label: 'Classic', factor: 1 },
        { id: 'premium', label: 'Premium', factor: 1.6 },
        { id: 'splurge', label: 'Splurge', factor: 2.4 }
      ];

      return tiers.map(tier => {
        const min = Math.max(30, Math.round(baseRange.min * tier.factor));
        const max = Math.max(min, Math.round(baseRange.max * tier.factor));
        return {
          id: tier.id,
          label: tier.label,
          totalCost: formatBudgetRange(min, max),
          pairings: basePairings.map(pairing => `${tier.label} pick: ${pairing}`)
        };
      });
    }

    function buildFallbackDetails(menu) {
      return {
        recipes: buildFallbackRecipes(menu),
        wineTiers: buildFallbackWineTiers(menu)
      };
    }

    async function loadMenuDetails() {
      const menu = menus[selectedMenu];
      if (!menu) return;

      const cacheKey = getSelectedMenuKey(menu);
      if (menuDetailsCache[cacheKey]) {
        selectedMenuDetails = menuDetailsCache[cacheKey];
        renderWineTiers(selectedMenuDetails.wineTiers);
        renderRecipePreview(selectedMenuDetails.recipes);
        renderExpertGuidance(selectedMenuDetails);
        renderTimelinePreview();
        return selectedMenuDetails;
      }

      showDetailsLoading(true);
      renderWineTiers([]);
      renderRecipePreview([]);
      renderExpertGuidance(null);
      renderTimelinePreview();

      try {
        const res = await fetchWithTimeout('/api/generate-details', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            menu: menu,
            context: getContext()
          })
        }, FETCH_TIMEOUTS_MS.details);
        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.error) {
          if (allowDemoFallback()) {
            selectedMenuDetails = buildFallbackDetails(menu);
            menuDetailsCache[cacheKey] = selectedMenuDetails;
            renderWineTiers(selectedMenuDetails.wineTiers);
            renderRecipePreview(selectedMenuDetails.recipes);
            renderExpertGuidance(selectedMenuDetails);
            return selectedMenuDetails;
          }
          renderDetailError('Details generation failed.', data.detail || 'Check your API key and account credits.');
          return null;
        }

        if (data.demo && !allowDemoFallback()) {
          renderDetailError('Details are in demo mode.', 'Enable the API key to generate real recipes and wine tiers.');
          return null;
        }

        selectedMenuDetails = data;
        menuDetailsCache[cacheKey] = selectedMenuDetails;
        renderWineTiers(selectedMenuDetails.wineTiers);
        renderRecipePreview(selectedMenuDetails.recipes);
        renderExpertGuidance(selectedMenuDetails);
      } catch (err) {
        if (allowDemoFallback()) {
          selectedMenuDetails = buildFallbackDetails(menu);
          menuDetailsCache[cacheKey] = selectedMenuDetails;
          renderWineTiers(selectedMenuDetails.wineTiers);
          renderRecipePreview(selectedMenuDetails.recipes);
          renderExpertGuidance(selectedMenuDetails);
          return selectedMenuDetails;
        }
        const detailMessage = err?.name === 'AbortError'
          ? 'Request timed out. Please try again.'
          : 'Network error. Please try again.';
        renderDetailError('Details generation failed.', detailMessage);
        return null;
      } finally {
        showDetailsLoading(false);
      }

      return selectedMenuDetails;
    }

    function prepareTonePlayback() {
      const unlock = () => {
        if (audioUnlocked) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) {
          audioUnlocked = true;
          return;
        }
        audioContext = new AudioContext();
        audioContext.resume().catch(() => {});
        audioUnlocked = true;
      };

      document.addEventListener('pointerdown', unlock, { once: true });
      document.addEventListener('keydown', unlock, { once: true });
    }

    function playStepTone() {
      if (!audioContext) return;

      if (audioContext.state === 'suspended') {
        audioContext.resume().catch(() => {});
      }

      const now = audioContext.currentTime;
      const oscillator = audioContext.createOscillator();
      const gain = audioContext.createGain();

      oscillator.type = 'sine';
      oscillator.frequency.value = 880;

      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.08, now + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.16);

      oscillator.connect(gain);
      gain.connect(audioContext.destination);

      oscillator.start(now);
      oscillator.stop(now + 0.18);
    }
    
    // ============================================================
    // STEP 1: ACCESS CODE
    // ============================================================
    async function validateCode() {
      const code = document.getElementById('accessCode').value.trim();
      const msgEl = document.getElementById('codeMessage');
      
      if (!code) {
        msgEl.innerHTML = '<div class="error-msg">Please enter an access code.</div>';
        return;
      }
      
      try {
        const res = await fetch('/api/validate-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });
        const data = await res.json();
        
        if (data.valid) {
          accessCode = code;
          msgEl.innerHTML = `<div class="success-msg">‚úì Access granted! ${data.remaining ? `(${data.remaining} generations remaining)` : ''}</div>`;
          setTimeout(() => goToStep(2), 800);
        } else {
          msgEl.innerHTML = `<div class="error-msg">${data.message || 'Invalid access code.'}</div>`;
        }
      } catch (err) {
        msgEl.innerHTML = '<div class="error-msg">Connection error. Please try again.</div>';
      }
    }
    
    // ============================================================
    // STEP 2: STYLES
    // ============================================================
    function selectStyle(id) {
      selectedStyle = id;
      initStyleGrid();
    }
    
    // ============================================================
    // STEP 3: PREFERENCES
    // ============================================================
    function selectInspiration(id) {
      selectedInspiration = id;
      initInspirationGrid();
      
      // Show custom menu input if "I Already Know" selected
      const customInput = document.getElementById('customMenuInput');
      if (id === 'custom') {
        customInput.classList.remove('hidden');
      } else {
        customInput.classList.add('hidden');
      }
    }
    
    function selectCuisine(key) {
      selectedCuisine = selectedCuisine === key ? null : key;
      selectedSubCuisine = null;
      initCuisineChips();
      updateCuisineSubOptions();
    }
    
    function updateCuisineSubOptions() {
      const container = document.getElementById('cuisineSubOptions');
      
      if (!selectedCuisine || !DATA.CUISINES) {
        container.classList.add('hidden');
        return;
      }
      
      const cuisine = DATA.CUISINES[selectedCuisine];
      let html = '';
      
      if (cuisine.regions) {
        html += '<h4>Regions</h4><div class="chip-group">';
        html += cuisine.regions.map(r => `
          <span class="chip ${selectedSubCuisine === r ? 'selected' : ''}" onclick="selectSubCuisine('${r}')">${r}</span>
        `).join('');
        html += '</div>';
      }
      
      if (cuisine.styles) {
        html += '<h4 style="margin-top:1rem">Styles</h4><div class="chip-group">';
        html += cuisine.styles.map(s => `
          <span class="chip ${selectedSubCuisine === s ? 'selected' : ''}" onclick="selectSubCuisine('${s}')">${s}</span>
        `).join('');
        html += '</div>';
      }
      
      if (cuisine.countries) {
        html += '<h4>Countries</h4><div class="chip-group">';
        html += Object.entries(cuisine.countries).map(([k, c]) => `
          <span class="chip ${selectedSubCuisine === c.label ? 'selected' : ''}" onclick="selectSubCuisineCountry('${k}', '${c.label}')">${c.label}</span>
        `).join('');
        html += '</div>';
        
        // Show regions for selected country
        const selectedCountryKey = Object.keys(cuisine.countries).find(k => cuisine.countries[k].label === selectedSubCuisine);
        if (selectedCountryKey) {
          const country = cuisine.countries[selectedCountryKey];
          if (country.regions) {
            html += '<h4 style="margin-top:1rem">Regions</h4><div class="chip-group">';
            html += country.regions.map(r => `
              <span class="chip" onclick="selectSubCuisine('${selectedSubCuisine} ‚Äî ${r}')">${r}</span>
            `).join('');
            html += '</div>';
          }
        }
      }
      
      container.innerHTML = html;
      container.classList.remove('hidden');
    }
    
    function selectSubCuisine(value) {
      selectedSubCuisine = value;
      updateCuisineSubOptions();
    }
    
    function selectSubCuisineCountry(key, label) {
      selectedSubCuisine = label;
      updateCuisineSubOptions();
    }
    
    function toggleChip(el, category, value) {
      el.classList.toggle('selected');
      const arr = category === 'likes' ? likes : category === 'dislikes' ? dislikes : restrictions;
      const idx = arr.indexOf(value);
      if (idx > -1) {
        arr.splice(idx, 1);
      } else {
        arr.push(value);
      }
    }
    
    // ============================================================
    // STEP 4: EXPERT CONSULTATION
    // ============================================================
    function selectExpert(key) {
      selectedExpert = key;
      const persona = DATA.personas[key];
      
      // Update expert cards
      document.querySelectorAll('.expert-card').forEach((card, i) => {
        const cardKey = Object.keys(DATA.personas)[i];
        card.classList.toggle('selected', cardKey === key);
      });
      
      // Show chat section
      document.getElementById('chatSection').classList.remove('hidden');
      document.getElementById('chatIcon').textContent = persona.icon;
      document.getElementById('chatName').textContent = persona.name;
      
      // Initialize chat with greeting
      chatHistory = [];
      const greeting = getExpertGreeting(key);
      chatHistory.push({ role: 'assistant', content: greeting });
      renderChat();
    }
    
    function getExpertGreeting(key) {
      const eventTitle = document.getElementById('eventTitle').value || 'your dinner party';
      const guestCount = document.getElementById('guestCount').value;
      const inspiration = DATA.MENU_INSPIRATIONS?.find(i => i.id === selectedInspiration)?.title || 'special';
      
      const greetings = {
        chef: `Welcome! I'm thrilled to help plan ${eventTitle}. I see you're cooking for ${guestCount} guests with a ${inspiration.toLowerCase()} inspiration ‚Äî wonderful choice. Tell me, what story do you want your menu to tell? Is there an ingredient or dish you've been dreaming about?`,
        sommelier: `What a pleasure to help with ${eventTitle}! Before we discuss wines, tell me about your guests. Are they adventurous with wine, or do they prefer familiar favorites? And is there a memorable bottle you've shared before that we might echo?`,
        instructor: `Hello! I'm here to make sure ${eventTitle} runs smoothly for your ${guestCount} guests. First, tell me about your kitchen setup and how much time you'll have for prep. What's your biggest concern about executing this dinner?`,
        all: `Welcome! The three of us are excited to help plan ${eventTitle}.\n\n**Chef:** Let's start with your vision ‚Äî what flavors are you craving?\n\n**Sommelier:** I'll ensure every course has the perfect pour.\n\n**Instructor:** And I'll make sure you can execute it all calmly.\n\nWhat would you like to discuss first?`,
        photographer: `Hello! I'm here to help you capture beautiful images of ${eventTitle}. First question: would you like me to create image prompts based on YOUR dining room and what you already have, or shall I propose an ideal setting?\n\nIf you'd like prompts tailored to your space, tell me about your dining room ‚Äî the table shape, wood tone, wall colors, lighting, and any special pieces you'd like featured.`,
        tablescaper: `Welcome! I'm so excited to help stage ${eventTitle} for ${guestCount} guests. The table is your stage before a single dish arrives ‚Äî it sets the entire mood.\n\nTell me about your space: What's your table shape and size? Do you have existing linens, chargers, or centerpiece vessels you'd like to incorporate? And what feeling do you want guests to have when they first see the table?`,
        plating: `Hello! I'm here to help your dishes look as extraordinary as they taste at ${eventTitle}. Every plate is a composition ‚Äî and I'll help you think like a professional.\n\nFirst, tell me about your plating experience. Are you comfortable with tweezers and squeeze bottles, or would you prefer techniques that are elegant but approachable? And do you have rimmed or rimless plates?`
      };
      
      return greetings[key] || greetings.chef;
    }
    
    function renderChat() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = chatHistory.map(msg => `
        <div class="chat-message ${msg.role}">
          <div class="bubble">${formatChatMessage(msg.content)}</div>
        </div>
      `).join('');
      container.scrollTop = container.scrollHeight;
    }
    
    function formatChatMessage(content) {
      return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    }
    
    async function sendChat() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;
      
      chatHistory.push({ role: 'user', content: message });
      input.value = '';
      renderChat();
      
      // Typing indicator
      chatHistory.push({ role: 'assistant', content: '...' });
      renderChat();
      
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: accessCode,
            persona: selectedExpert,
            messages: chatHistory.slice(0, -1),
            context: getContext()
          })
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.error) {
          const message = data.detail || data.error || 'Chat failed. Please try again.';
          chatHistory[chatHistory.length - 1] = { role: 'assistant', content: message };
          renderChat();
          return;
        }

        chatHistory[chatHistory.length - 1] = { role: 'assistant', content: data.response || 'Please try again.' };
        renderChat();
      } catch (err) {
        chatHistory[chatHistory.length - 1] = { role: 'assistant', content: 'Connection error. Please try again.' };
        renderChat();
      }
    }
    
    function getContext() {
      return {
        eventTitle: document.getElementById('eventTitle').value,
        eventDate: document.getElementById('eventDate').value,
        guestCount: document.getElementById('guestCount').value,
        guestList: document.getElementById('guestList').value,
        serviceTime: document.getElementById('serviceTime').value,
        foodBudget: document.getElementById('foodBudget').value,
        wineBudget: document.getElementById('wineBudget').value,
        skillLevel: document.getElementById('skillLevel').value,
        menuStyle: selectedStyle,
        inspiration: selectedInspiration,
        cuisine: selectedCuisine,
        subCuisine: selectedSubCuisine,
        likes: likes,
        dislikes: dislikes,
        restrictions: restrictions
      };
    }
    
    function endChat() {
      document.getElementById('chatSection').classList.add('hidden');
      selectedExpert = null;
      document.querySelectorAll('.expert-card').forEach(c => c.classList.remove('selected'));
    }
    
    function skipConsultation() {
      goToStep(4);
    }
    
    async function proceedToMenus() {
      if (!preferencesVisited) {
        goToStep(3);
        return;
      }
      preferencesCompleted = true;
      goToStep(4);
      await generateMenus();
    }
    
    // ============================================================
    // STEP 5: MENU SELECTION
    // ============================================================
    async function generateMenus() {
      document.getElementById('menuLoading').classList.remove('hidden');
      document.getElementById('menuList').innerHTML = '';
      document.getElementById('menuActions').classList.add('hidden');
      document.getElementById('rejectionChat').classList.add('hidden');
      
      try {
        const res = await fetchWithTimeout('/api/generate-menus', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: accessCode,
            context: getContext(),
            chatHistory: chatHistory,
            rejectionHistory: rejectionHistory
          })
        }, FETCH_TIMEOUTS_MS.menus);
        const data = await res.json().catch(() => ({}));
        
        document.getElementById('menuLoading').classList.add('hidden');
        
        if (!res.ok || data.error) {
          renderMenuError('Menu generation failed.', data.detail || 'Check your API key and account credits.');
          return;
        }

        if (data.demo && !allowDemoFallback()) {
          renderMenuError('Menu generation is in demo mode.', 'Enable the API key to generate real menus.');
          return;
        }

        if (data.menus && data.menus.length > 0) {
          menus = data.menus;
          renderMenus();
          if (data.demo) {
            document.getElementById('menuList').insertAdjacentHTML('afterbegin', '<div class="error-msg">Demo menus shown because the AI service is unavailable.</div>');
          }
          document.getElementById('menuActions').classList.remove('hidden');
        } else {
          renderMenuError('Unable to generate menus.', 'Please try again.');
        }
      } catch (err) {
        document.getElementById('menuLoading').classList.add('hidden');
        const detailMessage = err?.name === 'AbortError'
          ? 'Request timed out. Please try again.'
          : 'Please try again.';
        renderMenuError('Connection error.', detailMessage);
      }
    }
    
    function renderMenus() {
      const container = document.getElementById('menuList');
      const showWine = showWinePairings;
      container.innerHTML = menus.map((menu, i) => `
        <div class="menu-card ${selectedMenu === i ? 'selected' : ''}" onclick="highlightMenu(${i})">
          <div class="menu-header">
            <div class="title">${menu.title}</div>
            <div class="cost-badge">${menu.foodCost}</div>
          </div>
          <div class="personality">${menu.personality}</div>
          <div class="courses">
            ${menu.courses.map(c => `
              <div class="course">
                <span class="course-type">${c.type}</span>
                <span class="course-name">${c.name}</span>
                ${showWine && c.wine ? `<span class="course-wine">üç∑ ${c.wine}</span>` : ''}
              </div>
            `).join('')}
          </div>
          ${showWine ? `<div style="margin-top:0.75rem;font-size:0.9rem;color:var(--gold-dark)">Wine: ${menu.wineCost}</div>` : ''}
        </div>
      `).join('');
    }

    function toggleWinePairings(value) {
      showWinePairings = !!value;
      if (menus && menus.length) {
        renderMenus();
      }
    }
    
    function highlightMenu(index) {
      selectedMenu = index;
      renderMenus();
      document.getElementById('selectMenuBtn').disabled = false;
    }
    
    function selectMenu() {
      if (selectedMenu === null) return;
      
      const menu = menus[selectedMenu];
      document.getElementById('selectedMenuSummary').innerHTML = `
        <div style="font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--navy);margin-bottom:0.5rem">${menu.title}</div>
        <div style="font-style:italic;color:var(--text-light);margin-bottom:1rem">${menu.personality}</div>
        ${menu.courses.map(c => `
          <div style="padding:0.4rem 0;font-size:0.95rem;display:flex;gap:0.75rem">
            <strong style="color:var(--gold-dark);min-width:100px">${c.type}:</strong>
            <span>${c.name}</span>
          </div>
        `).join('')}
        <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--cream-dark);font-size:0.9rem;color:var(--text-light)">
          Food: ${menu.foodCost} | Wine: ${menu.wineCost}
        </div>
      `;
      
      goToStep(6);
      loadMenuDetails();
    }
    
    function rejectMenus() {
      document.getElementById('menuActions').classList.add('hidden');
      document.getElementById('rejectionChat').classList.remove('hidden');
      
      rejectionHistory = [{
        role: 'assistant',
        content: rejectionHistory.length === 0 
          ? "I sense none of these hit the mark. Help me understand ‚Äî what did you imagine when you first thought about this dinner? Was there a dish, an ingredient, or a moment you were hoping to create?"
          : "I hear you. Let's dig deeper. Tell me about your guests ‚Äî what would make them feel truly celebrated? Sometimes the best menus come from understanding the people around the table."
      }];
      renderRejectionChat();
    }
    
    function renderRejectionChat() {
      const container = document.getElementById('rejectionMessages');
      container.innerHTML = rejectionHistory.map(msg => `
        <div class="chat-message ${msg.role}">
          <div class="bubble">${formatChatMessage(msg.content)}</div>
        </div>
      `).join('');
      container.scrollTop = container.scrollHeight;
    }
    
    async function sendRejection() {
      const input = document.getElementById('rejectionInput');
      const message = input.value.trim();
      if (!message) return;
      
      rejectionHistory.push({ role: 'user', content: message });
      input.value = '';
      renderRejectionChat();
      
      rejectionHistory.push({ role: 'assistant', content: '...' });
      renderRejectionChat();
      
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: accessCode,
            persona: 'chef',
            messages: rejectionHistory.slice(0, -1),
            context: getContext()
          })
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.error) {
          const message = data.detail || data.error || "I understand. Tell me more about what you're envisioning...";
          rejectionHistory[rejectionHistory.length - 1] = { role: 'assistant', content: message };
          renderRejectionChat();
          return;
        }

        rejectionHistory[rejectionHistory.length - 1] = { 
          role: 'assistant', 
          content: data.response || "I understand. Tell me more about what you're envisioning..." 
        };
        renderRejectionChat();
      } catch (err) {
        rejectionHistory[rejectionHistory.length - 1] = { 
          role: 'assistant', 
          content: "I hear you. Tell me more about your vision for this dinner." 
        };
        renderRejectionChat();
      }
    }
    
    async function regenerateMenus() {
      document.getElementById('rejectionChat').classList.add('hidden');
      selectedMenu = null;
      await generateMenus();
    }
    
    // ============================================================
    // STEP 6: STAFFING
    // ============================================================
    function selectStaffingOption(id) {
      selectedStaffing = id;
      initStaffingOptions();
      renderTimelinePreview();
    }
    
    // ============================================================
    // STEP 7: COOKBOOK
    // ============================================================
    async function generateCookbook() {
      if (!selectedMenuDetails) {
        await loadMenuDetails();
      }
      goToStep(7);
      document.getElementById('cookbookLoading').classList.remove('hidden');
      document.getElementById('cookbookComplete').classList.add('hidden');
      
      try {
        const res = await fetch('/api/generate-cookbook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: accessCode,
            menu: menus[selectedMenu],
            context: getContext(),
            staffing: selectedStaffing,
            chatHistory: chatHistory,
            recipes: selectedMenuDetails?.recipes || null
          })
        });
        const data = await res.json();
        
        document.getElementById('cookbookLoading').classList.add('hidden');
        
        if (data.success) {
          cookbookId = data.cookbookId;
          document.getElementById('cookbookComplete').classList.remove('hidden');
        } else {
          document.getElementById('cookbookComplete').innerHTML = `<div class="error-msg">${data.message || 'Error generating cookbook.'}</div>`;
          document.getElementById('cookbookComplete').classList.remove('hidden');
        }
      } catch (err) {
        document.getElementById('cookbookLoading').classList.add('hidden');
        document.getElementById('cookbookComplete').innerHTML = '<div class="error-msg">Connection error. Please try again.</div>';
        document.getElementById('cookbookComplete').classList.remove('hidden');
      }
    }
    
    async function downloadCookbook() {
      try {
        const res = await fetch('/api/download-cookbook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: accessCode,
            cookbookId: cookbookId,
            menu: menus[selectedMenu],
            context: getContext(),
            staffing: selectedStaffing,
            recipes: selectedMenuDetails?.recipes || null
          })
        });
        
        if (res.ok) {
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const eventTitle = document.getElementById('eventTitle').value || 'Dinner_Party';
          a.download = eventTitle.replace(/[^a-zA-Z0-9]/g, '_') + '_Cookbook.docx';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } else {
          let message = 'Error downloading cookbook. Please try again.';
          try {
            const data = await res.json();
            if (data?.error) {
              message = data.detail ? `${data.error}: ${data.detail}` : data.error;
            }
          } catch (err) {
            // ignore JSON parse errors
          }
          alert(message);
        }
      } catch (err) {
        alert('Connection error. Please try again.');
      }
    }
    
    function downloadPrintProduct(type, sku) {
      alert(`Print-ready PDF for Avery ${sku} coming in next release.\n\nFor now, your place cards and menu cards are included in the DOCX cookbook.`);
    }
    
    function startOver() {
      selectedMenu = null;
      menus = [];
      chatHistory = [];
      rejectionHistory = [];
      cookbookId = null;
      menuDetailsCache = {};
      selectedMenuDetails = null;
      preferencesVisited = false;
      preferencesCompleted = false;
      maxStepReached = 2;
      goToStep(2);
    }
  </script>
</body>
</html>
