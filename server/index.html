<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dinner Party Planner</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--navy:#1e3a5f;--navy-dark:#152a45;--gold:#c9a227;--cream:#faf8f5;--cream-dark:#f0ebe3;--text:#2d3a35;--text-light:#6b7c85}
    body{min-height:100vh;background:var(--cream);font-family:'Crimson Text',Georgia,serif;color:var(--text);line-height:1.6}
    .header{background:linear-gradient(135deg,var(--navy),var(--navy-dark));padding:2rem 1rem 3rem;text-align:center;color:#fff}
    .header-icon{width:60px;height:60px;margin:0 auto .75rem;background:rgba(255,255,255,.15);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem}
    .header h1{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:600;margin-bottom:.5rem}
    .header p{font-size:.8rem;text-transform:uppercase;letter-spacing:.2em;opacity:.8}
    .container{max-width:800px;margin:-2rem auto 2rem;padding:0 1rem}
    .progress{display:flex;justify-content:center;align-items:center;gap:0;margin-bottom:1.5rem;padding:1.25rem;background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.08)}
    .progress-step{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.85rem;background:#fff;border:2px solid #d0d5dd;color:#d0d5dd;transition:.3s}
    .progress-step.active{background:var(--navy);border-color:var(--navy);color:#fff;transform:scale(1.1)}
    .progress-step.complete{background:var(--gold);border-color:var(--gold);color:#fff}
    .progress-line{width:30px;height:2px;background:#d0d5dd}
    .progress-line.complete{background:var(--gold)}
    .card{background:#fff;border-radius:12px;padding:1.75rem;margin-bottom:1rem;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .card-title{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:600;color:var(--navy);margin-bottom:.5rem}
    .card-subtitle{color:var(--text-light);font-size:.95rem;margin-bottom:1.25rem}
    label{display:block;font-size:.9rem;font-weight:600;color:var(--text);margin-bottom:.4rem}
    input,select,textarea{width:100%;padding:.75rem 1rem;border:1px solid var(--cream-dark);border-radius:8px;font-size:1rem;font-family:inherit;background:var(--cream)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--navy);box-shadow:0 0 0 3px rgba(30,58,95,.1)}
    .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem}
    .form-group{margin-bottom:1rem}
    .chip-group{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
    .chip{padding:.4rem .9rem;border-radius:20px;font-size:.85rem;cursor:pointer;border:1px solid var(--cream-dark);background:#fff;transition:.2s}
    .chip:hover{border-color:var(--navy)}
    .chip.selected{background:var(--navy);color:#fff;border-color:var(--navy)}
    .inspiration-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.75rem;margin-top:1rem}
    .inspiration-card{background:var(--cream);border:2px solid transparent;border-radius:10px;padding:1rem .75rem;text-align:center;cursor:pointer;transition:.2s}
    .inspiration-card:hover{border-color:var(--gold);transform:translateY(-2px)}
    .inspiration-card.selected{border-color:var(--navy);background:rgba(30,58,95,.05)}
    .inspiration-card .icon{font-size:1.8rem;margin-bottom:.5rem}
    .inspiration-card .title{font-weight:600;font-size:.85rem;color:var(--navy);margin-bottom:.25rem}
    .inspiration-card .desc{font-size:.75rem;color:var(--text-light)}
    .style-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.75rem;margin-top:1rem}
    .style-card{background:#fff;border:2px solid var(--cream-dark);border-radius:10px;padding:1rem;cursor:pointer;transition:.2s}
    .style-card:hover{border-color:var(--gold)}
    .style-card.selected{border-color:var(--navy);background:rgba(30,58,95,.03)}
    .style-card .name{font-weight:600;font-size:.9rem;color:var(--navy);margin-bottom:.25rem}
    .style-card .desc{font-size:.8rem;color:var(--text-light)}
    .cuisine-section{margin-top:1rem;padding:1rem;background:var(--cream);border-radius:8px}
    .cuisine-section h4{font-size:.85rem;color:var(--text-light);margin-bottom:.5rem;text-transform:uppercase;letter-spacing:.05em}
    .expert-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-top:1rem}
    .expert-card{background:#fff;border:2px solid var(--cream-dark);border-radius:12px;padding:1.25rem;cursor:pointer;transition:.2s;text-align:center}
    .expert-card:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.08)}
    .expert-card.selected{border-color:var(--navy);background:rgba(30,58,95,.03)}
    .expert-card .icon{font-size:2.5rem;margin-bottom:.75rem}
    .expert-card .name{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600;color:var(--navy);margin-bottom:.25rem}
    .expert-card .credentials{font-size:.8rem;color:var(--text-light);margin-bottom:.5rem}
    .expert-card .philosophy{font-size:.85rem;font-style:italic;color:var(--gold)}
    .chat-container{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.08)}
    .chat-header{background:var(--navy);color:#fff;padding:1rem 1.25rem;display:flex;align-items:center;gap:.75rem}
    .chat-header .icon{font-size:1.5rem}
    .chat-header .name{font-family:'Playfair Display',serif;font-weight:600}
    .chat-messages{height:350px;overflow-y:auto;padding:1rem;background:var(--cream)}
    .chat-message{margin-bottom:1rem;max-width:85%}
    .chat-message.user{margin-left:auto}
    .chat-message .bubble{padding:.75rem 1rem;border-radius:12px;line-height:1.5}
    .chat-message.assistant .bubble{background:#fff;border:1px solid var(--cream-dark)}
    .chat-message.user .bubble{background:var(--navy);color:#fff}
    .chat-input-area{display:flex;gap:.5rem;padding:1rem;border-top:1px solid var(--cream-dark);background:#fff}
    .chat-input-area input{flex:1}
    .menu-card{background:#fff;border:2px solid var(--cream-dark);border-radius:12px;padding:1.5rem;margin-bottom:1rem;cursor:pointer;transition:.2s;position:relative}
    .menu-card:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.08)}
    .menu-card.selected{border-color:var(--navy);background:linear-gradient(135deg,rgba(30,58,95,.03),rgba(201,162,39,.03))}
    .menu-card.selected::after{content:'‚úì';position:absolute;top:1rem;right:1rem;width:28px;height:28px;background:var(--navy);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem}
    .menu-card .title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:600;color:var(--navy);margin-bottom:.25rem}
    .menu-card .personality{font-size:.9rem;font-style:italic;color:var(--text-light);margin-bottom:.75rem}
    .menu-card .cost{font-size:.85rem;color:var(--gold);margin-bottom:.75rem}
    .menu-card .courses{border-top:1px solid var(--cream-dark);padding-top:.75rem}
    .menu-card .course{display:flex;padding:.4rem 0;font-size:.9rem}
    .menu-card .course-type{font-weight:600;color:var(--navy);width:110px;flex-shrink:0}
    .menu-card .course-name{flex:1}
    .menu-card .course-wine{font-size:.8rem;color:var(--gold);margin-left:.5rem}
    .staffing-option{display:flex;align-items:center;gap:1rem;padding:1rem;border:2px solid var(--cream-dark);border-radius:10px;cursor:pointer;margin-bottom:.75rem;transition:.2s}
    .staffing-option:hover{border-color:var(--gold)}
    .staffing-option.selected{border-color:var(--navy);background:rgba(30,58,95,.03)}
    .staffing-option .icon{font-size:2rem}
    .staffing-option .info h4{font-weight:600;color:var(--navy);margin-bottom:.2rem}
    .staffing-option .info p{font-size:.85rem;color:var(--text-light)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.85rem 1.75rem;border:none;border-radius:8px;font-size:1rem;font-weight:600;font-family:inherit;cursor:pointer;transition:.2s}
    .btn-primary{background:linear-gradient(135deg,var(--navy),var(--navy-dark));color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(30,58,95,.3)}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-secondary{background:#fff;color:var(--navy);border:2px solid var(--navy)}
    .btn-secondary:hover{background:var(--cream)}
    .btn-gold{background:linear-gradient(135deg,var(--gold),#d4b84a);color:#fff}
    .btn-gold:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(201,162,39,.3)}
    .btn-outline{background:transparent;color:var(--text-light);border:1px solid var(--cream-dark)}
    .btn-outline:hover{border-color:var(--navy);color:var(--navy)}
    .actions{display:flex;gap:.75rem;justify-content:center;margin-top:1.5rem;flex-wrap:wrap}
    .loading{text-align:center;padding:3rem}
    .spinner{width:45px;height:45px;border:4px solid var(--cream-dark);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading p{color:var(--text-light);font-size:1.05rem}
    .success-msg{background:#f0fdf4;border:1px solid #bbf7d0;color:#166534;padding:1rem;border-radius:8px;margin:1rem 0}
    .error-msg{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:1rem;border-radius:8px;margin:1rem 0}
    .section-title{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:600;color:var(--navy);text-align:center;margin:1.5rem 0}
    .print-section{background:var(--cream);border-radius:8px;padding:1.25rem;margin-top:1rem}
    .print-section h4{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--navy);margin-bottom:.75rem}
    .avery-product{display:flex;justify-content:space-between;align-items:center;padding:.75rem;background:#fff;border-radius:6px;margin-bottom:.5rem}
    .avery-product .info{flex:1}
    .avery-product .sku{font-weight:600;color:var(--navy)}
    .avery-product .details{font-size:.85rem;color:var(--text-light)}
    .avery-product .btn{padding:.5rem 1rem;font-size:.85rem}
    .cookbook-preview{background:var(--cream);border-radius:8px;padding:1.25rem;margin:1rem 0}
    .cookbook-preview h4{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--navy);margin-bottom:1rem}
    .cookbook-sections{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.5rem}
    .cookbook-section{display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;background:#fff;border-radius:6px;font-size:.85rem}
    .cookbook-section::before{content:'‚úì';color:#059669;font-weight:bold}
    footer{text-align:center;padding:2rem 1rem;color:var(--text-light);font-size:.85rem;border-top:1px solid var(--cream-dark);margin-top:2rem}
    .hidden{display:none!important}
    @media(max-width:600px){.header h1{font-size:1.8rem}.card{padding:1.25rem}.form-row{grid-template-columns:1fr}.inspiration-grid{grid-template-columns:repeat(2,1fr)}.expert-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-icon">üçΩÔ∏è</div>
    <h1>Dinner Party Planner</h1>
    <p>Create Unforgettable Experiences</p>
  </header>
  <div class="container">
    <div class="progress">
      <div class="progress-step active" id="dot1">1</div><div class="progress-line" id="line1"></div>
      <div class="progress-step" id="dot2">2</div><div class="progress-line" id="line2"></div>
      <div class="progress-step" id="dot3">3</div><div class="progress-line" id="line3"></div>
      <div class="progress-step" id="dot4">4</div><div class="progress-line" id="line4"></div>
      <div class="progress-step" id="dot5">5</div><div class="progress-line" id="line5"></div>
      <div class="progress-step" id="dot6">6</div><div class="progress-line" id="line6"></div>
      <div class="progress-step" id="dot7">7</div>
    </div>
    <section id="step1">
      <div class="card">
        <h2 class="card-title">Welcome, Host</h2>
        <p class="card-subtitle">Enter your access code to begin planning your dinner party.</p>
        <div class="form-group"><label for="accessCode">Access Code</label><input type="text" id="accessCode" placeholder="Enter your beta access code" autocomplete="off"></div>
        <div id="codeMessage"></div>
        <div class="actions"><button class="btn btn-primary" onclick="validateCode()">Continue</button></div>
      </div>
    </section>
    <section id="step2" class="hidden">
      <div class="card">
        <h2 class="card-title">Event Details</h2>
        <p class="card-subtitle">Tell us about your dinner party.</p>
        <div class="form-row">
          <div class="form-group"><label for="eventTitle">Event Name</label><input type="text" id="eventTitle" placeholder="e.g., Anniversary Dinner"></div>
          <div class="form-group"><label for="eventDate">Date</label><input type="date" id="eventDate"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="guestCount">Guests</label><select id="guestCount"><option value="2">2</option><option value="4">4</option><option value="6" selected>6</option><option value="8">8</option><option value="10">10</option><option value="12">12</option></select></div>
          <div class="form-group"><label for="serviceTime">Service Time</label><select id="serviceTime"><option>6:00 PM</option><option>6:30 PM</option><option selected>7:00 PM</option><option>7:30 PM</option><option>8:00 PM</option></select></div>
        </div>
        <div class="form-group"><label for="guestList">Guest Names (for place cards)</label><textarea id="guestList" rows="3" placeholder="Enter guest names, one per line"></textarea></div>
        <h3 class="card-title" style="margin-top:1.5rem;font-size:1.1rem">Menu Card Style</h3>
        <div class="style-grid" id="styleGrid"></div>
        <div class="actions"><button class="btn btn-secondary" onclick="goToStep(1)">Back</button><button class="btn btn-primary" onclick="goToStep(3)">Continue</button></div>
      </div>
    </section>
    <section id="step3" class="hidden">
      <div class="card">
        <h2 class="card-title">Menu Inspiration</h2>
        <p class="card-subtitle">What kind of dining experience are you creating?</p>
        <div class="inspiration-grid" id="inspirationGrid"></div>
      </div>
      <div class="card">
        <h2 class="card-title">Budget & Skill</h2>
        <div class="form-row">
          <div class="form-group"><label for="foodBudget">Food Budget (per person)</label><select id="foodBudget"><option>$30-45 (Casual)</option><option selected>$45-60 (Elegant)</option><option>$60-80 (Upscale)</option><option>$80-100 (Premium)</option><option>$100+ (Luxe)</option></select></div>
          <div class="form-group"><label for="wineBudget">Wine Budget (total)</label><select id="wineBudget"><option>$50-80</option><option selected>$80-120</option><option>$120-180</option><option>$180-250</option><option>$250+</option></select></div>
        </div>
        <div class="form-group"><label for="skillLevel">Cooking Skill</label><select id="skillLevel"><option value="beginner">Beginner</option><option value="intermediate" selected>Intermediate</option><option value="advanced">Advanced</option></select></div>
      </div>
      <div class="card">
        <h2 class="card-title">Taste Preferences</h2>
        <div class="form-group"><label>Cuisine Direction</label><div class="chip-group" id="cuisineChips"></div><div id="cuisineSubOptions" class="cuisine-section hidden"></div></div>
        <div class="form-group"><label>Favorites</label><div class="chip-group" id="likesChips"></div></div>
        <div class="form-group"><label>Avoid</label><div class="chip-group" id="dislikesChips"></div></div>
        <div class="form-group"><label>Dietary Restrictions</label><div class="chip-group" id="restrictionsChips"></div></div>
        <div class="actions"><button class="btn btn-secondary" onclick="goToStep(2)">Back</button><button class="btn btn-primary" onclick="goToStep(4)">Continue</button></div>
      </div>
    </section>
    <section id="step4" class="hidden">
      <div class="card">
        <h2 class="card-title">Expert Consultation</h2>
        <p class="card-subtitle">Would you like to consult with our experts before we design your menu?</p>
        <div class="expert-grid" id="expertGrid"></div>
        <div class="actions"><button class="btn btn-secondary" onclick="goToStep(3)">Back</button><button class="btn btn-outline" onclick="skipConsultation()">Skip to Menus</button></div>
      </div>
      <div id="chatSection" class="hidden">
        <div class="chat-container">
          <div class="chat-header"><span class="icon" id="chatIcon">üë®‚Äçüç≥</span><span class="name" id="chatName">The Chef</span></div>
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-area"><input type="text" id="chatInput" placeholder="Ask a question..." onkeypress="if(event.key==='Enter')sendChat()"><button class="btn btn-primary" onclick="sendChat()">Send</button></div>
        </div>
        <div class="actions" style="margin-top:1rem"><button class="btn btn-secondary" onclick="endChat()">End Consultation</button><button class="btn btn-gold" onclick="proceedToMenus()">Generate Menus</button></div>
      </div>
    </section>
    <section id="step5" class="hidden">
      <h2 class="section-title">Choose Your Menu</h2>
      <div id="menuLoading" class="loading hidden"><div class="spinner"></div><p>Crafting your personalized menus...</p></div>
      <div id="menuList"></div>
      <div id="menuActions" class="actions hidden"><button class="btn btn-secondary" onclick="goToStep(4)">Back</button><button class="btn btn-outline" onclick="rejectMenus()">None of These</button><button class="btn btn-primary" id="selectMenuBtn" onclick="selectMenu()" disabled>Select This Menu</button></div>
      <div id="rejectionChat" class="hidden">
        <div class="card">
          <h3 class="card-title">Let's Find Your Perfect Menu</h3>
          <p class="card-subtitle">Help me understand what you're looking for...</p>
          <div class="chat-container" style="margin-top:1rem">
            <div class="chat-header"><span class="icon">üë®‚Äçüç≥</span><span class="name">The Chef</span></div>
            <div class="chat-messages" id="rejectionMessages"></div>
            <div class="chat-input-area"><input type="text" id="rejectionInput" placeholder="Tell me your vision..." onkeypress="if(event.key==='Enter')sendRejection()"><button class="btn btn-primary" onclick="sendRejection()">Send</button></div>
          </div>
          <div class="actions" style="margin-top:1rem"><button class="btn btn-gold" onclick="regenerateMenus()">Generate New Menus</button></div>
        </div>
      </div>
    </section>
    <section id="step6" class="hidden">
      <div class="card">
        <h2 class="card-title">Kitchen Staffing</h2>
        <p class="card-subtitle">How will you staff your kitchen? This affects your prep timeline.</p>
        <div id="staffingOptions"></div>
      </div>
      <div class="card"><h3 class="card-title">Selected Menu</h3><div id="selectedMenuSummary"></div></div>
      <div class="actions"><button class="btn btn-secondary" onclick="goToStep(5)">Back</button><button class="btn btn-gold" onclick="generateCookbook()">Generate Complete Cookbook</button></div>
    </section>
    <section id="step7" class="hidden">
      <div id="cookbookLoading" class="loading hidden"><div class="spinner"></div><p>Creating your complete cookbook...</p></div>
      <div id="cookbookComplete" class="hidden">
        <div class="card" style="text-align:center">
          <h2 class="card-title">üéâ Your Cookbook is Ready!</h2>
          <p class="card-subtitle">Your complete dinner party cookbook has been generated.</p>
          <div class="cookbook-preview"><h4>Cookbook Includes:</h4><div class="cookbook-sections"><div class="cookbook-section">Cover Page</div><div class="cookbook-section">Menu Overview</div><div class="cookbook-section">5 Recipes</div><div class="cookbook-section">Wine Pairings</div><div class="cookbook-section">Shopping List</div><div class="cookbook-section">Day-Before Prep</div><div class="cookbook-section">Day-Of Timeline</div><div class="cookbook-section">Plating Guides</div><div class="cookbook-section">Table Setting</div><div class="cookbook-section">Ambiance Guide</div><div class="cookbook-section">Final Checklist</div></div></div>
          <div class="actions"><button class="btn btn-gold" onclick="downloadCookbook()">Download DOCX Cookbook</button></div>
        </div>
        <div class="card">
          <h2 class="card-title">Print Products</h2>
          <p class="card-subtitle">Download print-ready files for Avery paper products.</p>
          <div class="print-section"><h4>üìç Place Cards</h4><div id="placeCardProducts"></div></div>
          <div class="print-section"><h4>üìã Menu Cards</h4><div id="menuCardProducts"></div></div>
          <div class="print-section"><h4>üíå Invitations</h4><div id="invitationProducts"></div></div>
        </div>
        <div class="actions"><button class="btn btn-secondary" onclick="startOver()">Plan Another Party</button></div>
      </div>
    </section>
    <footer><p>Dinner Party Planner ¬© 2025 ‚Äî Thames Club</p><p style="font-size:.75rem;margin-top:.25rem">AI-assisted planning</p></footer>
  </div>
  <script>
    let DATA={},currentStep=1,accessCode='',selectedStyle='classic',selectedInspiration='chefs-tasting',selectedCuisine=null,selectedSubCuisine=null,likes=[],dislikes=[],restrictions=[],selectedExpert=null,chatHistory=[],menus=[],selectedMenu=null,selectedStaffing='solo',rejectionHistory=[],cookbookId=null;
    const PERSONAS={chef:{name:'The Chef',icon:'üë®‚Äçüç≥',credentials:'James Beard Award winner',philosophy:'"The ingredient should be the star."'},sommelier:{name:'The Sommelier',icon:'üç∑',credentials:'Master Sommelier',philosophy:'"Wine should match the moment."'},instructor:{name:'The Instructor',icon:'üìö',credentials:'CIA Hyde Park',philosophy:'"If you\'re calm, your guests are calm."'},all:{name:'The Team',icon:'üë®‚Äçüç≥üç∑üìö',credentials:'All three experts',philosophy:'Collaborative expertise.'}};
    
    async function init(){
      try{const r=await fetch('/api/data');DATA=await r.json();}catch(e){console.error('Failed to load data');}
      initStyleGrid();initInspirationGrid();initCuisineChips();initPreferenceChips();initExpertGrid();initStaffingOptions();initAveryProducts();
      const d=new Date();d.setDate(d.getDate()+14);document.getElementById('eventDate').value=d.toISOString().split('T')[0];
      document.getElementById('accessCode').addEventListener('keypress',e=>{if(e.key==='Enter')validateCode();});
    }
    document.addEventListener('DOMContentLoaded',init);
    
    function initStyleGrid(){const g=document.getElementById('styleGrid');if(!DATA.MENU_STYLES)return;g.innerHTML=DATA.MENU_STYLES.map(s=>'<div class="style-card '+(selectedStyle===s.id?'selected':'')+'" onclick="selectStyle(\''+s.id+'\')"><div class="name">'+s.name+'</div><div class="desc">'+s.desc+'</div></div>').join('');}
    function initInspirationGrid(){const g=document.getElementById('inspirationGrid');if(!DATA.MENU_INSPIRATIONS)return;g.innerHTML=DATA.MENU_INSPIRATIONS.map(i=>'<div class="inspiration-card '+(selectedInspiration===i.id?'selected':'')+'" onclick="selectInspiration(\''+i.id+'\')"><div class="icon">'+i.icon+'</div><div class="title">'+i.title+'</div><div class="desc">'+i.desc+'</div></div>').join('');}
    function initCuisineChips(){const c=document.getElementById('cuisineChips');if(!DATA.CUISINES)return;c.innerHTML=Object.entries(DATA.CUISINES).map(([k,v])=>'<span class="chip '+(selectedCuisine===k?'selected':'')+'" onclick="selectCuisine(\''+k+'\')">'+v.label+'</span>').join('');}
    function initPreferenceChips(){const ls=['Beef','Lamb','Pork','Seafood','Poultry','Pasta','Rich Sauces','Mushrooms','Cheese','Chocolate'];const ds=['Shellfish','Raw Fish','Organ Meats','Blue Cheese','Spicy','Olives','Cilantro'];const rs=['Gluten-Free','Dairy-Free','Nut Allergy','Vegetarian','Pescatarian','Kosher'];document.getElementById('likesChips').innerHTML=ls.map(o=>'<span class="chip" onclick="toggleChip(this,\'likes\',\''+o+'\')">'+o+'</span>').join('');document.getElementById('dislikesChips').innerHTML=ds.map(o=>'<span class="chip" onclick="toggleChip(this,\'dislikes\',\''+o+'\')">'+o+'</span>').join('');document.getElementById('restrictionsChips').innerHTML=rs.map(o=>'<span class="chip" onclick="toggleChip(this,\'restrictions\',\''+o+'\')">'+o+'</span>').join('');}
    function initExpertGrid(){const g=document.getElementById('expertGrid');g.innerHTML=Object.entries(PERSONAS).map(([k,p])=>'<div class="expert-card" onclick="selectExpert(\''+k+'\')"><div class="icon">'+p.icon+'</div><div class="name">'+p.name+'</div><div class="credentials">'+p.credentials+'</div><div class="philosophy">'+p.philosophy+'</div></div>').join('');}
    function initStaffingOptions(){const c=document.getElementById('staffingOptions');if(!DATA.STAFFING)return;c.innerHTML=DATA.STAFFING.map(s=>'<div class="staffing-option '+(selectedStaffing===s.id?'selected':'')+'" onclick="selectStaffingOption(\''+s.id+'\')"><span class="icon">'+s.icon+'</span><div class="info"><h4>'+s.name+'</h4><p>'+s.desc+'</p></div></div>').join('');}
    function initAveryProducts(){if(!DATA.AVERY_PRODUCTS)return;document.getElementById('placeCardProducts').innerHTML=DATA.AVERY_PRODUCTS.placeCards.map(p=>'<div class="avery-product"><div class="info"><div class="sku">Avery '+p.sku+' - '+p.name+'</div><div class="details">'+p.size+' ‚Ä¢ '+p.perSheet+'/sheet</div></div><button class="btn btn-outline" onclick="alert(\'Coming soon!\')">Download PDF</button></div>').join('');document.getElementById('menuCardProducts').innerHTML=DATA.AVERY_PRODUCTS.menuCards.map(p=>'<div class="avery-product"><div class="info"><div class="sku">Avery '+p.sku+' - '+p.name+'</div><div class="details">'+p.size+'</div></div><button class="btn btn-outline" onclick="alert(\'Coming soon!\')">Download PDF</button></div>').join('');document.getElementById('invitationProducts').innerHTML=DATA.AVERY_PRODUCTS.invitations.map(p=>'<div class="avery-product"><div class="info"><div class="sku">Avery '+p.sku+' - '+p.name+'</div><div class="details">'+p.size+'</div></div><button class="btn btn-outline" onclick="alert(\'Coming soon!\')">Download PDF</button></div>').join('');}
    
    function goToStep(s){for(let i=1;i<=7;i++)document.getElementById('step'+i).classList.add('hidden');document.getElementById('step'+s).classList.remove('hidden');currentStep=s;for(let i=1;i<=7;i++){const d=document.getElementById('dot'+i),l=document.getElementById('line'+i);d.classList.remove('active','complete');if(l)l.classList.remove('complete');if(i<s){d.classList.add('complete');if(l)l.classList.add('complete');}else if(i===s)d.classList.add('active');}window.scrollTo({top:0,behavior:'smooth'});}
    
    async function validateCode(){const c=document.getElementById('accessCode').value.trim(),m=document.getElementById('codeMessage');if(!c){m.innerHTML='<div class="error-msg">Please enter an access code.</div>';return;}try{const r=await fetch('/api/validate-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:c})});const d=await r.json();if(d.valid){accessCode=c;m.innerHTML='<div class="success-msg">‚úì Access granted!</div>';setTimeout(()=>goToStep(2),600);}else{m.innerHTML='<div class="error-msg">'+(d.message||'Invalid code.')+'</div>';}}catch(e){m.innerHTML='<div class="error-msg">Connection error.</div>';}}
    
    function selectStyle(id){selectedStyle=id;initStyleGrid();}
    function selectInspiration(id){selectedInspiration=id;initInspirationGrid();}
    function selectCuisine(k){selectedCuisine=selectedCuisine===k?null:k;selectedSubCuisine=null;initCuisineChips();updateCuisineSubOptions();}
    function updateCuisineSubOptions(){const c=document.getElementById('cuisineSubOptions');if(!selectedCuisine||!DATA.CUISINES){c.classList.add('hidden');return;}const cuisine=DATA.CUISINES[selectedCuisine];let h='';if(cuisine.regions){h+='<h4>Regions</h4><div class="chip-group">'+cuisine.regions.map(r=>'<span class="chip '+(selectedSubCuisine===r?'selected':'')+'" onclick="selectSubCuisine(\''+r+'\')">'+r+'</span>').join('')+'</div>';}if(cuisine.styles){h+='<h4 style="margin-top:.75rem">Styles</h4><div class="chip-group">'+cuisine.styles.map(s=>'<span class="chip '+(selectedSubCuisine===s?'selected':'')+'" onclick="selectSubCuisine(\''+s+'\')">'+s+'</span>').join('')+'</div>';}if(cuisine.countries){h+='<h4>Countries</h4><div class="chip-group">'+Object.entries(cuisine.countries).map(([k,v])=>'<span class="chip '+(selectedSubCuisine===v.label?'selected':'')+'" onclick="selectSubCuisine(\''+v.label+'\')">'+v.label+'</span>').join('')+'</div>';}c.innerHTML=h;c.classList.remove('hidden');}
    function selectSubCuisine(v){selectedSubCuisine=v;updateCuisineSubOptions();}
    function toggleChip(el,cat,val){el.classList.toggle('selected');const arr=cat==='likes'?likes:cat==='dislikes'?dislikes:restrictions;const i=arr.indexOf(val);if(i>-1)arr.splice(i,1);else arr.push(val);}
    
    function selectExpert(k){selectedExpert=k;const p=PERSONAS[k];document.querySelectorAll('.expert-card').forEach((c,i)=>c.classList.toggle('selected',Object.keys(PERSONAS)[i]===k));document.getElementById('chatSection').classList.remove('hidden');document.getElementById('chatIcon').textContent=p.icon;document.getElementById('chatName').textContent=p.name;chatHistory=[{role:'assistant',content:getGreeting(k)}];renderChat();}
    function getGreeting(k){const t=document.getElementById('eventTitle').value||'your dinner party',g=document.getElementById('guestCount').value;if(k==='chef')return'Welcome! I\'m excited to help plan '+t+' for '+g+' guests. What story do you want your menu to tell?';if(k==='sommelier')return'Wonderful! Planning wines for '+t+' will be a pleasure. Are your guests adventurous or prefer classics?';if(k==='instructor')return'Hello! I\'ll ensure '+t+' runs smoothly. What\'s your biggest concern about execution?';return'Welcome! The three of us are here to help plan '+t+'.\n\nChef: Let\'s discuss your menu vision.\nSommelier: I\'ll ensure perfect pairings.\nInstructor: And flawless execution.\n\nWhat would you like to discuss?';}
    function renderChat(){const c=document.getElementById('chatMessages');c.innerHTML=chatHistory.map(m=>'<div class="chat-message '+m.role+'"><div class="bubble">'+m.content.replace(/\n/g,'<br>')+'</div></div>').join('');c.scrollTop=c.scrollHeight;}
    async function sendChat(){const i=document.getElementById('chatInput'),m=i.value.trim();if(!m)return;chatHistory.push({role:'user',content:m});i.value='';renderChat();chatHistory.push({role:'assistant',content:'...'});renderChat();try{const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({persona:selectedExpert,messages:chatHistory.slice(0,-1),context:getContext()})});const d=await r.json();chatHistory[chatHistory.length-1]={role:'assistant',content:d.response||'Please try again.'};renderChat();}catch(e){chatHistory[chatHistory.length-1]={role:'assistant',content:'Connection error.'};renderChat();}}
    function getContext(){return{eventTitle:document.getElementById('eventTitle').value,eventDate:document.getElementById('eventDate').value,guestCount:document.getElementById('guestCount').value,serviceTime:document.getElementById('serviceTime').value,foodBudget:document.getElementById('foodBudget').value,wineBudget:document.getElementById('wineBudget').value,skillLevel:document.getElementById('skillLevel').value,inspiration:selectedInspiration,cuisine:selectedCuisine,subCuisine:selectedSubCuisine,likes,dislikes,restrictions};}
    function endChat(){document.getElementById('chatSection').classList.add('hidden');selectedExpert=null;document.querySelectorAll('.expert-card').forEach(c=>c.classList.remove('selected'));}
    function skipConsultation(){proceedToMenus();}
    async function proceedToMenus(){goToStep(5);await generateMenus();}
    
    async function generateMenus(){document.getElementById('menuLoading').classList.remove('hidden');document.getElementById('menuList').innerHTML='';document.getElementById('menuActions').classList.add('hidden');document.getElementById('rejectionChat').classList.add('hidden');try{const r=await fetch('/api/generate-menus',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:accessCode,context:getContext(),chatHistory,rejectionHistory})});const d=await r.json();document.getElementById('menuLoading').classList.add('hidden');if(d.menus&&d.menus.length){menus=d.menus;renderMenus();document.getElementById('menuActions').classList.remove('hidden');}else{document.getElementById('menuList').innerHTML='<div class="error-msg">Unable to generate menus.</div>';}}catch(e){document.getElementById('menuLoading').classList.add('hidden');document.getElementById('menuList').innerHTML='<div class="error-msg">Connection error.</div>';}}
    function renderMenus(){const c=document.getElementById('menuList');c.innerHTML=menus.map((m,i)=>'<div class="menu-card '+(selectedMenu===i?'selected':'')+'" onclick="highlightMenu('+i+')"><div class="title">'+m.title+'</div><div class="personality">'+m.personality+'</div><div class="cost">Food: '+m.foodCost+' ‚Ä¢ Wine: '+m.wineCost+'</div><div class="courses">'+m.courses.map(c=>'<div class="course"><span class="course-type">'+c.type+':</span><span class="course-name">'+c.name+'</span>'+(c.wine?'<span class="course-wine">üç∑ '+c.wine+'</span>':'')+'</div>').join('')+'</div></div>').join('');}
    function highlightMenu(i){selectedMenu=i;renderMenus();document.getElementById('selectMenuBtn').disabled=false;}
    function selectMenu(){if(selectedMenu===null)return;const m=menus[selectedMenu];document.getElementById('selectedMenuSummary').innerHTML='<div style="font-family:Playfair Display,serif;font-size:1.2rem;color:var(--navy);margin-bottom:.5rem">'+m.title+'</div><div style="font-style:italic;color:var(--text-light);margin-bottom:.75rem">'+m.personality+'</div>'+m.courses.map(c=>'<div style="padding:.3rem 0;font-size:.9rem"><strong>'+c.type+':</strong> '+c.name+'</div>').join('');goToStep(6);}
    function rejectMenus(){document.getElementById('menuActions').classList.add('hidden');document.getElementById('rejectionChat').classList.remove('hidden');rejectionHistory=[{role:'assistant',content:'I sense none of these hit the mark. What did you imagine when you first thought about this dinner? Was there a dish or moment you were hoping to create?'}];renderRejectionChat();}
    function renderRejectionChat(){const c=document.getElementById('rejectionMessages');c.innerHTML=rejectionHistory.map(m=>'<div class="chat-message '+m.role+'"><div class="bubble">'+m.content.replace(/\n/g,'<br>')+'</div></div>').join('');c.scrollTop=c.scrollHeight;}
    async function sendRejection(){const i=document.getElementById('rejectionInput'),m=i.value.trim();if(!m)return;rejectionHistory.push({role:'user',content:m});i.value='';renderRejectionChat();rejectionHistory.push({role:'assistant',content:'...'});renderRejectionChat();try{const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({persona:'chef',messages:rejectionHistory.slice(0,-1),context:getContext()})});const d=await r.json();rejectionHistory[rejectionHistory.length-1]={role:'assistant',content:d.response||'Tell me more...'};renderRejectionChat();}catch(e){rejectionHistory[rejectionHistory.length-1]={role:'assistant',content:'Tell me more about your vision.'};renderRejectionChat();}}
    async function regenerateMenus(){document.getElementById('rejectionChat').classList.add('hidden');await generateMenus();}
    
    function selectStaffingOption(id){selectedStaffing=id;initStaffingOptions();}
    
    async function generateCookbook(){goToStep(7);document.getElementById('cookbookLoading').classList.remove('hidden');document.getElementById('cookbookComplete').classList.add('hidden');try{const r=await fetch('/api/generate-cookbook',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:accessCode,menu:menus[selectedMenu],context:getContext(),staffing:selectedStaffing,chatHistory})});const d=await r.json();document.getElementById('cookbookLoading').classList.add('hidden');if(d.success){cookbookId=d.cookbookId;document.getElementById('cookbookComplete').classList.remove('hidden');}else{document.getElementById('cookbookComplete').innerHTML='<div class="error-msg">Error generating cookbook.</div>';document.getElementById('cookbookComplete').classList.remove('hidden');}}catch(e){document.getElementById('cookbookLoading').classList.add('hidden');document.getElementById('cookbookComplete').innerHTML='<div class="error-msg">Connection error.</div>';document.getElementById('cookbookComplete').classList.remove('hidden');}}
    async function downloadCookbook(){try{const r=await fetch('/api/download-cookbook',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:accessCode,cookbookId})});if(r.ok){const b=await r.blob(),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=(document.getElementById('eventTitle').value||'Dinner_Party')+'_Cookbook.docx';a.click();URL.revokeObjectURL(u);}else{alert('Error downloading cookbook.');}}catch(e){alert('Connection error.');}}
    function startOver(){selectedMenu=null;menus=[];chatHistory=[];rejectionHistory=[];cookbookId=null;goToStep(2);}
  </script>
</body>
</html>
